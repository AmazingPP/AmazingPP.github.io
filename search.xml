<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>è®©Taskæ”¯æŒå¸¦è¶…æ—¶çš„éé˜»å¡å¼‚æ­¥ç­‰å¾…</title>
    <url>/2019/05/12/async-wait-task-with-timeout/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>å¤§å®¶éƒ½çŸ¥é“Taskè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚å¦‚æœæˆ‘ä»¬æƒ³ç­‰å¾…ä¸€ä¸ªTaskå®Œæˆï¼Œæœ‰å¾ˆå¤šè‡ªå¸¦çš„å®ä¾‹ã€é™æ€æ–¹æ³•ä¾›æˆ‘ä»¬é€‰æ‹©ã€‚æœ‰çš„é˜»å¡ï¼Œæœ‰çš„ä¸é˜»å¡ã€‚ä¸è¿‡å¸¦è¶…æ—¶çš„ç­‰å¾…åªæœ‰ä¸€ä¸ªï¼Œè€Œä¸”å®ƒæ˜¯å µå¡çš„ã€‚</p>
<p>è¿™æ¬¡ç»™å¤§å®¶å†™ä¸ªéé˜»å¡çš„å¸¦è¶…æ—¶çš„ç­‰å¾…æ–¹æ³•~ <a id="more"></a> # Taskå·²æœ‰çš„ç­‰å¾…æ–¹æ³•</p>
<p>Taskå®ä¾‹å·²æœ‰çš„ç­‰å¾…æ–¹æ³•å°±æ˜¯<code>Wait</code>ï¼š <img data-src="/2019/05/12/async-wait-task-with-timeout/instance-methods.png" class=""> â–² äº”ä¸ªé‡è½½ï¼Œä¸€ä¸ªæ— é™ç­‰å¾…ï¼Œä¸€ä¸ªæ”¯æŒå–æ¶ˆï¼Œä¸¤ä¸ªæ”¯æŒè¶…æ—¶ï¼ˆæ¯«ç§’å’Œ<code>TimeSpan</code>ï¼‰ï¼Œä¸€ä¸ªæ—¢æ”¯æŒå–æ¶ˆä¹Ÿæ”¯æŒè¶…æ—¶</p>
<p>ä½†Taskå®ä¾‹çš„ç­‰å¾…æ–¹æ³•çš„æ‰€æœ‰é‡è½½éƒ½æœ‰ä¸€ä¸ªå¼Šç«¯ï¼Œé‚£å°±æ˜¯<strong>é˜»å¡</strong>ã€‚å¦‚æœçœŸçš„ç”¨è¿™ä¸ªæ–¹æ³•æ¥ç­‰å¾…è¿™ä¸ªTaskï¼Œé‚£ä¹ˆä¸€å®šä¼šå µå¡ä¸€ä¸ªçº¿ç¨‹ã€‚æ‰€ä»¥é€šå¸¸ä¸å»ºè®®è¿™æ ·ç›´æ¥ç­‰å¾…ã€‚</p>
<p>å¦å¤–ï¼ŒTaskè¿˜æä¾›äº†é™æ€çš„ç­‰å¾…æ–¹æ³•ï¼š <img data-src="/2019/05/12/async-wait-task-with-timeout/static-methods.png" class=""> â–² Taské™æ€çš„ç­‰å¾…æ–¹æ³•</p>
<p><code>Task.WaitAll</code>å’Œ<code>Task.WaitAny</code>çš„åŠŸèƒ½åŸºæœ¬å’ŒTaskå®ä¾‹çš„<code>Wait</code>æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å¯ä»¥ç­‰å¾…å¤šä¸ªTaskçš„å®ä¾‹ç½¢äº†ã€‚</p>
<p>è€Œ<code>Task.WhenAll</code>å’Œ<code>WhenAny</code>æ‰æ˜¯<strong>ä¸é˜»å¡</strong>çº¿ç¨‹çš„å¼‚æ­¥ç­‰å¾…ã€‚</p>
<p>å¯æ˜¯ï¼å¯ä»¥çœ‹ä¸Šå›¾ï¼Œåªæœ‰<code>Task.Wait</code>ç³»åˆ—çš„é‡è½½æ‰æœ‰timoutå‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¶…æ—¶åŠŸèƒ½ï¼Œè€Œ<code>Task.When</code>ç³»åˆ—åˆ™æ²¡æœ‰ã€‚</p>
<p>è¿™ä¹Ÿå°±æ˜¯æœ¬æ–‡è¦è®¨è®ºå’Œè§£å†³çš„é—®é¢˜ã€‚å¦‚ä½•è®©ä¸€ä¸ªTaskçš„ç­‰å¾…æ—¢å¯ä»¥æœ‰è¶…æ—¶åŠŸèƒ½ï¼Œåˆæ˜¯å¼‚æ­¥çš„ä¸å µå¡çº¿ç¨‹å‘¢ï¼Ÿ</p>
<h1 id="å¸¦è¶…æ—¶çš„å¼‚æ­¥éé˜»å¡ç­‰å¾…æ–¹æ³•çš„å®ç°">å¸¦è¶…æ—¶çš„å¼‚æ­¥éé˜»å¡ç­‰å¾…æ–¹æ³•çš„å®ç°</h1>
<p>Taskæœ‰ä¸€ä¸ª<code>Task.Delay</code>é™æ€æ–¹æ³•ï¼Œå®ƒæ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ªåœ¨æŒ‡å®šæ—¶é—´å»¶è¿Ÿåå®Œæˆçš„ä»»åŠ¡ï¼Œç±»ä¼¼äºä¸€ä¸ªå¼‚æ­¥çš„<code>Thread.Sleep</code>ã€‚è€Œæˆ‘ä»¬å°±å¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥é—´æ¥å®ç°å¼‚æ­¥éé˜»å¡çš„ç­‰å¾…ã€‚</p>
<p><code>Task.WhenAny</code>å¯ä»¥å¼‚æ­¥çš„ç­‰å¾…å¤šä¸ªä»»åŠ¡ä¸­ä»»æ„ä¸€ä¸ªä»»åŠ¡çš„å®Œæˆã€‚è¿™æ ·å°±å¯ä»¥å’Œ<code>Task.Delay</code>åšä¸€ä¸ªç»“åˆã€‚æ€è·¯å°±æ˜¯è¦ä¹ˆæ˜¯çœŸæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å…ˆå®Œæˆï¼Œè¦ä¹ˆå°±æ˜¯è¶…æ—¶å…ˆå®Œæˆã€‚äºæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨<code>Task.Delay</code>æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„Taskï¼Œæ¥æ¯”è¾ƒä¸¤ä¸ªTaskçš„æ‰§è¡Œå…ˆåï¼š</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">WaitAsync</span>&lt;<span class="title">TResult</span>&gt;(<span class="params">Task&lt;TResult&gt; task, TimeSpan timeout</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">await</span> Task.WhenAny(task, Task.Delay(timeout)) == task)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> task;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(<span class="string">&quot;The operation has timed out.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†è¿™ä¸ªæ‰©å±•å°è£…è¿˜ä¸å¤Ÿå¥½ï¼Œå¦‚æœæˆ‘ä»¬çš„ä»»åŠ¡æ—©å·²å®Œæˆï¼Œä½†timeoutè®¾ç½®çš„è¿‡é•¿ï¼Œé‚£ä¹ˆ<code>Task.Delay</code>åˆ›å»ºçš„å»¶æ—¶ä»»åŠ¡ä¼šä¸€ç›´ç­‰åˆ°timeoutè®¾ç½®çš„æ—¶é—´ç»“æŸåæ‰ç»“æŸï¼Œä¼šä¸€ç›´å¸¸é©»åå°ï¼Œå ç”¨èµ„æºã€‚</p>
<p>è¿˜å¥½å»¶æ—¶ä»»åŠ¡å¯ä»¥è¢«å–æ¶ˆï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨CancellationTokenSourceï¼ŒæŠŠæ— ç”¨çš„å»¶æ—¶ä»»åŠ¡ç»™é‡Šæ”¾æ‰ã€‚</p>
<p>ç„¶åå°±æœ‰äº†ä»¥ä¸‹å®Œæ•´çš„å°è£…ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">AmazingPP</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TaskWaitingExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">WaitAsync</span>(<span class="params"><span class="keyword">this</span> Task task,TimeSpan timeout</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> timeoutCancellationTokenSource = <span class="keyword">new</span> CancellationTokenSource())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> delayTask = Task.Delay(timeout, timeoutCancellationTokenSource.Token);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">await</span> Task.WhenAny(task,delayTask) == task)</span><br><span class="line">                &#123;</span><br><span class="line">                    timeoutCancellationTokenSource.Cancel();</span><br><span class="line">                    <span class="keyword">await</span> task;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(<span class="string">&quot;The opertion has timed out.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">TResult</span>&gt; <span class="title">WaitAsync</span>&lt;<span class="title">TResult</span>&gt;(<span class="params"><span class="keyword">this</span> Task&lt;TResult&gt; task, TimeSpan timeout</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> timeoutCancellationTokenSource = <span class="keyword">new</span> CancellationTokenSource())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> delayTask = Task.Delay(timeout, timeoutCancellationTokenSource.Token);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">await</span> Task.WhenAny(task, delayTask) == task)</span><br><span class="line">                &#123;</span><br><span class="line">                    timeoutCancellationTokenSource.Cancel();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">await</span> task;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(<span class="string">&quot;The operation has timed out.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä»»æ„çš„Taskå®ä¾‹ä¸Šè°ƒç”¨<code>myTask.WaitAsync</code>æ¥è·å–å¸¦è¶…æ—¶çš„éé˜»å¡å¼‚æ­¥ç­‰å¾…äº†~~</p>
<blockquote>
<p>å‚è€ƒèµ„æ–™ - [c# - Asynchronously wait for Task to complete with timeout - Stack Overflow](https://stackoverflow.com/q/4238345/6233938)</p>
</blockquote>
]]></content>
      <categories>
        <category>.NET</category>
      </categories>
      <tags>
        <tag>.NET</tag>
        <tag>å¼‚æ­¥ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ›å»ºå§”æ‰˜ä»¥å¤§å¹…åº¦æé«˜åå°„è°ƒç”¨çš„æ€§èƒ½</title>
    <url>/2019/08/07/create-delegate-to-improve-reflection-performance/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>åå°„è¿™ç§ä¸œè¥¿ï¼Œå¤§å®¶éƒ½çŸ¥é“ä¼¤æ€§èƒ½ï¼Œä½†æœ‰çš„æ—¶å€™å°±æ˜¯ä¸å¾—ä¸ç”¨åå°„ã€‚é‚£å’‹åŠå‘¢ï¼Ÿ</p>
<p>é‚£å°±æ˜¯ä¸ºåå°„å¾—åˆ°çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªå§”æ‰˜ï¼</p>
<p>è¿™ç§æ–¹å¼èƒ½å¤Ÿæé«˜è¿‘ä¹ç›´æ¥è°ƒç”¨æ–¹æ³•æœ¬èº«çš„æ€§èƒ½ã€‚ ï¼ˆå½“ç„¶Emitä¹Ÿèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ˜¾è‘—æå‡æ€§èƒ½ï¼Œä¸è¿‡ç›´æ¥å¾—åˆ°å¯ä»¥è°ƒç”¨çš„å§”æ‰˜å²‚ä¸æ˜¯æ›´åŠ æ–¹ä¾¿</p>
<a id="more"></a>
<p>å’±ä»¬å…ˆåˆ›å»ºä¸€ä¸ªç±»ï¼Œç”¨æ¥åšæµ‹è¯• <figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title">Foo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Test</span>(<span class="params"><span class="built_in">int</span> i</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å…ˆåˆ›å»ºä¸€ä¸ªå®ä¾‹</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨çš„ç›®æ ‡å®ä¾‹ã€‚</span></span><br><span class="line"><span class="keyword">var</span> instance = <span class="keyword">new</span> Foo();</span><br></pre></td></tr></table></figure>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬è°ƒç”¨æ–¹æ³•ç›´æ¥å¯ä»¥è¿™æ ·å†™ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> result = instance.Test(<span class="number">5</span>);</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å†™æ— ç–‘æ˜¯æœ€ä¸æŸè€—æ€§èƒ½çš„å†™æ³•ï¼Œæ‰€ä»¥æ˜¯ç›´æ¥è°ƒç”¨ã€‚</p>
<p>æ—¢ç„¶åšæ–‡æ ‡é¢˜éƒ½è¯´äº†æ˜¯åˆ›å»ºåå°„çš„å§”æ‰˜ï¼Œé‚£å’±ä»¬å°±å…ˆç›´æ¥å†™ä¸ªå’ŒTestæ–¹æ³•åŠŸèƒ½ä¸€æ ·çš„çº¯å§”æ‰˜ï¼Œç”¨ä½œæ€§èƒ½å¯¹æ¯”æµ‹è¯•</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·Ÿè¢«æµ‹æ–¹æ³•åŠŸèƒ½ä¸€æ ·çš„çº¯å§”æ‰˜ã€‚</span></span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt; pureFunc = <span class="keyword">value</span> =&gt; <span class="keyword">value</span>;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯åå°„çš„ä½¿ç”¨ï¼Œå…ˆå†™ä¸ªé€šè¿‡åå°„æ‹¿åˆ°æ–¹æ³• <figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨åå°„æ‰¾åˆ°çš„æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="keyword">var</span> method = <span class="keyword">typeof</span>(Foo).GetMethod(<span class="keyword">nameof</span>(Foo.Test), <span class="keyword">new</span>[] &#123; <span class="keyword">typeof</span>(<span class="built_in">int</span>) &#125;);</span><br></pre></td></tr></table></figure></p>
<p>æ‹¿åˆ°æ–¹æ³•åå°±æ˜¯è°ƒç”¨ï¼Œå¦‚æœæ˜¯ç›´æ¥è°ƒç”¨ï¼Œé‚£ä¹ˆå°±æ˜¯</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> result = method.Invoke(instance, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; <span class="number">5</span> &#125;);</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œè¿™ä¸ªæ˜¯å…ˆç”¨GetMethodæ‹¿åˆ°æ–¹æ³•ç¼“å­˜åçš„è°ƒç”¨ã€‚å¦‚æœæ˜¯ç›´æ¥ä½¿ç”¨åå°„è°ƒç”¨çš„è¯</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> result = <span class="keyword">typeof</span>(Foo).GetMethod(<span class="keyword">nameof</span>(Foo.Test), <span class="keyword">new</span>[] &#123; <span class="keyword">typeof</span>(<span class="built_in">int</span>) &#125;)?.Invoke(instance, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; <span class="number">5</span> &#125;);</span><br></pre></td></tr></table></figure>
<p><strong><em>ä¸‹é¢å°±æ˜¯æœ¬æ–‡çš„é‡ç‚¹</em></strong></p>
<p>é‚£å°±æ˜¯å°†åå°„æ‰¾åˆ°çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªå§”æ‰˜</p>
<h1 id="å¦‚ä½•å®ç°">å¦‚ä½•å®ç°ï¼Ÿ</h1>
<p>å®ç°çš„å…³é”®å°±åœ¨äº <code>MethodInfo.CreateDelegate</code> æ–¹æ³•ã€‚è¿™æ˜¯ .NET Standard ä¸­å°±æœ‰çš„æ–¹æ³•ï¼Œè¿™æ„å‘³ç€ .NET Framework å’Œ .NET Core ä¸­éƒ½å¯ä»¥ä½¿ç”¨ã€‚</p>
<p>æ­¤æ–¹æ³•æœ‰ä¸¤ä¸ªé‡è½½ï¼š</p>
<blockquote>
<p>1.è¦æ±‚ä¼ å…¥ä¸€ä¸ªç±»å‹ï¼Œè€Œè¿™ä¸ªç±»å‹å°±æ˜¯åº”è¯¥è½¬æˆçš„å§”æ‰˜çš„ç±»å‹ 2.è¦æ±‚ä¼ å…¥ä¸€ä¸ªç±»å‹å’Œä¸€ä¸ªå®ä¾‹ï¼Œä¸€æ ·çš„ï¼Œç±»å‹æ˜¯åº”è¯¥è½¬æˆçš„å§”æ‰˜çš„ç±»å‹</p>
</blockquote>
<p>ä»–ä»¬çš„åŒºåˆ«åœ¨äºå‰è€…åˆ›å»ºå‡ºæ¥çš„å§”æ‰˜æ˜¯ç›´æ¥è°ƒç”¨é‚£ä¸ªå®ä¾‹æ–¹æ³•æœ¬èº«ï¼Œåè€…åˆ™æ›´åŸå§‹ä¸€äº›ï¼ŒçœŸæ­£è°ƒç”¨çš„æ—¶å€™è¿˜éœ€è¦ä¼ å…¥ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å°†åå°„æ‰¾åˆ°çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªå§”æ‰˜ã€‚</span></span><br><span class="line"><span class="keyword">var</span> func = (Func&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt;)method.CreateDelegate(<span class="keyword">typeof</span>(Func&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt;), instance);</span><br><span class="line"><span class="keyword">var</span> func2 = (Func&lt;Foo, <span class="built_in">int</span>, <span class="built_in">int</span>&gt;)method.CreateDelegate(<span class="keyword">typeof</span>(Func&lt;Foo,<span class="built_in">int</span>, <span class="built_in">int</span>&gt;));</span><br></pre></td></tr></table></figure>
<p>å‰è€…å¾—åˆ°çš„å§”æ‰˜ç›¸å½“äº <code>int Test(int i)</code> æ–¹æ³•ï¼Œåè€…å¾—åˆ°çš„å§”æ‰˜ç›¸å½“äº <code>int Test(Foo instance, int i)</code> æ–¹æ³•ã€‚ï¼ˆåœ¨ IL é‡Œå®ä¾‹çš„æ–¹æ³•å…¶å®éƒ½æ˜¯åè€…ï¼Œè€Œå‰è€…æ›´åƒ C# ä¸­çš„ä»£ç ï¼Œå®¹æ˜“ç†è§£ã€‚ï¼‰</p>
<p>ä»¥ä¸‹æ˜¯æ€§èƒ½æµ‹è¯•ä»£ç ï¼Œå¯ä»¥æ›´å¥½çš„ç†è§£æœ¬æ–‡ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics.Contracts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp10</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨çš„ç›®æ ‡å®ä¾‹ã€‚</span></span><br><span class="line">            <span class="keyword">var</span> instance = <span class="keyword">new</span> Foo();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä½¿ç”¨åå°„æ‰¾åˆ°çš„æ–¹æ³•ã€‚</span></span><br><span class="line">            <span class="keyword">var</span> method = <span class="keyword">typeof</span>(Foo).GetMethod(<span class="keyword">nameof</span>(Foo.Test), <span class="keyword">new</span>[] &#123; <span class="keyword">typeof</span>(<span class="built_in">int</span>) &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å°†åå°„æ‰¾åˆ°çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªå§”æ‰˜ã€‚</span></span><br><span class="line">            <span class="keyword">var</span> func = InstanceMethodBuilder&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt;.CreateInstanceMethod(instance, method);</span><br><span class="line">            <span class="comment">//var func = (Func&lt;int, int&gt;)method.CreateDelegate(typeof(Func&lt;int, int&gt;), instance);</span></span><br><span class="line">            <span class="comment">//var func2 = (Func&lt;Foo, int, int&gt;)method.CreateDelegate(typeof(Func&lt;Foo,int, int&gt;));</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·Ÿè¢«æµ‹æ–¹æ³•åŠŸèƒ½ä¸€æ ·çš„çº¯å§”æ‰˜ã€‚</span></span><br><span class="line">            Func&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt; pureFunc = <span class="keyword">value</span> =&gt; <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æµ‹è¯•æ¬¡æ•°ã€‚</span></span><br><span class="line">            <span class="keyword">var</span> count = <span class="number">10000000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç›´æ¥è°ƒç”¨ã€‚</span></span><br><span class="line">            <span class="keyword">var</span> watch = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">            watch.Start();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> result = instance.Test(<span class="number">5</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            watch.Stop();</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;watch.Elapsed&#125;</span> - <span class="subst">&#123;count&#125;</span> æ¬¡ - ç›´æ¥è°ƒç”¨&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä½¿ç”¨åŒæ ·åŠŸèƒ½çš„ Func è°ƒç”¨ã€‚</span></span><br><span class="line">            watch.Restart();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> result = pureFunc(<span class="number">5</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            watch.Stop();</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;watch.Elapsed&#125;</span> - <span class="subst">&#123;count&#125;</span> æ¬¡ - ä½¿ç”¨åŒæ ·åŠŸèƒ½çš„ Func è°ƒç”¨&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä½¿ç”¨åå°„åˆ›å»ºå‡ºæ¥çš„å§”æ‰˜è°ƒç”¨ã€‚</span></span><br><span class="line">            watch.Restart();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> result = func(<span class="number">5</span>);</span><br><span class="line">                <span class="comment">//var result = func2(instance,5);</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            watch.Stop();</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;watch.Elapsed&#125;</span> - <span class="subst">&#123;count&#125;</span> æ¬¡ - ä½¿ç”¨åå°„åˆ›å»ºå‡ºæ¥çš„å§”æ‰˜è°ƒç”¨&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä½¿ç”¨åå°„å¾—åˆ°çš„æ–¹æ³•ç¼“å­˜è°ƒç”¨ã€‚</span></span><br><span class="line">            watch.Restart();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> result = method.Invoke(instance, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; <span class="number">5</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            watch.Stop();</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;watch.Elapsed&#125;</span> - <span class="subst">&#123;count&#125;</span> æ¬¡ - ä½¿ç”¨åå°„å¾—åˆ°çš„æ–¹æ³•ç¼“å­˜è°ƒç”¨&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç›´æ¥ä½¿ç”¨åå°„è°ƒç”¨ã€‚</span></span><br><span class="line">            watch.Restart();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="keyword">typeof</span>(Foo).GetMethod(<span class="keyword">nameof</span>(Foo.Test), <span class="keyword">new</span>[] &#123; <span class="keyword">typeof</span>(<span class="built_in">int</span>) &#125;)</span><br><span class="line">                    ?.Invoke(instance, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; <span class="number">5</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            watch.Stop();</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;watch.Elapsed&#125;</span> - <span class="subst">&#123;count&#125;</span> æ¬¡ - ç›´æ¥ä½¿ç”¨åå°„è°ƒç”¨&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.ReadLine();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">class</span> <span class="title">Foo</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Test</span>(<span class="params"><span class="built_in">int</span> i</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">InstanceMethodBuilder</span>&lt;<span class="title">T</span>, <span class="title">TReturnValue</span>&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> è°ƒç”¨æ—¶å°±åƒ var result = func(t)ã€‚</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">Pure</span>]</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">Func</span>&lt;<span class="title">T</span>, <span class="title">TReturnValue</span>&gt; <span class="title">CreateInstanceMethod</span>&lt;<span class="title">TInstanceType</span>&gt;(<span class="params">TInstanceType instance, MethodInfo method</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(instance));</span><br><span class="line">                <span class="keyword">if</span> (method == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(method));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> (Func&lt;T, TReturnValue&gt;)method.CreateDelegate(<span class="keyword">typeof</span>(Func&lt;T, TReturnValue&gt;), instance);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> è°ƒç”¨æ—¶å°±åƒ var result = func(this, t)ã€‚</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">Pure</span>]</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">Func</span>&lt;<span class="title">TInstanceType</span>, <span class="title">T</span>, <span class="title">TReturnValue</span>&gt; <span class="title">CreateMethod</span>&lt;<span class="title">TInstanceType</span>&gt;(<span class="params">MethodInfo method</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (method == <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(method));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> (Func&lt;TInstanceType, T, TReturnValue&gt;)method.CreateDelegate(<span class="keyword">typeof</span>(Func&lt;TInstanceType, T, TReturnValue&gt;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ€§èƒ½å¯¹æ¯”">æ€§èƒ½å¯¹æ¯”ï¼š</h1>
<img data-src="/2019/08/07/create-delegate-to-improve-reflection-performance/output.png" class="">
<p>è§£é‡Šä¸€ä¸‹è¿™äº”è¡Œæ•°æ®çš„å«ä¹‰ï¼š</p>
<p>1.ç›´æ¥è°ƒç”¨ï¼ˆåº”è¯¥æ²¡æœ‰ä»€ä¹ˆæ¯”ç›´æ¥è°ƒç”¨å‡½æ•°æœ¬èº«æ›´æœ‰æ€§èƒ½ä¼˜åŠ¿çš„å§ï¼‰</p>
<p>2.åšä¸€ä¸ªè·Ÿç›´æ¥è°ƒç”¨çš„æ–¹æ³•åŠŸèƒ½ä¸€æ¨¡ä¸€æ ·çš„å§”æ‰˜ï¼ˆç›®çš„æ˜¯çœ‹çœ‹è°ƒç”¨å§”æ‰˜ç›¸æ¯”è°ƒç”¨æ–¹æ³•æœ¬èº«æ˜¯å¦æœ‰æ€§èƒ½æŸå¤±ï¼Œä»æ•°æ®ä¸Šçœ‹ï¼ŒæŸå¤±éå¸¸å°ï¼‰</p>
<p>3.<strong><em>æœ¬æ–‡é‡ç‚¹</em></strong> å°†åå°„å‡ºæ¥çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªå§”æ‰˜ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªå§”æ‰˜ï¼ˆçœ‹çœ‹å§ï¼Œæ€§èƒ½è·Ÿç›´æ¥è°ƒå·®åˆ«ä¹Ÿä¸å¤§å˜›ï¼‰</p>
<p>4.å…ˆåå°„å¾—åˆ°æ–¹æ³•ï¼Œç„¶åä¸€ç›´è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼ˆç»ˆäºå¯ä»¥çœ‹å‡ºæ¥åå°„æœ¬èº«è¿˜æ˜¯æŒºä¼¤æ€§èƒ½çš„äº†ï¼Œ50 å¤šå€çš„æ€§èƒ½æŸå¤±å•Šï¼‰</p>
<p>5.ç¼“å­˜éƒ½ä¸ç”¨ï¼Œä»å¤´å¼€å§‹åå°„ç„¶åè°ƒç”¨å¾—åˆ°çš„æ–¹æ³•ï¼ˆ100 å¤šå€çš„æ€§èƒ½æŸå¤±äº†ï¼‰</p>
<h1 id="å°è£…">å°è£…ï¼š</h1>
<p>å•ç‹¬ä½¿ç”¨ <code>CreateDelegate</code> æ–¹æ³•å¯èƒ½æ¯æ¬¡éƒ½éœ€è¦å°è¯•ç¬¬ä¸€ä¸ªå‚æ•°åˆ°åº•åº”è¯¥ä¼ å…¥äº›ä»€ä¹ˆï¼Œäºæ˜¯æˆ‘å°†å…¶å°è£…æˆäº†æ³›å‹ç‰ˆæœ¬ï¼Œå¢åŠ æ˜“ç”¨æ€§ã€‚</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">InstanceMethodBuilder</span>&lt;<span class="title">T</span>, <span class="title">TReturnValue</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> è°ƒç”¨æ—¶å°±åƒ var result = func(t)ã€‚</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Pure</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">Func</span>&lt;<span class="title">T</span>, <span class="title">TReturnValue</span>&gt; <span class="title">CreateInstanceMethod</span>&lt;<span class="title">TInstanceType</span>&gt;(<span class="params">TInstanceType instance, MethodInfo method</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(instance));</span><br><span class="line">        <span class="keyword">if</span> (method == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(method));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (Func&lt;T, TReturnValue&gt;)method.CreateDelegate(<span class="keyword">typeof</span>(Func&lt;T, TReturnValue&gt;), instance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> è°ƒç”¨æ—¶å°±åƒ var result = func(this, t)ã€‚</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Pure</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">Func</span>&lt;<span class="title">TInstanceType</span>, <span class="title">T</span>, <span class="title">TReturnValue</span>&gt; <span class="title">CreateMethod</span>&lt;<span class="title">TInstanceType</span>&gt;(<span class="params">MethodInfo method</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (method == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(method));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (Func&lt;TInstanceType, T, TReturnValue&gt;)method.CreateDelegate(<span class="keyword">typeof</span>(Func&lt;TInstanceType, T, TReturnValue&gt;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œè¿™ä¸ªæ³›å‹å°è£…ä¹Ÿæ˜¯æœ‰é—®é¢˜çš„ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºçš„å§”æ‰˜åªèƒ½æ˜¯ä¸€ä¸ªå‚æ•°ã€‚æ²¡æœ‰å®ç°åƒAction&lt;T1,T2,T3,Tn&gt;è¿™æ ·çš„å¤šå‚æ•°å§”æ‰˜</p>
<p>ä¸è¿‡å¤šå‚æ•°ç‰ˆæœ¬å¯ä»¥ä½¿ç”¨æ³›å‹ç±»å‹ç”Ÿæˆå™¨ç”Ÿæˆã€‚</p>
<p>ä¸è¿‡è¿™ä¸ªæ—¥åå†è¯´ï¼Œä¹‹åæœ‰æ—¶é—´å†ç»™å¤§å®¶å†™ä¸€ä¸ªæ³›å‹ç”Ÿæˆå™¨</p>
]]></content>
      <categories>
        <category>.NET</category>
      </categories>
      <tags>
        <tag>.NET</tag>
        <tag>åå°„</tag>
      </tags>
  </entry>
  <entry>
    <title>è¯·æˆ‘åƒä¸ªé¥­å›¢ï¼</title>
    <url>/2018/12/25/donate/</url>
    <content><![CDATA[<h1 id="æèµ ">æèµ ğŸ§§</h1>
<p>æ„Ÿè°¢æ‚¨çš„æèµ ï¼Œå®ƒå°†ç»™äºˆæˆ‘åŠ¨åŠ›ï¼Œæ›´ä¸“æ³¨äº Github ä¸Šé¡¹ç›®çš„åç»­å¼€å‘ã€‚</p>
<p>å†æ¬¡æ„Ÿè°¢æ‚¨çš„æ”¯æŒã€‚ <a id="more"></a> </br> <img data-src="/2018/12/25/donate/donate.jpg" class=""></p>
]]></content>
  </entry>
  <entry>
    <title>æ·±å…¥å‰–æIEnumerableå’ŒIQueryableä¸¤æ¥å£</title>
    <url>/2019/03/03/dotnet-IEnumerable-IQueryable/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°<code>IEnumerable</code>å’Œ<code>IQueryable</code>è¿™ä¸¤ä¸ªæ¥å£ï¼Œä¹Ÿè®¸å¤§å®¶ä¹Ÿèƒ½ç†Ÿç»ƒçš„è¿ç”¨è¿™ä¸¤ä¸ªæ¥å£å¯¹æ•°æ®åº“æˆ–è€…é›†åˆè¿›è¡Œå„ç§å¤æ‚æŸ¥è¯¢ã€‚</p>
<p>å®é™…ä¸Šå¦‚æœé”™è¯¯çš„ä½¿ç”¨ï¼Œä¼šå¯¼è‡´å¾ˆå¤šå¾ˆå¤šç³»ç»Ÿä¼˜åŒ–ï¼ŒæŸ¥è¯¢æ•ˆç‡ç­‰ç­‰é—®é¢˜ã€‚ä»¥åŠå¾ˆå¤šäººåæ§½<code>EntityFramework</code>æ•ˆç‡ä½ä¸‹ã€‚å®é™…ä¸Š<strong>å¾ˆå¤§åŸå› å°±æ˜¯<code>IEnumerable</code>å’Œ<code>IQueryable</code>ä½¿ç”¨çš„é—®é¢˜ï¼</strong></p>
<p>é‚£ä¹ˆï¼Œå®ƒä»¬ç©¶ç«Ÿæ˜¯å¦‚ä½•å®šä¹‰çš„ï¼Œéƒ½åˆ†åˆ«ç”¨æ¥å¹²ä»€ä¹ˆçš„ï¼Ÿåˆå°¤å…¶æ˜¯<code>IQueryable</code>ï¼Œå®ƒå’ŒEntityFrameworkçš„å»¶è¿ŸåŠ è½½æŠ€æœ¯åˆæœ‰ä»€ä¹ˆè”ç³»å‘¢ï¼Ÿ</p>
<a id="more"></a>
<h1 id="å®šä¹‰">å®šä¹‰</h1>
<blockquote>
<ul>
<li><code>Enumerable</code>ç±»ï¼Œç»§æ‰¿è‡ª<code>IEnumerable&lt;T&gt;</code>æ¥å£çš„é›†åˆè¿›è¡Œæ‰©å±•</li>
<li><code>Queryable</code>ç±»ï¼Œç»§æ‰¿è‡ª<code>IQueryable&lt;T&gt;</code>æ¥å£çš„é›†åˆè¿›è¡Œæ‰©å±•</li>
</ul>
</blockquote>
<p>æ—¢ç„¶è¯´åˆ°EntityFrameworkï¼Œé‚£ä¹ˆå°±è¦çœ‹ä¸€ä¸‹EntityFrameworkçš„å®ä½“é›†åˆ<code>DbSet&lt;T&gt;</code></p>
<img data-src="/2019/03/03/dotnet-IEnumerable-IQueryable/DbSet.png" class="">
<p>ä»å®šä¹‰ä¸Šçœ‹ï¼Œ<code>DbSet&lt;T&gt;</code>ä¹ŸåŒæ—¶å®ç°äº†<code>IEnumerable&lt;T&gt;</code>å’Œ<code>IQueryable&lt;T&gt;</code>ã€‚ä¹Ÿå°±æ„å‘³ç€<code>DbSet&lt;T&gt;</code>é€šè¿‡å®ç°<code>IEnumerable&lt;T&gt;</code>å’Œ<code>IQueryable&lt;T&gt;</code>çš„åŸºç¡€ä¸Šï¼Œå¯ä»¥æ‹¥æœ‰<code>Enumerable</code>å’Œ<code>Queryable</code>è¿™ä¸¤ä¸ªé™æ€ç±»çš„å¾ˆå¤šæ–¹æ³•çš„æ‰©å±•ã€‚</p>
<h1 id="ä»æ‰©å±•æ–¹æ³•ä¸Šåˆ†è¾¨åŒºåˆ«">ä»æ‰©å±•æ–¹æ³•ä¸Šåˆ†è¾¨åŒºåˆ«</h1>
<p>### <code>Enumerable</code>: <img data-src="/2019/03/03/dotnet-IEnumerable-IQueryable/Enumerable-define.png" class=""> ### <code>Queryable</code>: <img data-src="/2019/03/03/dotnet-IEnumerable-IQueryable/Queryable-define.png" class=""></p>
<p>ä¸Šé¢ä¸¤å¼ å›¾å¯ä»¥çœ‹å‡º <code>Enumerable</code>å’Œ<code>Queryable</code>ä¸‹çš„æ‰©å±•æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°æ˜¯åˆ†åˆ«æ˜¯<code>Func&lt;T&gt;</code>å’Œ<code>Expression&lt;Func&lt;T&gt;&gt;</code></p>
<p>è¿™å°±æœ‰ç–‘é—®äº†ï¼Œéš¾é“æˆ‘ä»¬å¹³æ—¶ç”¨çš„<code>Where()</code>ç­‰æ‰©å±•æ–¹æ³•ï¼ŒåŸæ¥æœ‰æ—¶å€™éƒ½ä¸æ˜¯åŒä¸€ä¸ªæ–¹æ³•ä¹ˆï¼Ÿ</p>
<p>å…¶å®æˆ‘ä»¬åç¼–è¯‘ä»”ç»†è§‚å¯Ÿ<code>IQueryable</code>çš„è¯ï¼Œå®é™…ä¸Šä¹Ÿç»§æ‰¿äº†<code>IEnumerable</code>ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªæ¥å£çš„æ–¹æ³•ï¼Œåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆï¼Œå¾®è½¯ä¸ºä»€ä¹ˆè¦è®¾è®¡å‡ºä¸¤å¥—æ‰©å±•æ–¹æ³•å‘¢ï¼Ÿ</p>
<p>å¥½ï¼Œä¸‹é¢ç»§ç»­æ·±å…¥ç ”ç©¶ä¸€ä¸‹ã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿å¤§å®¶æ›´ç›´è§‚çš„ç†è§£ï¼Œæ¥ä¸‹æ¥å°±ç”¨ä»£ç é©±åŠ¨äº†ï¼Œé€è¿‡ç°è±¡çœ‹æœ¬è´¨ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬å…ˆåˆ›ä¸ªæ§åˆ¶å°é¡¹ç›®ï¼ŒæŠŠEntityFrameworkåŒ…å¼•å…¥ï¼Œé¡ºä¾¿å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„MSSQLæ•°æ®åº“ï¼Œä»¥åŠå®ä½“å’Œæ•°æ®åº“ä¸Šä¸‹æ–‡</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp9</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> testEntities())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> query = db.Set&lt;User&gt;().Where(e =&gt; e.UserName == <span class="string">&quot;å°çº¢&quot;</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//var query = db.Set&lt;User&gt;().AsEnumerable().Where(e =&gt; e.UserName == &quot;å°çº¢&quot;);</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> query)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(item.UserName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæ³¨æ„ä¸‹<code>query</code>å˜é‡çš„ç±»å‹ <img data-src="/2019/03/03/dotnet-IEnumerable-IQueryable/query-type.png" class=""></p>
<p>å¯ä»¥çœ‹åˆ°<code>query</code>æ˜¯ä¸ª<code>IQueryable&lt;User&gt;</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>DbSet&lt;T&gt;</code>çš„<code>Where()</code>æ–¹æ³•ï¼Œé»˜è®¤æ˜¯æ¥è‡ª<code>Queryable</code>ä¸‹çš„æ‰©å±•æ–¹æ³•</p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“æ‰€æœ‰çš„ORMæ¡†æ¶ï¼ŒåŒ…æ‹¬EntityFrameworkï¼Œéƒ½æ˜¯å°†ä»£ç è½¬æ¢æˆSQLè¯­å¥æ¥å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬å°±è¦ä»ç”Ÿæˆçš„SQLè¯­å¥æ¥å¯¹æ¯”<code>IEnumerable</code>å’Œ<code>IQueryable</code></p>
<h3 id="ienumerable"><code>IEnumerable</code>:</h3>
<img data-src="/2019/03/03/dotnet-IEnumerable-IQueryable/IEnumerable.png" class="">
<h3 id="iqueryable"><code>IQueryable</code>:</h3>
<img data-src="/2019/03/03/dotnet-IEnumerable-IQueryable/IQueryable.png" class="">
<p><strong>å¯¹æ¯”ç”Ÿæˆçš„SQLè¯­å¥ï¼Œæˆ‘ä»¬å‘ç°ï¼ŒIEnumerableè¿›è¡Œç­›é€‰çš„æ—¶å€™ï¼Œæ²¡æœ‰whereæ¡ä»¶ï¼</strong></p>
<p><strong>ä¹Ÿå°±æ˜¯è¯´ï¼ŒIEnumerableä¼šå°†æ•°æ®åº“é‡Œæ‰€æœ‰çš„æ•°æ®å…¨éƒ¨å–è¿‡æ¥ï¼Œç„¶åå†åœ¨å†…å­˜é‡Œè¿›è¡ŒæŸ¥è¯¢ï¼</strong></p>
<h1 id="ç»“è®º">ç»“è®º</h1>
<p>1.å¯¹äº<code>IEnumerable</code>çš„è¿‡æ»¤ã€æ’åºã€åˆ†ç»„ã€èšåˆç­‰æ“ä½œï¼Œéƒ½æ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œçš„ã€‚</p>
<p>2.å¯¹äº<code>IQueryable</code>çš„è¿‡æ»¤ã€æ’åºã€åˆ†ç»„ã€èšåˆç­‰æ“ä½œï¼ŒLinq to SQLå¼•æ“ä¼šæŠŠè¡¨è¾¾å¼æ ‘è½¬åŒ–æˆç›¸åº”çš„SQLè¯­å¥åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œï¼Œè¿™ä¹Ÿæ˜¯Linqçš„å»¶è¿ŸåŠ è½½æ ¸å¿ƒæ€æƒ³æ‰€åœ¨ã€‚</p>
<p>å…¶å®<code>IQueryable</code>å®ç°äº†<code>IEnumerable</code>æ¥å£ã€‚ä½†å¤šäº†å‡ ä¸ªå±æ€§ <img data-src="/2019/03/03/dotnet-IEnumerable-IQueryable/IQueryable-define.png" class=""></p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œæƒ³å¿…å°±èƒ½è§£é‡Šä¸ºä»€ä¹ˆ<code>IQueryable</code>ï¼Œä¼šæ¯”<code>IEnumerable</code>ä¼ é€’å§”æ‰˜æ—¶ï¼Œä¼šå¤šå¥—ä¸Šä¸€ä¸ª<code>Expression</code></p>
<p>ç­”æ¡ˆå°±åœ¨äºï¼š<code>Expression</code>ä¼šæŠŠæŸ¥è¯¢è¡¨è¾¾å¼ç”Ÿæˆè¡¨è¾¾å¼æ ‘ç¼“å­˜èµ·æ¥ï¼Œåªæœ‰å½“çœŸæ­£éœ€è¦ç”¨åˆ°çš„æ—¶å€™ï¼Œæ‰ä¼šç”±<code>IQueryProvider</code>è§£æè¡¨è¾¾å¼æ ‘ï¼Œç¿»è¯‘æˆsqlè¯­å¥æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢æ“ä½œã€‚è€ŒFuncæ˜¯ä¸ªå§”æ‰˜ï¼Œå¿…é¡»è¦å…ˆæ‰§è¡Œå®Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ªæ–¹æ³•çš„è°ƒç”¨ã€‚</p>
<p>æ›´ç›´ç™½ç‚¹çš„è¯´ï¼Œå°±æ˜¯ï¼š<code>IQueryable</code>æ˜¯è´Ÿè´£ç”ŸæˆSQLè¯­å¥çš„ï¼Œä½†å¹¶ä¸é©¬ä¸Šæ‰§è¡Œï¼›è€Œ<code>IEnumerable</code>æ˜¯å¯¹ä»»æ„ç±»å‹çš„é›†åˆéƒ½èƒ½æ“ä½œã€‚</p>
<h1 id="å¼•å‡ºçš„ä»£ç è§„èŒƒ">å¼•å‡ºçš„ä»£ç è§„èŒƒ</h1>
<ul>
<li>æ“ä½œ<strong>æœ¬åœ°</strong>æ•°æ®æºæ—¶ç”¨IEnumerable</li>
<li>æ“ä½œ<strong>è¿œç¨‹</strong>æ•°æ®æºæ—¶ç”¨IQueryable</li>
</ul>
]]></content>
      <categories>
        <category>.NET</category>
      </categories>
      <tags>
        <tag>.NET</tag>
        <tag>EntityFramework</tag>
        <tag>ORMæ¡†æ¶</tag>
        <tag>å»¶è¿ŸæŸ¥è¯¢</tag>
      </tags>
  </entry>
  <entry>
    <title>æ”¯æŒå•å­—é€šé…ç¬¦çš„Sundayæ¨¡ç³ŠåŒ¹é…ç®—æ³•</title>
    <url>/2021/02/23/fuzzy-matching-algorithm-supporting-wildcard-based-on-Sunday/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>å¿™ç¢Œçš„æ˜¥èŠ‚è¿‡å»äº†ï¼ˆåæ§½ä¸€ä¸‹ï¼Œç°åœ¨å—äº¬ä¸ç»™æ”¾ç‚®ä»—ï¼ŒçœŸæ˜¯è¶Šæ¥è¶Šæ²¡æœ‰å¹´å‘³äº†ï¼Œä¸ä½†æ˜¯ç¤¼ç‚®ï¼Œè¿æ“¦ç‚®ã€æ‘”ç‚®éƒ½ä¹°ä¸åˆ°ï¼‰ï¼Œç»ˆäºèƒ½é—²ä¸‹æ¥å­¦ä¹ å’Œå†™åšæ–‡äº†ã€‚ä»Šå¤©å¡«ä¸€ä¸‹ä¸Šç¯‡æ–‡ç« ç•™ä¸‹çš„å‘ã€‚å®ç°ä¸€ä¸ªæ”¯æŒå•å­—é€šé…ç¬¦çš„Sundayæ¨¡ç³ŠåŒ¹é…ç®—æ³•</p>
<a id="more"></a>
<h1 id="å‡å®šéœ€æ±‚">å‡å®šéœ€æ±‚</h1>
<p>ç»™å®šä¸€ä¸ª haystack å­—ç¬¦ä¸²å’Œä¸€ä¸ª needle å­—ç¬¦ä¸²ï¼Œå®ç°ä¸€ä¸ªæ”¯æŒ <code>'?'</code> çš„å•å­—é€šé…ç¬¦åŒ¹é…ç®—æ³•ã€‚åœ¨ haystack å­—ç¬¦ä¸²ä¸­æ‰¾å‡º needle å­—ç¬¦ä¸²å‡ºç°çš„ç¬¬ä¸€ä¸ªä½ç½® (ä»0å¼€å§‹)ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å› -1ã€‚</p>
<h3 id="ç¤ºä¾‹-1">ç¤ºä¾‹ 1:</h3>
<blockquote>
<p>è¾“å…¥: haystack = "hello", needle = "l?o" è¾“å‡º: 2</p>
</blockquote>
<h3 id="ç¤ºä¾‹-2">ç¤ºä¾‹ 2:</h3>
<blockquote>
<p>è¾“å…¥: haystack = "aaaaa", needle = "b?a" è¾“å‡º: -1</p>
</blockquote>
<blockquote>
<ul>
<li>æœ¬æ–‡ç®—æ³•å¤æ‚åº¦ä¸­çš„<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0" xmlns="http://www.w3.org/2000/svg" width="2.378ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 1051 683" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D440"></use></g></g></g></svg></mjx-container>æ˜¯æ¨¡å¼ä¸²çš„é•¿åº¦ï¼Œ<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 888 683" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D441"></use></g></g></g></svg></mjx-container>æ˜¯ä¸»ä¸²çš„é•¿åº¦ã€‚</li>
<li><code>i</code>ä»£è¡¨ä¸»ä¸²æŒ‡é’ˆï¼Œ<code>j</code>ä»£è¡¨æ¨¡å¼ä¸²æŒ‡é’ˆï¼Œ<code>?</code>ä»£è¡¨å•å­—é€šé…ç¬¦</li>
</ul>
</blockquote>
<h1 id="æœ´ç´ è§£æ³•æš´åŠ›åŒ¹é…">æœ´ç´ è§£æ³•ï¼ˆæš´åŠ›åŒ¹é…ï¼‰</h1>
<p>æ¯æ¬¡<code>j</code>å‘åç§»åŠ¨1æ­¥ï¼Œé€ä¸ªå¯¹æ¯”ï¼Œé‡åˆ°<code>?</code>å°±è·³è¿‡ï¼›é‡åˆ°ä¸åŒ¹é…çš„ï¼Œ<code>i</code>å‘åç§»åŠ¨1æ­¥, <code>j</code>å†ä»å¤´å¯¹æ¯”</p>
<h2 id="å®ç°">å®ç°</h2>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">patternMatch</span><span class="params">(string haystack, string needle)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> h_len = haystack.<span class="built_in">size</span>(), n_len = needle.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span> (!n_len)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= h_len - n_len; ++i) &#123; <span class="comment">// i ä¸»ä¸²æŒ‡é’ˆ</span></span><br><span class="line">            <span class="type">bool</span> found = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; n_len; ++j) &#123; <span class="comment">// j æ¨¡å¼ä¸²æŒ‡é’ˆ</span></span><br><span class="line">                <span class="keyword">if</span> (needle[j] == <span class="string">&#x27;?&#x27;</span>) <span class="comment">// é‡åˆ°é€šé…ç¬¦ï¼Œè·³è¿‡</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (haystack[i + j] != needle[j]) &#123; <span class="comment">// ä¸åŒ¹é…</span></span><br><span class="line">                    found = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (found) <span class="comment">// åŒ¹é…ï¼Œè¿”å›ç´¢å¼•</span></span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="å¤æ‚åº¦åˆ†æ">å¤æ‚åº¦åˆ†æ</h2>
<ul>
<li>é¢„å¤„ç†æ—¶é—´å¤æ‚åº¦ï¼š<em>æ— </em></li>
<li>åŒ¹é…æ—¶é—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="7.873ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3480 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-1-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-1-TEX-I-1D440"></use></g><g data-mml-node="mi" transform="translate(2203, 0)"><use xlink:href="#MJX-1-TEX-I-1D441"></use></g><g data-mml-node="mo" transform="translate(3091, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
<li>ç©ºé—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2041 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mn" transform="translate(1152, 0)"><use xlink:href="#MJX-1-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(1652, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
</ul>
<h1 id="sundayè§£æ³•">Sundayè§£æ³•</h1>
<h2 id="æ ‡å‡†sundayéœ€è¦ä»€ä¹ˆæ”¹è¿›">æ ‡å‡†Sundayéœ€è¦ä»€ä¹ˆæ”¹è¿›?</h2>
<p>ä¹‹å‰ä»‹ç»è¿‡æ ‡å‡†çš„Sundayç®—æ³•æ˜¯é€šè¿‡åç§»è¡¨ï¼Œåœ¨åŒ¹é…å¤±è´¥æ—¶ï¼Œ<strong>ç¡®å®š</strong>éœ€è¦ç§»åŠ¨å¤šå°‘ï¼Œç„¶åè®©<code>i</code>å»ä½ç§»</p>
<p>ä½†ç”±äº<code>?</code>å¯ä»¥ä»£è¡¨ä»»æ„ä¸€ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥æˆ‘ä»¬<strong>æ— æ³•åœ¨é¢„å¤„ç†é˜¶æ®µå°±ç¡®å®š</strong>éœ€è¦ç§»åŠ¨å¤šå°‘ï¼Œåªèƒ½æ ¹æ®æ¨¡å¼ä¸²ä¸­æœ€åçš„<code>?</code>ç¡®å®š<strong>æœ€å°‘</strong>éœ€è¦ç§»åŠ¨å¤šå°‘ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦è®©<code>?</code>çš„åç§»é‡åŠ¨æ€æ›´æ–°</p>
<h2 id="å¦‚ä½•åŠ¨æ€æ›´æ–°é€šé…ç¬¦çš„åç§»é‡">å¦‚ä½•åŠ¨æ€æ›´æ–°é€šé…ç¬¦çš„åç§»é‡</h2>
<p>æ¯æ¬¡å¯¹æ¯”ä¸­<code>j</code>åªè¦é‡åˆ°äº†<code>?</code>ï¼Œå°±å°†åç§»é‡æ›´æ–°è¿›å»ã€‚å¦‚æœ<code>j</code>ä»æ¥æ²¡é‡åˆ°è¿‡<code>?</code>ï¼Œå°±ä½¿ç”¨é€šé…ç¬¦æœ€å°åç§»ã€‚</p>
<h2 id="å­—ç¬¦åç§»è¡¨å’Œé€šé…ç¬¦åç§»é‡å¦‚æœåŒæ—¶å­˜åœ¨åº”è¯¥å¦‚ä½•é€‰æ‹©">å­—ç¬¦åç§»è¡¨å’Œé€šé…ç¬¦åç§»é‡å¦‚æœåŒæ—¶å­˜åœ¨ï¼Œåº”è¯¥å¦‚ä½•é€‰æ‹©?</h2>
<p>ç­”æ¡ˆï¼šé€‰æ‹©å­—ç¬¦åç§»è¡¨</p>
<p>ä¸ºä»€ä¹ˆï¼šå› ä¸ºèƒ½ç›´æ¥å°†æ¨¡å¼ä¸²å’ŒåŒ¹é…çš„æœ«å°¾å­—ç¬¦çš„ä¸‹ä¸€ä½å¯¹é½</p>
<h2 id="å®ç°-1">å®ç°</h2>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">patternMatch</span><span class="params">(string haystack, string needle)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> h_len = haystack.<span class="built_in">size</span>(), n_len = needle.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span> (!n_len)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// é¢„å¤„ç†</span></span><br><span class="line">        <span class="type">int</span> shift[<span class="number">0xFF</span> + <span class="number">1</span>]&#123;&#125;; <span class="comment">// å­—ç¬¦åç§»è¡¨</span></span><br><span class="line">        <span class="type">int</span> wildcard_min_shitf = <span class="number">0</span>;  <span class="comment">// é€šé…ç¬¦æœ€å°åç§»</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n_len; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (needle[i] == <span class="string">&#x27;?&#x27;</span>)<span class="comment">// å°† ? çš„æœ€å°åç§»é‡å­˜åˆ° wildcard_min_shitf é‡Œ</span></span><br><span class="line">                wildcard_min_shitf = n_len - i;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                shift[needle[i]] = n_len - i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= h_len - n_len;) &#123; <span class="comment">// i ä¸»ä¸²æŒ‡é’ˆ</span></span><br><span class="line">            <span class="type">bool</span> found = <span class="literal">true</span>;</span><br><span class="line">            <span class="type">int</span> step = wildcard_min_shitf; <span class="comment">// æ¯æ¬¡å¯¹æ¯”ä¹‹å‰é‡ç½®ä¸ºæœ€å°åç§»é‡</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; n_len; ++j) &#123; <span class="comment">// j æ¨¡å¼ä¸²æŒ‡é’ˆ</span></span><br><span class="line">                <span class="keyword">if</span> (needle[j] == <span class="string">&#x27;?&#x27;</span>) <span class="comment">// é‡åˆ°?ï¼Œæ›´æ–°é€šé…ç¬¦åç§»</span></span><br><span class="line">                    step = n_len - j;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (haystack[i + j] != needle[j]) &#123;  <span class="comment">// ä¸åŒ¹é…</span></span><br><span class="line">                    found = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (found)  <span class="comment">// åŒ¹é…ï¼Œè¿”å›ç´¢å¼•</span></span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸åŒ¹é…ï¼Œå¦‚æœå‚ä¸åŒ¹é…çš„æœ«å°¾å­—ç¬¦çš„ä¸‹ä¸€ä½åœ¨å­—ç¬¦åç§»è¡¨é‡Œï¼Œå°±ä½¿ç”¨å­—ç¬¦åç§»é‡</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="type">int</span> shift_step = shift[haystack[i + n_len]]) &#123;</span><br><span class="line">                step = shift_step; </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (step &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                i += step;  <span class="comment">// å‡ºç°åœ¨æ¨¡å¼ä¸²ä¸­ï¼ŒæŒ‰åç§»é‡è·³è¿‡</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                i += n_len + <span class="number">1</span>; <span class="comment">// æ²¡å‡ºç°åœ¨æ¨¡å¼ä¸²ä¸­ï¼Œè·³è¿‡æ¨¡å¼ä¸²é•¿åº¦ + 1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="å¤æ‚åº¦åˆ†æ-1">å¤æ‚åº¦åˆ†æ</h2>
<ul>
<li>é¢„å¤„ç†æ—¶é—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="5.864ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2592 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-1-TEX-I-1D440"></use></g><g data-mml-node="mo" transform="translate(2203, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
<li>åŒ¹é…æ—¶é—´å¤æ‚åº¦ï¼š
<ul>
<li>å¹³å‡ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2429 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-1-TEX-I-1D441"></use></g><g data-mml-node="mo" transform="translate(2040, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
<li>æœ€å¥½ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.781ex" xmlns="http://www.w3.org/2000/svg" width="6.163ex" height="2.765ex" role="img" focusable="false" viewBox="0 -877 2724.2 1222" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-1-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mfrac" transform="translate(1152, 0)"><g data-mml-node="mi" transform="translate(277.6, 394) scale(0.707)"><use xlink:href="#MJX-1-TEX-I-1D441"></use></g><g data-mml-node="mi" transform="translate(220, -345) scale(0.707)"><use xlink:href="#MJX-1-TEX-I-1D440"></use></g><rect width="943.2" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(2335.2, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
<li>æœ€å·®ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="7.873ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3480 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-1-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-1-TEX-I-1D440"></use></g><g data-mml-node="mi" transform="translate(2203, 0)"><use xlink:href="#MJX-1-TEX-I-1D441"></use></g><g data-mml-node="mo" transform="translate(3091, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
</ul></li>
<li>ç©ºé—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="5.864ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2592 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-1-TEX-I-1D440"></use></g><g data-mml-node="mo" transform="translate(2203, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
</ul>
<h1 id="å®é™…æƒ…å†µæµ‹è¯•">å®é™…æƒ…å†µæµ‹è¯•</h1>
<p><em>ç‰¹å¾ç åŒ¹é…</em>æ˜¯å•å­—é€šé…ç¬¦æ¨¡ç³ŠåŒ¹é…çš„åº”ç”¨åœºæ™¯ä¹‹ä¸€</p>
<p>è¿™é‡Œä½¿ç”¨C#å®ç°çš„<em>ç‰¹å¾ç åŒ¹é…</em>å¯¹<code>GTAV</code>è¿›ç¨‹ä¸»æ¨¡å—å†…å­˜è¿›è¡Œæœç´¢</p>
<p>æµ‹è¯•ç¯å¢ƒï¼šä¸»ä¸²é•¿åº¦ï¼šå°†è¿‘8000ä¸‡ï¼ŒDebugæ¨¡å¼</p>
<h3 id="æœ´ç´ ç®—æ³•æš´åŠ›åŒ¹é…">æœ´ç´ ç®—æ³•ï¼ˆæš´åŠ›åŒ¹é…ï¼‰</h3>
<img data-src="/2021/02/23/fuzzy-matching-algorithm-supporting-wildcard-based-on-Sunday/BF.png" class="">
<h3 id="sundayç®—æ³•">Sundayç®—æ³•</h3>
<img data-src="/2021/02/23/fuzzy-matching-algorithm-supporting-wildcard-based-on-Sunday/Sunday.png" class="">
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<img data-src="/2021/02/23/fuzzy-matching-algorithm-supporting-wildcard-based-on-Sunday/time-consuming-chart.png" class="">
<img data-src="/2021/02/23/fuzzy-matching-algorithm-supporting-wildcard-based-on-Sunday/count-chart.png" class="">
<p>æ ¹æ®ä»¥ä¸Šæµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥çœ‹å‡ºã€‚åœ¨<em>ç‰¹å¾ç åŒ¹é…</em>çš„å®é™…åº”ç”¨ä¸­ï¼ŒSundayç®—æ³•æ‹¥æœ‰æé«˜çš„æ€§èƒ½ä¼˜åŠ¿</p>
<ul>
<li>è€—æ—¶ï¼šSundayç®—æ³•æ¯”æœ´ç´ ç®—æ³•å¿«äº†3-4å€</li>
<li>å¯¹æ¯”æ¬¡æ•°ï¼šSundayç®—æ³•æ¯”æœ´ç´ ç®—æ³•å‡å°‘äº†4-6å€</li>
</ul>
]]></content>
      <categories>
        <category>ç®—æ³•</category>
      </categories>
      <tags>
        <tag>ç®—æ³•</tag>
        <tag>C++</tag>
        <tag>å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•</tag>
        <tag>Sunday</tag>
        <tag>æ¨¡ç³ŠåŒ¹é…ç®—æ³•</tag>
      </tags>
  </entry>
  <entry>
    <title>2021è…¾è®¯æ¸¸æˆå®‰å…¨æŠ€æœ¯ç«èµ› å†³èµ›PCå®¢æˆ·ç«¯writeup</title>
    <url>/2021/04/22/gslab-ctf-finals-pc-writeup/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>æœ€è¿‘å¿™äº†ä¸€äº›çç¢çš„äº‹æƒ…ï¼Œè¿™ä¸¤å¤©åˆæœ‰é—²åŠŸå¤«äº†ï¼Œå‘ç°<a href="https://gslab.qq.com/html/competition/2021/index.htm">2021å®‰å…¨æŠ€æœ¯ç«èµ›</a>å†³èµ›èµ›é¢˜å‡ºæ¥äº†ï¼Œè€Œä¸”æ¯”èµ›éƒ½ç»“æŸäº†....</p>
<p>è™½ç„¶èµ›äº‹å·²ç»ç»“æŸï¼Œä½†é¢˜ç›®è¿˜æ˜¯èƒ½åšã€‚æ—¢ç„¶é—²ä¸‹æ¥å°±ç»§ç»­åšåšï¼Œå†™ä¸ªwriteupå§ã€‚</p>
<p><a href="https://gslab.qq.com/html/competition/2021/doc/PC%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%96%B9%E5%90%91%E5%86%B3%E8%B5%9B%E8%B5%9B%E9%A2%98.zip">PCå†³èµ›èµ›é¢˜ä¸‹è½½</a></p>
<a id="more"></a>
<h1 id="èµ›é¢˜">èµ›é¢˜</h1>
<h3 id="è¯´æ˜">è¯´æ˜ï¼š</h3>
<ol type="1">
<li>shootgameæ˜¯ä¸€ä¸ªæ¸¸æˆï¼Œhack.exeæ˜¯æ¸¸æˆshootergameçš„ä¸€ä¸ªå¤–æŒ‚ç¨‹åºã€‚</li>
<li>è¿è¡Œshootgameæ¸¸æˆï¼Œè¿è¡Œhack.exeï¼ŒæˆåŠŸæ‰§è¡Œå¤–æŒ‚åŠŸèƒ½å¹¶åˆ†æå¤–æŒ‚å®ç°è¿‡ç¨‹ã€‚</li>
</ol>
<h3 id="ç›®æ ‡">ç›®æ ‡ï¼š</h3>
<ol type="1">
<li>æˆåŠŸæ‰§è¡ŒhackåŠŸèƒ½ï¼Œç»™å‡ºå¤–æŒ‚æ‰§è¡ŒæˆåŠŸçš„flag</li>
<li>å®ç°ä¸hack.exeå¤–æŒ‚åŠŸèƒ½ç›¸åŒï¼Œä½†åŸç†ä¸åŒçš„ç¨‹åº</li>
</ol>
<p>å¾ˆæœ‰æ„æ€çš„æ¸¸æˆå¤–æŒ‚æ–¹å‘ï¼Œç®—æ˜¯æˆ‘æ¯”è¾ƒæ“…é•¿çš„é¢†åŸŸ</p>
<p>å…ˆæ‰“å¼€æ¸¸æˆè¯•è¯•ï¼Œè·‘ä¸€ä¸‹hack.exeï¼Œå‘ç°ä¸€é—ªè€Œè¿‡ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œå¤–æŒ‚åŠŸèƒ½ çœ‹äº†ä¸€ä¸‹æ— å£³ï¼Œæ‰€ä»¥ç›´æ¥æ‹–å…¥IDAåˆ†æ</p>
<h1 id="åˆ†æhack.exe">åˆ†æhack.exe</h1>
<p>mainå‡½æ•°é‡Œå°±æ˜¯æ•´ä¸ªå¤–æŒ‚ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼Œå…ˆå¤§ä½“çœ‹ä¸€ä¸‹æµç¨‹</p>
<h2 id="ç¨‹åºè¿è¡Œæµç¨‹">ç¨‹åºè¿è¡Œæµç¨‹</h2>
<h3 id="ä¸€.-ç¨‹åºå…ˆè§£å¯†äº†å­—ç¬¦ä¸²å¾—åˆ°æ–‡ä»¶åhack.datå¹¶è¯»å–äº†è¿™ä¸ªæ–‡ä»¶">ä¸€. ç¨‹åºå…ˆè§£å¯†äº†å­—ç¬¦ä¸²ï¼Œå¾—åˆ°æ–‡ä»¶åhack.datï¼Œå¹¶è¯»å–äº†è¿™ä¸ªæ–‡ä»¶</h3>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/step1.png" class="">
<figure class="highlight python"><figcaption><span>FileNameè§£å¯†</span></figcaption><table><tr><td class="code"><pre><span class="line">data = [<span class="number">0x06</span>, <span class="number">0x0E</span>, <span class="number">0x13</span>, <span class="number">0x1A</span>, <span class="number">0x5C</span>, <span class="number">0x17</span>, <span class="number">0x15</span>, <span class="number">0x1</span>]</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">    file_name += <span class="built_in">chr</span>(data[i] ^ i + <span class="number">110</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(file_name)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¹Ÿè§£é‡Šäº†ï¼Œç›´æ¥æ‰“å¼€å¤–æŒ‚ä¸ºä»€ä¹ˆä¼šä¸€é—ªè€Œè¿‡</p>
<h3 id="äºŒ.-ç¨‹åºä»hack.daté‡Œè§£å¯†å‡ºæ¸¸æˆè¿›ç¨‹åå¹¶æ‰“å¼€æ¸¸æˆè¿›ç¨‹">äºŒ. ç¨‹åºä»hack.daté‡Œè§£å¯†å‡ºæ¸¸æˆè¿›ç¨‹åï¼Œå¹¶æ‰“å¼€æ¸¸æˆè¿›ç¨‹</h3>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/step2.png" class="">
<p>decryptå‡½æ•°è§£å¯†å‡ºhack.datçš„æ˜æ–‡ï¼Œé€šè¿‡ä¸‹æ ‡æ„é€ å‡ºè¿›ç¨‹åï¼Œç„¶åç”¨<code>CreateToolhelp32Snapshot</code>å’Œ<code>Process32First</code>éå†è¿›ç¨‹ï¼Œæ‰¾åˆ°åæ‰“å¼€è¿›ç¨‹ã€‚</p>
<p>ä»£ç ä¸­æœ‰ä¸€ä¸ªforå¾ªç¯ç›®å‰ä¸å¤ªæ¸…æ¥šæ˜¯å¹²å˜›çš„ã€decryptå‡½æ•°çš„è§£å¯†ç®—æ³•ä¹Ÿå…ˆæ”¾æ”¾ã€‚å…ˆç»§ç»­å¾€ä¸‹çœ‹</p>
<h3 id="ä¸‰.-ç¨‹åºå¼€å§‹æ„é€ flagå¹¶æ£€æŸ¥hack.datçš„å†…å®¹">ä¸‰. ç¨‹åºå¼€å§‹æ„é€ flagï¼Œå¹¶æ£€æŸ¥hack.datçš„å†…å®¹</h3>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/step3.png" class="">
<ol type="1">
<li>ç¬¬ä¸€ä¸ªå¾ªç¯ç”¨äºæ„é€ flagï¼Œè„šæœ¬å¦‚ä¸‹ï¼ˆä¸è§£å¯†FileNameçš„ç®—æ³•ä¸€è‡´ï¼‰</li>
</ol>
<figure class="highlight python"><figcaption><span>flagæ„é€ </span></figcaption><table><tr><td class="code"><pre><span class="line">data = [<span class="number">92</span>, <span class="number">61</span>, <span class="number">35</span>, <span class="number">35</span>, <span class="number">26</span>, <span class="number">1</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">25</span>, <span class="number">32</span>, </span><br><span class="line"><span class="number">12</span>, <span class="number">53</span>, <span class="number">31</span>, <span class="number">55</span>, <span class="number">14</span>, <span class="number">55</span>, <span class="number">61</span>, <span class="number">44</span>, <span class="number">236</span>, <span class="number">213</span>, <span class="number">235</span>, </span><br><span class="line"><span class="number">241</span>, <span class="number">225</span>, <span class="number">255</span>, <span class="number">232</span>, <span class="number">245</span>, <span class="number">252</span>, <span class="number">241</span>, <span class="number">164</span>, <span class="number">228</span>, </span><br><span class="line"><span class="number">233</span>, <span class="number">193</span>, <span class="number">246</span>, <span class="number">250</span>, <span class="number">245</span>, <span class="number">249</span>, <span class="number">235</span>, <span class="number">234</span>, <span class="number">213</span>, </span><br><span class="line"><span class="number">226</span>, <span class="number">244</span>, <span class="number">231</span>, <span class="number">219</span>, <span class="number">214</span>, <span class="number">192</span>, <span class="number">234</span>, <span class="number">172</span>, <span class="number">233</span>, </span><br><span class="line"><span class="number">237</span>, <span class="number">204</span>, <span class="number">151</span>, <span class="number">236</span>, <span class="number">248</span>, <span class="number">218</span>, <span class="number">242</span>, <span class="number">193</span>, <span class="number">233</span>, </span><br><span class="line"><span class="number">242</span>, <span class="number">199</span>, <span class="number">236</span>, <span class="number">146</span>]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">    flag += <span class="built_in">chr</span>(data[i] ^ i + <span class="number">110</span>)</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>ç¬¬äºŒä¸ªå¾ªç¯ç”¨äºæ£€æŸ¥flagä¸hack.datæ˜æ–‡æ˜¯å¦ä¸€è‡´</li>
<li>å¦‚æœä¸€è‡´ï¼Œå°±è§£å¯†å‡º<code>flag%s</code>ï¼ˆæ­¤å¤„çœç•¥è§£å¯†è„šæœ¬ï¼Œä¸è§£å¯†FileNameçš„ç®—æ³•ä¸€è‡´ï¼‰ï¼Œè°ƒç”¨<code>printf</code>è¾“å‡ºflag</li>
</ol>
<h3 id="å››.-æ³¨å…¥dll">å››. æ³¨å…¥DLL</h3>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/step4.png" class="">
<ol type="1">
<li>è§£å¯†DLLæ•°æ®</li>
<li>è¿œç¨‹ç”³è¯·å†…å­˜ï¼Œç”¨äºæ”¾DLL</li>
<li>è§£å¯†ntdll.dllï¼Œä»¥åŠå„ç§DLLæ³¨å…¥éœ€è¦ç”¨åˆ°çš„å‡½æ•°ï¼ˆè§£å¯†ç®—æ³•è¿˜æ˜¯å’Œä¸Šæ–‡ä¸€æ ·ï¼Œå‡½æ•°å¾ˆå¤šï¼Œä¸ä¸€ä¸€å±•ç¤ºäº†ï¼‰</li>
</ol>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/step4-1.png" class="">
<ol start="4" type="1">
<li>ä½¿ç”¨<code>WriteProcessMemory</code>è¿œç¨‹å†™å…¥DLLå†…å®¹ã€æ‰§è¡Œdllçš„æ‰§è¡Œå™¨</li>
</ol>
<p>åˆ°è¿™é‡Œï¼Œå°±èƒ½è§£é‡Šä¸Šæ–‡æ­¥éª¤äºŒä¸­çš„foræ˜¯ç”¨æ¥å¹²å˜›çš„äº†ï¼Œæ˜¯ç”¨æ¥è®¡ç®—dllæ‰§è¡Œå™¨çš„shellcodeçš„é•¿åº¦</p>
<ol start="5" type="1">
<li>ä½¿ç”¨<code>CreateRemoteThreadEx</code>åˆ›å»ºè¿œç¨‹çº¿ç¨‹æ‰§è¡ŒDLLï¼Œå®ç°å¤–æŒ‚åŠŸèƒ½</li>
</ol>
<h2 id="decryptå‡½æ•°åˆ†æ">decryptå‡½æ•°åˆ†æ</h2>
<p>hack.exeä¸­æœ‰ä¸¤å¤„è°ƒç”¨äº†decryptå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯: 1. hack.datæ–‡ä»¶çš„è§£å¯† 2. DLLæ•°æ®çš„è§£å¯†</p>
<p>ç”±äºä¸Šæ–‡å·²ç»çŸ¥é“äº†hack.datè§£å¯†å‡ºæ¥çš„æ˜æ–‡ä¼šä¸flagåšå¯¹æ¯”ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åˆ†ædecryptå‡½æ•°çš„åŠ å¯†ç®—æ³•å°±å¯ä»¥å¾—åˆ°hack.datæ–‡ä»¶ï¼Œä¹Ÿå°±èƒ½æ­£å¸¸å¯åŠ¨å¤–æŒ‚äº†ï¼Œé¡ºä¾¿ä¹Ÿå¯ä»¥dumpå‡ºDLLæ–‡ä»¶</p>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/decrypt.png" class="">
<p>decryptå‡½æ•°æ˜¯ç»è¿‡SSEæŒ‡ä»¤é›†ä¼˜åŒ–åçš„è§£å¯†å‡½æ•°ã€‚</p>
<p>åˆ©ç”¨SSEæŒ‡ä»¤é›†ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªCPUæŒ‡ä»¤æ“ä½œ16byteçš„æ•°æ®ï¼Œæ‰€ä»¥æ­¤å‡½æ•°SSEéƒ¨åˆ†æ¯æ¬¡å¾ªç¯è§£å¯†64byteçš„æ•°æ®ã€‚ å½“è§£å¯†åˆ°ä¸è¶³64byteæ—¶å€™ï¼ˆæˆ–æœ¬èº«å°±ä¸è¶³64byteï¼‰ï¼Œå°±ä½¿ç”¨å¸¸è§„ï¼Œä¸€byteä¸€byteçš„è§£å¯† è§£å¯†ç®—æ³•å¦‚å›¾å·²ç»åˆ†æçš„å¾ˆæ¸…æ¥šäº†ï¼Œä¸‹é¢ä¸Šè§£å¯†è„šæœ¬ï¼Œå°†flagåå‘è¾“å‡ºæˆhack.dat</p>
<figure class="highlight python"><figcaption><span>è¾“å‡ºhack.dat</span></figcaption><table><tr><td class="code"><pre><span class="line">flag = <span class="string">&#x27;2RSRhrofoWtLeLrJCSlTireznrtx.oeLxuehyyAwbpCOZq0tsS7MZyVdOUoE8&#x27;</span></span><br><span class="line"></span><br><span class="line">data = [<span class="built_in">ord</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> flag]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">    data[i] = (data[i] + <span class="number">0x13</span>) ^ <span class="number">0x3F</span></span><br><span class="line">    </span><br><span class="line">fp = <span class="built_in">open</span>(<span class="string">&quot;hack.dat&quot;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">fp.write(<span class="built_in">bytes</span>(data))</span><br><span class="line">fp.close()</span><br></pre></td></tr></table></figure>
<p>æŠŠè¾“å‡ºçš„hack.datæ”¾åœ¨hack.exeç›®å½•ä¸‹ï¼Œè¿è¡Œhack.exe</p>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/flag.png" class="">
<p>æˆåŠŸè¾“å‡ºflag</p>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/feature.png" class="">
<p>æˆåŠŸæ‰§è¡Œå¤–æŒ‚åŠŸèƒ½ï¼Œè¯•äº†ä¸€ä¸‹ï¼Œé¼ æ ‡å³é”®å¯ä»¥è‡ªç„</p>
<h2 id="dumpå¤–æŒ‚dll">Dumpå¤–æŒ‚DLL</h2>
<p>ç”±äºå·²ç»ææ‡‚äº†decryptå‡½æ•°çš„ç®—æ³•ï¼Œå°†DLLç»™dumpå‡ºæ¥å°±å¾ˆç®€å•äº†ï¼Œæ—¢å¯ä»¥åŠ¨æ€è°ƒè¯•ã€ä¹Ÿå¯ä»¥é™æ€çš„ä½¿ç”¨IDAPythonè„šæœ¬è§£å¯†åè¾“å‡º</p>
<p>æˆ‘è¿™æ¬¡ä½¿ç”¨è„šæœ¬</p>
<figure class="highlight python"><figcaption><span>dump DLL</span></figcaption><table><tr><td class="code"><pre><span class="line">start_addr = <span class="number">0x14001DA40</span></span><br><span class="line"><span class="built_in">len</span> = <span class="number">0xFA00</span></span><br><span class="line">data = ida_bytes.get_bytes(start_addr, <span class="built_in">len</span>)</span><br><span class="line">dll = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>):</span><br><span class="line">    dll.append((data[i] ^ <span class="number">0x3F</span>) - <span class="number">0x13</span> &amp; <span class="number">0xFF</span>)</span><br><span class="line"></span><br><span class="line">fp = <span class="built_in">open</span>(<span class="string">&quot;D:\\dump.dll&quot;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">fp.write(<span class="built_in">bytes</span>(dll))</span><br><span class="line">fp.close()</span><br></pre></td></tr></table></figure>
<h2 id="å°æ€»ç»“">å°æ€»ç»“</h2>
<p>dumpå‡ºæ¥åï¼Œä¸‹é¢å°±å¯ä»¥åˆ†æå¤–æŒ‚åŠŸèƒ½çš„å…·ä½“å®ç°</p>
<h1 id="åˆ†ædump.dll">åˆ†ædump.dll</h1>
<p>æ— å£³ï¼Œç›´æ¥æ‹–å…¥IDAåˆ†æ</p>
<h2 id="ç¨‹åºè¿è¡Œæµç¨‹-1">ç¨‹åºè¿è¡Œæµç¨‹</h2>
<p>DllMainåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹é‡Œæ”¾ç€ä¸»æµç¨‹</p>
<h3 id="ä¸€.-ç¨‹åºå…ˆè·å–æ¸¸æˆä¸»æ¨¡å—åˆå§‹åŒ–å„ç§å…¨å±€å˜é‡">ä¸€. ç¨‹åºå…ˆè·å–æ¸¸æˆä¸»æ¨¡å—ï¼Œåˆå§‹åŒ–å„ç§å…¨å±€å˜é‡</h3>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/base-ptr.png" class="">
<p>æ ¹æ®ä¸»æ¨¡å—+åŸºå€åç§»ï¼Œè·å¾—WorldæŒ‡é’ˆã€ä¸‰ç»´xyzè½¬å±å¹•xyçš„å‡½æ•°åœ°å€ã€ä»¥åŠæ¸¸æˆtickå‡½æ•°åœ°å€ç­‰ç­‰</p>
<h2 id="äºŒ.-ç„¶åhookingæ¸¸æˆtickå‡½æ•°å°†è‡ªç„åŠŸèƒ½å®ç°åœ¨hookå‡½æ•°é‡Œ">äºŒ. ç„¶åHookingæ¸¸æˆtickå‡½æ•°ï¼Œå°†è‡ªç„åŠŸèƒ½å®ç°åœ¨Hookå‡½æ•°é‡Œ</h2>
<p>64ä½inline Hookï¼Œè¿™é‡Œåº”è¯¥ç”¨äº†æŸHookåº“ï¼Œæ¯”è¾ƒå¤æ‚ã€‚åŸç†æ˜¯ä¿®æ”¹åŸå‡½æ•°å…¥å£ï¼ŒJMPåˆ°Hookå‡½æ•°é‡Œï¼Œä¹Ÿå®ç°äº†è¹¦åºŠï¼Œè¿™é‡Œå°±ä¸å…·ä½“åˆ†æäº†ï¼Œçœ‹ä¸€ä¸‹Hookä¿®æ”¹åŸå‡½æ•°å…¥å£çš„æ ¸å¿ƒä»£ç å°±è¡Œï¼Œå¦‚ä¸‹å›¾</p>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/hook.png" class="">
<h2 id="ä¸‰.-æœ€åå®ç°è‡ªç„åŠŸèƒ½">ä¸‰. æœ€åå®ç°è‡ªç„åŠŸèƒ½</h2>
<p>è¿™é‡Œæ˜¯æœ¬DLLçš„é‡ç‚¹ï¼Œè‡ªç„åŠŸèƒ½çš„å®ç°åˆåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤</p>
<ol type="1">
<li>æ ¹æ®åŸºå€åç§»è·å–<code>player_controller</code>å¯¹è±¡</li>
</ol>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/player-controller.png" class="">
<ol start="2" type="1">
<li>åˆ¤æ–­é¼ æ ‡å³é”®æ˜¯å¦æŒ‰ä¸‹ï¼Œå¦‚æœæŒ‰ä¸‹å°±è°ƒç”¨<code>get_target</code>å‡½æ•°å°è¯•åŒ¹é…ä¸€ä¸ªæ•Œäºº</li>
</ol>
<p><code>get_target</code>å‡½æ•°åˆ†æå¦‚ä¸‹</p>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/foreach-objs.png" class="">
<p>éå†å¯¹è±¡æ•°ç»„ï¼Œå¹¶æ’é™¤è‡ªå·±ã€‚è·å–æ¯ä¸ªå¯¹è±¡åå­—ï¼Œå¹¶æ’é™¤ç‰©å“ã€æ­¦å™¨ç­‰å¯¹è±¡</p>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/get-target.png" class="">
<p>è®¡ç®—æ¯ä¸ªæ•Œäººä¸å‡†å¿ƒçš„è·ç¦»ï¼Œå–è·ç¦»å‡†å¿ƒæœ€è¿‘çš„ä¸€ä¸ªæ•Œäººè¿”å›</p>
<ol start="3" type="1">
<li>è·å–è‡ªå·±å’Œæ•Œäººçš„åæ ‡</li>
</ol>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/get-pos.png" class="">
<ol start="4" type="1">
<li>è®¡ç®—ç›¸å¯¹è·ç¦»ï¼Œæ±‚ä¿¯ä»°è§’å’Œåèˆªè§’ï¼Œç„¶åå°†æ•°æ®å†™å…¥åˆ°ç©å®¶Carmé‡Œï¼Œå®ç°è‡ªç„</li>
</ol>
<img data-src="/2021/04/22/gslab-ctf-finals-pc-writeup/end.png" class="">
<h2 id="å°æ€»ç»“-1">å°æ€»ç»“</h2>
<p>è‡ªæ­¤å¤§æ¦‚å°±æ˜ç™½äº†æ­¤DLLæ˜¯å¦‚ä½•å®ç°è‡ªç„çš„äº†ï¼Œå±äºä¼ ç»Ÿçš„å†…éƒ¨æ”»å‡»</p>
<h1 id="å®ç°ä¸hack.exeå¤–æŒ‚åŠŸèƒ½ç›¸åŒçš„ç¨‹åº">å®ç°ä¸hack.exeå¤–æŒ‚åŠŸèƒ½ç›¸åŒçš„ç¨‹åº</h1>
<p>ç­‰æœ‰æ—¶é—´äº†å†å†™...</p>
]]></content>
      <categories>
        <category>é€†å‘</category>
      </categories>
      <tags>
        <tag>é€†å‘</tag>
        <tag>IDA Pro</tag>
        <tag>x64dbg</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>2021è…¾è®¯æ¸¸æˆå®‰å…¨æŠ€æœ¯ç«èµ› åˆèµ›PCå®¢æˆ·ç«¯writeup</title>
    <url>/2021/04/06/gslab-ctf-preliminaries-pc-writeup/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>æ˜¨å¤©ç©è„‰è„‰æœ‰è€å“¥å»ºè®®æˆ‘å¯ä»¥ç©ç©CTFï¼Œç¡®å®å¯ä»¥è¯•ä¸€è¯•ï¼Œæœäº†ä¸€ä¸‹æœ€è¿‘çš„CTFï¼Œæ­£å¥½è…¾è®¯æœ‰ä¸€ä¸ª<a href="https://gslab.qq.com/html/competition/2021/index.htm">å®‰å…¨æŠ€æœ¯ç«èµ›</a>ã€‚</p>
<p>è™½ç„¶é”™è¿‡äº†æŠ¥åæ—¶é—´ï¼Œä½†<a href="https://gslab.qq.com/html/competition/2021/doc/PC%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%A2%98%E7%9B%AE.zip">PCåˆèµ›èµ›é¢˜</a>è¿˜æ˜¯å¯ä»¥ä¸‹è½½ä¸‹æ¥åšçš„</p>
<p>åˆ†æäº†ä¸€ä¸Šåˆï¼Œè¿™é‡Œå†™ä¸€ä¸ªç®€é™‹çš„writeup</p>
<a id="more"></a>
<h1 id="èµ›é¢˜">èµ›é¢˜</h1>
<h3 id="peä¿¡æ¯">PEä¿¡æ¯</h3>
<p>32ä½ï¼Œæ— å£³ï¼ŒVC++ï¼Œè·‘èµ·æ¥åå‘ç°æœ‰åŠ è½½OpenGLåŠ¨æ€åº“</p>
<h3 id="ç›®æ ‡">ç›®æ ‡</h3>
<p>ç¨‹åºä¸­è—æœ‰ä¸€ä¸ªä»¥"flag"å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚è¦æ±‚æ‰¾å‡ºè¯¥å­—ç¬¦ä¸²</p>
<h3 id="ç®€å•æè¿°">ç®€å•æè¿°</h3>
<p>è¿è¡Œèµ·æ¥å</p>
<ul>
<li>æ¸²æŸ“äº†ä¸€ä¸ªç®­å¤´ï¼Œå¹¶æŒ‡å‘å³ä¸Šè§’</li>
<li>è§†è§’æœ‰é™åˆ¶ï¼Œæ— æ³•ç§»å‡ºç®­å¤´çš„è§†é‡</li>
</ul>
<img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/subject.png" class="">
<h1 id="åšé¢˜è¿‡ç¨‹">åšé¢˜è¿‡ç¨‹</h1>
<h3 id="å°è¯•è§£é”è§†è§’">å°è¯•è§£é”è§†è§’</h3>
<p>ç¬¬ä¸€æ„Ÿè§‰è¿™ä¸ªç®­å¤´æ˜¯æç¤ºï¼ŒæŒ‡å‘æ­£ç¡®çš„flagã€‚ä½†è§†è§’è¢«å¡äº†ï¼Œæ‰€ä»¥å…ˆè¯•è¯•è§£é”è§†è§’</p>
<p>è§†è§’æ˜¯æ ¹æ®é¼ æ ‡çš„ç§»åŠ¨æ¥ç§»åŠ¨çš„ï¼Œç†Ÿæ‚‰Windowsæ¶ˆæ¯æœºåˆ¶çš„è¯ï¼Œå°±çŸ¥é“å…ˆå»æ‰¾çª—å£æ³¨å†Œçš„å‡½æ•°ï¼Œé‚£é‡Œæœ‰WndProcå‡½æ•°ï¼Œè´Ÿè´£å¤„ç†å„ç§æ¶ˆæ¯ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬é¼ æ ‡æ¶ˆæ¯</p>
<p>IDAè½½å…¥ï¼Œæ‰“å¼€Structuresè§†å›¾ï¼Œæ‰¾åˆ°<code>WNDCLASSEXW</code>ç»“æ„ä½“ï¼ŒæŒ‰ä¸‹Xæ‰¾åˆ°ç»‘å®šçš„WndProcå‡½æ•°ã€‚</p>
<p>ç„¶åç»§ç»­æ‰¾åˆ°å¯¹åº”çš„é¼ æ ‡ç§»åŠ¨æ—¶é—´çš„å¤„ç†å‡½æ•°ï¼Œå‘ç°ç¡®å®æœ‰é™åˆ¶</p>
<img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/limit-code.png" class="">
<p>åˆ°x32dbgé‡Œï¼ŒNOPæ‰å¯¹åº”çš„if</p>
<img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/limit-asm.png" class="">
<p>OKï¼Œç°åœ¨å¯ä»¥è‡ªç”±çš„è½¬åŠ¨è§†è§’äº†ï¼Œä½†è½¬äº†ä¸€åœˆä¹Ÿæ²¡å‘ç°flagï¼Œæœç„¶ä¸å¯èƒ½è¿™ä¹ˆç®€å•ï¼Œå“ˆå“ˆ</p>
<p>ä½†ç®­å¤´å³ä¸Šè§’ç¡®å®æœ‰ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿ï¼Œè²Œä¼¼æ˜¯ä¸€å †ç®±å­ç»„æˆçš„æ–‡å­—ï¼Ÿè¿™å¯èƒ½æ‰æ˜¯æˆ‘ä»¬è¦çš„ç­”æ¡ˆ</p>
<img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/without-limit.png" class="">
<h3 id="é™æ€åˆ†ææ¸²æŸ“æµç¨‹">é™æ€åˆ†ææ¸²æŸ“æµç¨‹</h3>
<p>æ— å¥ˆåªèƒ½æ·±å…¥çœ‹ä¸€ä¸‹OpenGLçš„ä»£ç ç»†èŠ‚äº†ï¼Œä¹‹å‰æ²¡æ¥è§¦è¿‡OpenGLï¼Œé¡ºä¾¿æ‰¾äº†ä¸ªæ•™ç¨‹å¯¹ç€å­¦</p>
<ol type="1">
<li>è®¾ç½®é¡¶ç‚¹æ•°æ® <img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/attrib-code.png" class=""></li>
</ol>
<p>ä¸€ä¸ªç«‹æ–¹ä½“æœ‰6ä¸ªé¢ï¼Œæ¯ä¸ªé¢æœ‰2ä¸ªä¸‰è§’å½¢ï¼Œæ‰€ä»¥éœ€è¦2 * 3 * 6 = 36ä¸ªé¡¶ç‚¹</p>
<ol start="2" type="1">
<li><p>è®¾ç½®è´´å›¾çº¹ç† <img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/pixele-code.png" class=""></p></li>
<li><p>è®¾ç½®projectionã€viewã€model 3ä¸ªå˜æ¢çŸ©é˜µå¹¶ç»˜åˆ¶ç•Œé¢</p></li>
</ol>
<p>ç¨‹åºå…ˆè®¾ç½®å¥½è®¾ç½®projectionå’Œviewï¼Œè€Œåä½¿ç”¨å¾ªç¯è®¾ç½®modelä»¥åŠ<code>glDrawArrays</code></p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘çŒœæµ‹è¿™é‡Œå°±æ˜¯åœ¨å¾ªç¯çš„å›æ‰§ç«‹æ–¹ä½“ï¼Œæœ€ç»ˆå½¢æˆä¸€ä¸ªç®­å¤´çš„å½¢çŠ¶ï¼ŒåŒ…æ‹¬ä¹‹å‰çœ‹åˆ°çš„å¥‡æ€ªçš„ä¸œè¥¿</p>
<img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/model-loop-code.png" class="">
<p>dword_466020å’Œdword_46601Cåº”è¯¥æ˜¯è®°å½•äº†ä¸‰ç»´å‘é‡è¡¨çš„å¼€å¤´å’Œç»“å°¾</p>
<h3 id="åŠ¨æ€è°ƒè¯•éªŒè¯">åŠ¨æ€è°ƒè¯•éªŒè¯</h3>
<p>åˆ°x32dbgé‡Œï¼Œæˆ‘ä»¬æ‰¾åˆ°æ¸²æŸ“ç«‹æ–¹ä½“çš„åœ°æ–¹ï¼Œä¸‹æ–­</p>
<img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/model-loop-asm.png" class="">
<p>é‡æ–°è¿è¡Œç¨‹åºï¼Œæ–¹ä¾¿æ‰¾åˆ°å‘é‡è¡¨çš„å¼€å¤´</p>
<img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/matrix.png" class="">
<p>è¯•è¯•çœ‹æ¸…ç©ºæ•°æ®ï¼Œå‘ç°å°‘äº†ä¸€äº›ç«‹æ–¹ä½“</p>
<img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/empty.png" class="">
<p>æˆ‘ä»¬F4è¿è¡Œåˆ°å¾ªç¯å¤–ï¼Œå‘ç°æ•°ç»„é•¿åº¦0xBF1ï¼Œä¹Ÿå°±æ˜¯3057</p>
<img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/loop-end-asm.png" class="">
<p>å› ä¸ºæ¯æ¬¡æ¸²æŸ“ä¼šå–xyzä¸‰ä¸ªfloatï¼Œä¹Ÿå°±æ˜¯è¯´å¾ªç¯çš„å¢é‡æ˜¯i+=3ï¼Œ3057/3 = 1019</p>
<p>ä¹Ÿå°±æ˜¯è¯´ä¸€å…±æœ‰1019ä¸ªç«‹æ–¹ä½“</p>
<p>æˆ‘ä»¬æŠŠè¿™äº›æ•°æ®æå–å‡ºæ¥ï¼Œç„¶åç¼–å†™ä¸ªDX9ç¨‹åºç»˜åˆ¶ä¸€ä¸‹å³å¯</p>
<img data-src="/2021/04/06/gslab-ctf-preliminaries-pc-writeup/flag.png" class="">
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>éš¾åº¦ä¸æ˜¯å¾ˆå¤§ï¼Œä½†è¿˜æ˜¯éœ€è¦ç‚¹è€å¿ƒçš„ï¼Œç‰¹åˆ«æ˜¯æˆ‘è¿™ç§ä¸ä¼šOpenGLçš„</p>
<p>é¡ºä¾¿ä¹Ÿæ˜¯å­¦ä¹ äº†ä¸€äº›OpenGLç›¸å…³çŸ¥è¯†å§ï¼Œé¡¶ç‚¹ã€é¡¶ç‚¹ç¼“å†²å¯¹è±¡ã€ç€è‰²å™¨ã€è´´å›¾çº¹ç†ç­‰ç­‰...</p>
]]></content>
      <categories>
        <category>é€†å‘</category>
      </categories>
      <tags>
        <tag>é€†å‘</tag>
        <tag>IDA Pro</tag>
        <tag>x64dbg</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>å¯¼å…¥åœ°å€è¡¨ï¼ˆIATï¼‰Hook</title>
    <url>/2021/03/05/iat-hook/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>åœ¨ä¸Šä¸€ä¸ªHookæ–‡ç« ä¸­ï¼Œæˆ‘åˆ©ç”¨C++è™šå‡½æ•°çš„ç‰¹æ€§ï¼Œå®ç°äº†<a href="/2020/12/07/vmt-hook/">è™šå‡½æ•°è¡¨é’©å­ï¼ˆVMT Hookï¼‰</a>ã€‚</p>
<p>VMT Hookå®ç°èµ·æ¥ç®€å•ï¼Œä½†ä½¿ç”¨èŒƒå›´æœ‰é™ã€‚åªèƒ½ç”¨æ¥æŒ‚é’©æœ‰è™šå‡½æ•°çš„å¯¹è±¡ã€‚</p>
<p>ä»Šå¤©ä»‹ç»ä¸€ä¸ªé€‚ç”¨èŒƒå›´ç›¸å¯¹æ›´å¹¿ä¸€äº›çš„HookæŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯å¯¼å…¥åœ°å€è¡¨ï¼ˆIATï¼‰Hookã€‚</p>
<h1 id="ä»€ä¹ˆæ˜¯iat">ä»€ä¹ˆæ˜¯IAT?</h1>
<p>å¦‚æœä½ ç†Ÿæ‚‰ç¨‹åºç¼–è¯‘çš„è¿‡ç¨‹ï¼Œä½ ä¼šçŸ¥é“é“¾æ¥åˆ†ä¸ºä¸¤ç§ï¼š - é™æ€é“¾æ¥ï¼šä»£ç ä»å…¶æ‰€åœ¨çš„é™æ€é“¾æ¥åº“ä¸­æ‹·è´åˆ°æœ€ç»ˆçš„å¯æ‰§è¡Œç¨‹åºä¸­ï¼Œåœ¨ç¨‹åºè¢«æ‰§è¡Œæ—¶ï¼Œè¿™äº›ä»£ç ä¼šè¢«è£…å…¥åˆ°è¯¥è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ - åŠ¨æ€é“¾æ¥ï¼šä»£ç è¢«æ”¾åˆ°åŠ¨æ€é“¾æ¥åº“ä¸­ï¼Œåœ¨ç¨‹åºæ‰§è¡Œæ—¶ï¼ŒåŠ¨æ€é“¾æ¥åº“çš„å…¨éƒ¨å†…å®¹ä¼šè¢«æ˜ å°„åˆ°è¿è¡Œæ—¶ç›¸åº”è¿›è¡Œçš„è™šæ‹Ÿåœ°å€çš„ç©ºé—´</p>
<p>è€ŒIATï¼ˆå¯¼å…¥åœ°å€è¡¨ï¼‰å°±æ˜¯åŠ¨æ€é“¾æ¥çš„å®ç°æ–¹æ³•ã€‚</p>
<a id="more"></a>
<p>PEæ ‡å¤´åŒ…å«è®¸å¤šæ•°æ®è¡¨ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸åŒä¿¡æ¯ã€‚è€ŒIATé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¿å­˜äº†å¤–éƒ¨çš„åŠ¨æ€é“¾æ¥åº“ä¸­å¯¼å‡ºå‡½æ•°åœ°å€çš„è¡¨ã€‚</p>
<p>åœ¨è¿è¡Œæ—¶ï¼Œæ“ä½œç³»ç»Ÿè§£æå¯¼å…¥è¡¨ï¼Œå°è¯•åŠ è½½æŒ‡å®šçš„dllå¹¶è§£æå¯¼å…¥å‡½æ•°çš„åœ°å€ã€‚å¦‚æœæ­¤è¿‡ç¨‹å¤±è´¥ï¼Œåˆ™ç¨‹åºå°†æ— æ³•åŠ è½½</p>
<img data-src="/2021/03/05/iat-hook/sys_err.png" class="">
<blockquote>
<p>ä¸Šå›¾æç¤ºï¼Œæ‰¾ä¸åˆ°VC++è¿è¡Œåº“</p>
</blockquote>
<h2 id="æ”»å‡»æ–¹æ³•">æ”»å‡»æ–¹æ³•</h2>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸¤ç§æ–¹æ³•æ¥æ”»å‡»å®ƒï¼š 1. ç›´æ¥ç¯¡æ”¹å¯æ‰§è¡Œç¨‹åºçš„æ–‡ä»¶ï¼ˆä¸æ¨èï¼Œå› ä¸ºå¦‚ä»Šå¤§å¤šæ•°ç¨‹åºéƒ½æœ‰ç­¾åï¼Œå¤§å¤šæ•°æ€è½¯ä¼šæ ‡è®°è¢«ç¯¡æ”¹è¿‡çš„ç¨‹åºï¼‰ 2. åœ¨è¿è¡Œæ—¶æ³¨å…¥ä»£ç å¹¶ä¿®æ”¹IAT</p>
<p>é€šè¿‡åœ¨è¿è¡Œæ—¶æ³¨å…¥ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…åœ¨ç¡¬ç›˜ä¸Šç•™ä¸‹ç—•è¿¹ã€‚å°½ç®¡ä»ç„¶å¯èƒ½ä¼šè¢«æ£€æµ‹åˆ°ï¼Œä½†ä¸ç›´æ¥ç¯¡æ”¹æ–‡ä»¶ç›¸æ¯”ï¼Œå®‰å…¨å¾—å¤šã€‚</p>
<h1 id="å®ç°">å®ç°</h1>
<p>å…ˆä»åŸºç¡€å¼€å§‹ï¼Œå…ˆå°è¯•Hookæˆ‘ä»¬è‡ªå·±çš„è¿›ç¨‹IATã€‚ç”¨æˆ‘ä»¬è‡ªå·±çš„å‡½æ•°è¦†ç›–<code>Kernel32!Sleep</code>çš„åœ°å€ã€‚</p>
<h2 id="å®šä¹‰æ¡†æ¶">å®šä¹‰æ¡†æ¶</h2>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºRVAï¼ˆç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼‰è½¬VAï¼ˆè™šæ‹Ÿåœ°å€ï¼‰</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T <span class="title">rva_to_va</span><span class="params">(<span class="type">void</span>* base, <span class="type">ptrdiff_t</span> rva)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(std::is_pointer&lt;T&gt;::value, <span class="string">&quot;rva_to_va return type must be a pointer.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;T&gt;(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(base) + rva);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºä¿å­˜åŸå§‹å‡½æ•°çš„åœ°å€</span></span><br><span class="line"><span class="keyword">using</span> <span class="type">sleep_t</span> = <span class="type">void</span>* (WINAPI*)(DWORD);</span><br><span class="line"><span class="type">sleep_t</span> original_sleep;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ‘ä»¬çš„é’©å­å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">void</span> WINAPI <span class="title">my_sleep</span><span class="params">(DWORD ms)</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">hook_iat</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* module_name, <span class="type">const</span> <span class="type">char</span>* function_name, <span class="type">void</span>* hook_func, <span class="type">void</span>** original_func)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span>* original_func;</span><br><span class="line">    <span class="built_in">hook_iat</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;Sleep&quot;</span>, my_sleep, &amp;original_func);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="peæ ‡å¤´">PEæ ‡å¤´</h2>
<p>MSDNä¸Šçš„<a href="https://docs.microsoft.com/zh-cn/windows/win32/debug/pe-format">PEæ ¼å¼</a>æ–‡æ¡£</p>
<p>æœ¬æ–‡å‡å®šä½ ç†Ÿæ‚‰PEæ ¼å¼ä¸­çš„IATéƒ¨åˆ†ã€‚</p>
<p>æˆ‘ä»¬è¦åˆ†æIATï¼Œæ‰€ä»¥å¾—åœ¨æ ‡å¤´ä¸­å®šä½IAT</p>
<p>é¦–å…ˆå¾—è·å¾—æŒ‡å‘PE Headerå¼€å¤´çš„æŒ‡é’ˆ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–DOSå¤´æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">auto</span> dos_header = <span class="built_in">reinterpret_cast</span>&lt;IMAGE_DOS_HEADER*&gt;(<span class="built_in">GetModuleHandle</span>(<span class="literal">nullptr</span>));</span><br><span class="line"><span class="comment">// è·å–NTå¤´æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">auto</span> nt_header = <span class="built_in">rva_to_va</span>&lt;IMAGE_NT_HEADERS*&gt;(dos_header, dos_header-&gt;e_lfanew);</span><br><span class="line"><span class="comment">// ç‰¹åˆ¤ï¼Œä¿è¯è·å–åˆ°äº†æœ‰æ•ˆçš„NTå¤´æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">if</span> (nt_header-&gt;Signature != IMAGE_NT_SIGNATURE)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å¯¼å…¥æè¿°ç¬¦æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">auto</span> import_descriptors = <span class="built_in">rva_to_va</span>&lt;IMAGE_IMPORT_DESCRIPTOR*&gt;(dos_header, </span><br><span class="line">    nt_header-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress);</span><br><span class="line"><span class="comment">// å¾ªç¯è§£æå¯¼å…¥æè¿°ç¬¦ä¸­çš„æ¡ç›®</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; import_descriptors[i].Characteristics != <span class="number">0</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// è·å¾—æ¨¡å—åï¼Œå¹¶è¾“å‡º</span></span><br><span class="line">    <span class="keyword">auto</span> dll_name = <span class="built_in">rva_to_va</span>&lt;<span class="type">char</span>*&gt;(dos_header, import_descriptors[i].Name);</span><br><span class="line">    std::cout &lt;&lt; dll_name &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœç¼–è¯‘å¹¶è¿è¡Œè¯¥ä»£ç ï¼Œåˆ™ä¼šæ‰“å°ä½ çš„è¿›ç¨‹ä½¿ç”¨çš„æ‰€æœ‰å¯¼å…¥æ¨¡å—ï¼ˆå¯èƒ½å› ç¼–è¯‘å™¨è€Œå¼‚ï¼‰: <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">KERNEL32.dll</span><br><span class="line">MSVCP140D.dll</span><br><span class="line">VCRUNTIME140D.dll</span><br><span class="line">ucrtbased.dll</span><br></pre></td></tr></table></figure></p>
<p>æ‰¾åˆ°äº†æ‰€æœ‰æ¨¡å—åï¼Œå°±å¯ä»¥å¼€å§‹æ‰¾å‡½æ•°äº†</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; import_descriptors[i].Characteristics != <span class="number">0</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">auto</span> dll_name = <span class="built_in">rva_to_va</span>&lt;<span class="type">char</span>*&gt;(dos_header, import_descriptors[i].Name);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&#x27;[&#x27;</span> &lt;&lt; dll_name &lt;&lt; <span class="string">&#x27;]&#x27;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!import_descriptors[i].FirstThunk || !import_descriptors[i].OriginalFirstThunk)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> thunk = <span class="built_in">rva_to_va</span>&lt;IMAGE_THUNK_DATA*&gt;(dos_header, import_descriptors[i].FirstThunk);</span><br><span class="line">    <span class="keyword">auto</span> original_thunk = <span class="built_in">rva_to_va</span>&lt;IMAGE_THUNK_DATA*&gt;(dos_header, import_descriptors[i].OriginalFirstThunk);</span><br><span class="line">    <span class="keyword">for</span> (; original_thunk-&gt;u1.Function; original_thunk++, thunk++) &#123;</span><br><span class="line">        <span class="comment">// è·³è¿‡é€šè¿‡åºæ•°å¯¼å…¥çš„</span></span><br><span class="line">        <span class="keyword">if</span> (original_thunk-&gt;u1.Ordinal &amp; IMAGE_ORDINAL_FLAG)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> <span class="keyword">import</span> = <span class="built_in">rva_to_va</span>&lt;IMAGE_IMPORT_BY_NAME*&gt;(dos_header, original_thunk-&gt;u1.AddressOfData);</span><br><span class="line">        std::cout &lt;&lt; <span class="keyword">import</span>-&gt;Name &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºï¼š <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[KERNEL32.dll]</span><br><span class="line">GetModuleHandleW</span><br><span class="line">FreeLibrary</span><br><span class="line">VirtualQuery</span><br><span class="line">GetProcessHeap</span><br><span class="line">HeapFree</span><br><span class="line">HeapAlloc</span><br><span class="line">GetLastError</span><br><span class="line">GetStartupInfoW</span><br><span class="line">InitializeSListHead</span><br><span class="line">GetSystemTimeAsFileTime</span><br><span class="line">GetCurrentProcessId</span><br><span class="line">QueryPerformanceCounter</span><br><span class="line">IsProcessorFeaturePresent</span><br><span class="line">TerminateProcess</span><br><span class="line">GetCurrentProcess</span><br><span class="line">SetUnhandledExceptionFilter</span><br><span class="line">UnhandledExceptionFilter</span><br><span class="line">WideCharToMultiByte</span><br><span class="line">MultiByteToWideChar</span><br><span class="line">RaiseException</span><br><span class="line">IsDebuggerPresent</span><br><span class="line">GetCurrentThreadId</span><br><span class="line">GetProcAddress</span><br><span class="line">Sleep</span><br><span class="line">TerminateProcess</span><br><span class="line">TlsGetValue</span><br><span class="line">UnhandledExceptionFilter</span><br><span class="line">VirtualProtect</span><br><span class="line">VirtualQuery</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>OKï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ‰¾åˆ°äº†å¯¹åº”æ¨¡å—çš„å¯¼å…¥å‡½æ•°ã€‚ä¸‹é¢å°±æ˜¯é€šè¿‡ä¿®æ”¹å¯¼å…¥è¡¨æ¥å®ç°IAT Hook</p>
<h2 id="å®ç°iat-hook">å®ç°IAT Hook</h2>
<p>ä¿®æ”¹IATå¾ˆç®€å•ï¼Œæ‰¾åˆ°éœ€è¦ä¿®æ”¹çš„å‡½æ•°åï¼Œä½¿ç”¨<code>VirtualProtect</code>å»é™¤å†…å­˜ä¿æŠ¤ï¼Œå†™å…¥æ–°åœ°å€ï¼Œç„¶åå†æ¢å¤å†…å­˜ä¿æŠ¤</p>
<p>å®Œæ•´çš„Hook IATå‡½æ•°ï¼š <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">hook_iat</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* module_name, <span class="type">const</span> <span class="type">char</span>* function_name, <span class="type">void</span>* hook_func, <span class="type">void</span>** original_func)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–DOSå¤´æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">auto</span> dos_header = <span class="built_in">reinterpret_cast</span>&lt;IMAGE_DOS_HEADER*&gt;(<span class="built_in">GetModuleHandle</span>(<span class="literal">nullptr</span>));</span><br><span class="line">    <span class="comment">// è·å–NTå¤´æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">auto</span> nt_header = <span class="built_in">rva_to_va</span>&lt;IMAGE_NT_HEADERS*&gt;(dos_header, dos_header-&gt;e_lfanew);</span><br><span class="line">    <span class="comment">// ç‰¹åˆ¤ï¼Œä¿è¯è·å–åˆ°äº†æœ‰æ•ˆçš„NTå¤´æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (nt_header-&gt;Signature != IMAGE_NT_SIGNATURE)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å¯¼å…¥æè¿°ç¬¦æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">auto</span> import_descriptors = <span class="built_in">rva_to_va</span>&lt;IMAGE_IMPORT_DESCRIPTOR*&gt;(dos_header,</span><br><span class="line">        nt_header-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯è§£æå¯¼å…¥æè¿°ç¬¦ä¸­çš„æ¡ç›®</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; import_descriptors[i].Characteristics != <span class="number">0</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">auto</span> dll_name = <span class="built_in">rva_to_va</span>&lt;<span class="type">char</span>*&gt;(dos_header, import_descriptors[i].Name);</span><br><span class="line">        <span class="comment">// å¦‚æœä¸æ˜¯æˆ‘ä»¬è¦æ‰¾çš„æ¨¡å—ï¼Œå°±è·³è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> (_strcmpi(dll_name, module_name) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (!import_descriptors[i].FirstThunk || !import_descriptors[i].OriginalFirstThunk)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">auto</span> thunk = <span class="built_in">rva_to_va</span>&lt;IMAGE_THUNK_DATA*&gt;(dos_header, import_descriptors[i].FirstThunk);</span><br><span class="line">        <span class="keyword">auto</span> original_thunk = <span class="built_in">rva_to_va</span>&lt;IMAGE_THUNK_DATA*&gt;(dos_header, import_descriptors[i].OriginalFirstThunk);</span><br><span class="line">        <span class="keyword">for</span> (; original_thunk-&gt;u1.Function; original_thunk++, thunk++) &#123;</span><br><span class="line">            <span class="comment">// è·³è¿‡é€šè¿‡åºæ•°å¯¼å…¥çš„</span></span><br><span class="line">            <span class="keyword">if</span> (original_thunk-&gt;u1.Ordinal &amp; IMAGE_ORDINAL_FLAG)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">auto</span> <span class="keyword">import</span> = <span class="built_in">rva_to_va</span>&lt;IMAGE_IMPORT_BY_NAME*&gt;(dos_header, original_thunk-&gt;u1.AddressOfData);</span><br><span class="line">            <span class="comment">// å¦‚æœä¸æ˜¯æˆ‘ä»¬è¦æ‰¾çš„å‡½æ•°ï¼Œå°±è·³è¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (_strcmpi(function_name, <span class="keyword">import</span>-&gt;Name) != <span class="number">0</span>)</span><br><span class="line">			    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ‰¾åˆ°äº†æˆ‘ä»¬è¦Hookçš„å‡½æ•°</span></span><br><span class="line">            <span class="comment">// å…ˆå°†å†…å­˜ä¿æŠ¤æ”¹ä¸ºå¯å†™å…¥</span></span><br><span class="line">            MEMORY_BASIC_INFORMATION mbi;</span><br><span class="line">            <span class="built_in">VirtualQuery</span>(thunk, &amp;mbi, <span class="built_in">sizeof</span>(mbi));</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">VirtualProtect</span>(mbi.BaseAddress, mbi.RegionSize, PAGE_EXECUTE_READWRITE, &amp;mbi.Protect))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¿å­˜åŸå‡½æ•°åœ°å€</span></span><br><span class="line">            *original_func = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(thunk-&gt;u1.Function);</span><br><span class="line">            <span class="comment">// å°†Hookå‡½æ•°åœ°å€è¦†ç›–ä¸Šå»</span></span><br><span class="line">            thunk-&gt;u1.Function = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(hook_func);</span><br><span class="line">            <span class="comment">// æ¢å¤å†…å­˜ä¿æŠ¤</span></span><br><span class="line">            DWORD _;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">VirtualProtect</span>(mbi.BaseAddress, mbi.RegionSize, mbi.Protect, &amp;_))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸»å‡½æ•°ä¸­è°ƒç”¨å®ƒäº†</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ›´æ–°é’©å­å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">void</span> WINAPI <span class="title">my_sleep</span><span class="params">(DWORD ms)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[?] Hooked Sleep Function Called!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Sleeping for: 0x&quot;</span> &lt;&lt; ms &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// è°ƒç”¨åŸå‡½æ•°</span></span><br><span class="line">    <span class="built_in">original_sleep</span>(ms);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span>* original_func;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;IAT Hook Example by AmazingPP\n&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">hook_iat</span>(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;Sleep&quot;</span>, my_sleep, &amp;original_func)) &#123;</span><br><span class="line">	    std::cout &lt;&lt; <span class="string">&quot;[-] Hooking failed! error: &quot;</span> &lt;&lt; <span class="built_in">GetLastError</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; std::hex &lt;&lt; </span><br><span class="line">            <span class="string">&quot;[?] Old Address: 0x&quot;</span> &lt;&lt; original_func &lt;&lt; std::endl &lt;&lt; </span><br><span class="line">            <span class="string">&quot;[+] New Address: 0x&quot;</span> &lt;&lt; my_sleep &lt;&lt; std::endl;</span><br><span class="line">        original_sleep = <span class="built_in">static_cast</span>&lt;<span class="type">sleep_t</span>&gt;(original_func);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">0x10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºï¼š</p>
<img data-src="/2021/03/05/iat-hook/final_out.png" class="">
<p>ä¸Šé¢çš„ä¾‹å­æ˜¯ç®€å•çš„é¢å‘è¿‡ç¨‹å°è£…ã€‚ä½¿ç”¨ä¸Šè¿°ä»£ç ï¼Œä½ å¯ä»¥Hookä»»ä½•Win32 APIã€‚ ä½ ä¹Ÿå¯ä»¥æŠŠä»£ç æ„å»ºæˆDLLï¼Œä»»ä½•å°†å…¶æ³¨å…¥åˆ°éœ€è¦æ”»å‡»çš„è¿›ç¨‹ä¸­ã€‚</p>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<ul>
<li><strong>æ‰§è¡Œé€Ÿåº¦:10</strong></li>
<li><strong>ç¼–å†™éš¾åº¦:3</strong></li>
<li><strong>æ£€æµ‹ç‡:5</strong></li>
</ul>
<p>IAT HookåŸºäºPEæ–‡ä»¶åœ¨Windowsä¸Šçš„å·¥ä½œæ–¹å¼ã€‚ åŸºæœ¬æ€æƒ³ä¾æ—§æ˜¯å‡½æ•°æŒ‡é’ˆçš„æ›¿æ¢ï¼Œå°†å¯¼å…¥å‡½æ•°é‡å®šå‘ã€‚ å¯¹äºç®€å•çš„APIæŒ‚é’©å¾ˆæ–¹ä¾¿ï¼Œè€Œä¸”æ²¡æœ‰æ€§èƒ½æŸå¤± ä¸”å¯è¿ç”¨äºDirectXæŒ‚é’©ï¼Œå®ç°å†…éƒ¨ç»˜åˆ¶å±‚ï¼Œè¿›è€Œå®ç°é€è§†ç­‰åŠŸèƒ½</p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>é€†å‘</tag>
        <tag>PE</tag>
        <tag>Hook</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£å†³IDAçš„call analysis failedè°ƒç”¨åˆ†æå¤±è´¥</title>
    <url>/2020/12/30/ida-call-analysis-failed/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>å¥½åŸºå‹<a href="https://github.com/AmazingDM">AmazingDM</a>å‡ å¤©å‰ç»™æˆ‘å‘æ¥ä¸€ä¸ªç¨‹åºï¼Œå¸Œæœ›æˆ‘å¸®å¿™åˆ†æä¸€ä¸‹keyçš„åŠ å¯†ç®—æ³•</p>
<p>ä½†æˆ‘ç”¨IDAåŠ è½½åå‘ç°æ— æ³•åœ¨mainå‡½æ•°ä½¿ç”¨F5ï¼Œè­¦å‘Šå¦‚ä¸‹ï¼š <img data-src="/2020/12/30/ida-call-analysis-failed/warning.png" class=""></p>
<a id="more"></a>
<h1 id="äº†è§£é”™è¯¯">äº†è§£é”™è¯¯</h1>
<blockquote>
<p>æ ¹æ®<a href="https://www.hex-rays.com/products/decompiler/manual/failures.shtml#11">IDAå®˜ç½‘</a>å¯¹call analysis failedçš„è§£é‡Šï¼Œå‡ºç°è¿™ç§é—®é¢˜çš„åŸå› å¯èƒ½åˆ†ä¸¤ç§ï¼š 1. åç¼–è¯‘å™¨æ— æ³•ç¡®å®šè°ƒç”¨çº¦å®šï¼ˆthe decompiler could not determine the calling conventionï¼‰ 2. åç¼–è¯‘å™¨æ— æ³•ç¡®å®šå‚æ•°ä¸ªæ•°å’Œç±»å‹</p>
</blockquote>
<p>æˆ‘ä»¬Gåˆ°<code>4907EB</code>çš„ä½ç½®</p>
<img data-src="/2020/12/30/ida-call-analysis-failed/call_eax.png" class="">
<p>å‘ç°è¿™ä¸ªcallæ˜¯ä¸€ä¸ªå¯„å­˜å™¨å½¢å¼çš„callï¼Œ<code>EAX=EBP-120</code>ï¼Œç„¶åè°ƒç”¨<code>EAX</code>ï¼Œå‚æ•°æ˜¯<code>0</code></p>
<p>è¿™é‡Œå°±èƒ½çœ‹å‡ºé—®é¢˜çš„æ ¹æœ¬åŸå› äº†</p>
<p>æ˜¯å› ä¸º<code>EBP-120</code>ä¸æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œæ‰€ä»¥<strong>IDAæ²¡æ³•åˆ†æå‡º<code>EAX</code>çš„åœ°å€</strong></p>
<p>è¿™ä¸ªæ—¶å€™åªèƒ½ç”¨åˆ°x64dbgäº†ï¼Œçœ‹çœ‹è¿™ä¸ª<code>EAX</code>é‡Œåˆ°åº•æ˜¯ä»€ä¹ˆ</p>
<h1 id="åŠ¨æ€è°ƒè¯•">åŠ¨æ€è°ƒè¯•</h1>
<p>ç”±äºæ˜¯32ä½åº”ç”¨ï¼Œè¿™é‡Œä½¿ç”¨x32dbg</p>
<ol type="1">
<li>æ‰“å¼€è½¯ä»¶å¹¶é…ç½®å‘½ä»¤è¡Œï¼Œè‡ªåŠ¨æ–­åˆ°å…¥å£ç‚¹</li>
<li>Ctrl+Gï¼Œè¾“å…¥<code>4907EB</code></li>
<li>F4è¿è¡Œåˆ°è¿™ä¸ªcall</li>
</ol>
<p>å‘ç°<code>EAX</code>æ˜¯<code>msvcrt.time</code></p>
<img data-src="/2020/12/30/ida-call-analysis-failed/eax_func.png" class="">
<p>ä¹Ÿå°±æ˜¯Cè¯­è¨€åº“å‡½æ•°<code>time</code>ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆè°ƒç”¨æ—¶å‚æ•°æ˜¯0ï¼ˆç©ºæŒ‡é’ˆï¼‰</p>
<h1 id="é™æ€åˆ†æ">é™æ€åˆ†æ</h1>
<p>æˆ‘ä»¬å›åˆ°IDAï¼Œæ‰“å¼€å¯¼å…¥å‡½æ•°è¡¨ï¼Œæœç´¢<code>time</code>è¿™ä¸ªå‡½æ•°</p>
<img data-src="/2020/12/30/ida-call-analysis-failed/iat_time.png" class="">
<p>ç¡®å®æœ‰è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬åŒå‡»è¿›å»ã€‚æŒ‰Xï¼ŒæŸ¥çœ‹<code>time</code>çš„äº¤å‰å¼•ç”¨</p>
<img data-src="/2020/12/30/ida-call-analysis-failed/xrefs_time.png" class="">
<p>è¿™ä¸ªå‡½æ•°åœ¨mainå‡½æ•°é‡Œåªä½¿ç”¨è¿‡ä¸€æ¬¡ï¼Œæˆ‘ä»¬åŒå‡»è¿‡å»çœ‹æ±‡ç¼–</p>
<img data-src="/2020/12/30/ida-call-analysis-failed/save_time.png" class="">
<p>é‡ç‚¹å°±åœ¨çº¢æ¡†çš„ä»£ç é‡Œï¼Œå…ˆå°†<code>time</code>ä¿å­˜åœ¨äº†<code>EAX</code>é‡Œï¼Œéšååˆå°†<code>EAX</code>ä¿å­˜åœ¨äº†<code>EBP-120</code>é‡Œ</p>
<p>åŸæ¥<code>4907EB</code>é‚£è°ƒç”¨çš„<code>EBP-120</code>å°±æ˜¯<code>time</code>ã€‚</p>
<p>è¿™ä¸ä¹‹å‰åŠ¨æ€è°ƒè¯•çš„ç»“æœä¸€è‡´</p>
<h1 id="ä¿®å¤">ä¿®å¤</h1>
<p>é€‰ä¸­<code>mov eax, [ebp+var_120]</code>ï¼ŒæŒ‰ä¸‹<code>Ctrl+Alt+K</code>ï¼Œä½¿ç”¨Keypatchæ’ä»¶ä¿®æ”¹æ±‡ç¼–</p>
<img data-src="/2020/12/30/ida-call-analysis-failed/keypatch.png" class="">
<p>ä¿®æ”¹æˆ<code>mov eax, 4D2574</code>ï¼Œä¹Ÿå°±æ˜¯å¯¼å…¥å‡½æ•°<code>time</code>çš„åœ°å€</p>
<img data-src="/2020/12/30/ida-call-analysis-failed/fixed.png" class="">
<p>å¯ä»¥çœ‹åˆ°è™½ç„¶ä»£ç è¿˜æ˜¯<code>call eax</code>ï¼Œä½†è¿™æ—¶IDAå·²ç»è¯†åˆ«åˆ°<code>EAX</code>æ˜¯<code>time</code>äº†ï¼Œå¹¶è‡ªå·±åŠ ä¸Šäº†æ³¨é‡Š</p>
<p>æŒ‰ç…§ä¸Šè¿°æ–¹æ³•ä¿®å¤æ‰€æœ‰åœ°æ–¹ï¼ŒæŒ‰ä¸‹F5ï¼ŒæˆåŠŸè¾“å‡ºä¼ªä»£ç ~</p>
<img data-src="/2020/12/30/ida-call-analysis-failed/f5.png" class="">
]]></content>
      <categories>
        <category>é€†å‘</category>
      </categories>
      <tags>
        <tag>é€†å‘</tag>
        <tag>IDA Pro</tag>
        <tag>x64dbg</tag>
      </tags>
  </entry>
  <entry>
    <title>KMPå’ŒSundayç®—æ³•å®ç° strStr() å‡½æ•°</title>
    <url>/2021/02/08/implementation-of-strstr-with-KMP-and-BMHS-algorithm/</url>
    <content><![CDATA[<h1 id="å®ç°-strstr-å‡½æ•°"><a href="https://leetcode-cn.com/problems/implement-strstr">å®ç° strStr() å‡½æ•°</a></h1>
<p>ç»™å®šä¸€ä¸ª <code>haystack</code> å­—ç¬¦ä¸²å’Œä¸€ä¸ª <code>needle</code> å­—ç¬¦ä¸²ï¼Œåœ¨ <code>haystack</code> å­—ç¬¦ä¸²ä¸­æ‰¾å‡º <code>needle</code> å­—ç¬¦ä¸²å‡ºç°çš„ç¬¬ä¸€ä¸ªä½ç½® (ä»0å¼€å§‹)ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å› -1ã€‚</p>
<h3 id="ç¤ºä¾‹-1">ç¤ºä¾‹ 1:</h3>
<blockquote>
<p>è¾“å…¥: haystack = "hello", needle = "ll" è¾“å‡º: 2</p>
</blockquote>
<h3 id="ç¤ºä¾‹-2">ç¤ºä¾‹ 2:</h3>
<blockquote>
<p>è¾“å…¥: haystack = "aaaaa", needle = "bba" è¾“å‡º: -1</p>
</blockquote>
<a id="more"></a>
<blockquote>
<p><em>æ³¨ï¼šæœ¬æ–‡ç®—æ³•å¤æ‚åº¦ä¸­çš„<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0" xmlns="http://www.w3.org/2000/svg" width="2.378ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 1051 683" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-2-TEX-I-1D440"></use></g></g></g></svg></mjx-container>æ˜¯æ¨¡å¼ä¸²çš„é•¿åº¦ï¼Œ<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 888 683" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-2-TEX-I-1D441"></use></g></g></g></svg></mjx-container>æ˜¯ä¸»ä¸²çš„é•¿åº¦ï¼Œ<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0" xmlns="http://www.w3.org/2000/svg" width="1.695ex" height="1.538ex" role="img" focusable="false" viewBox="0 -680 749 680" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-I-1D439" d="M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-2-TEX-I-1D439"></use></g></g></g></svg></mjx-container>æ˜¯<code>SIMD</code>æ“ä½œå¼•å…¥çš„å¸¸æ•°ã€‚</em></p>
</blockquote>
<h1 id="åº“å‡½æ•°è§£æ³•">åº“å‡½æ•°è§£æ³•</h1>
<p>è°ä¸çˆ±åº“å‡½æ•°å‘¢ğŸ˜‹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">strStr</span><span class="params">(string haystack, string needle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> haystack.<span class="built_in">find</span>(needle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="å¤æ‚åº¦åˆ†æ">å¤æ‚åº¦åˆ†æ</h2>
<p>ç»è¿‡æŸ¥é˜…èµ„æ–™å¾—çŸ¥ï¼ŒC++ä¸‹çš„<code>string::find</code>æ˜¯<code>SIMD</code>æŒ‡ä»¤é›†ä¼˜åŒ–åçš„æœ´ç´ ç®—æ³•<a href="#refer"><sup>[1]</sup></a><a href="#refer"><sup>[2]</sup></a></p>
<ul>
<li>é¢„å¤„ç†æ—¶é—´å¤æ‚åº¦ï¼š<em>æ— </em></li>
<li>åŒ¹é…æ—¶é—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.781ex" xmlns="http://www.w3.org/2000/svg" width="7.584ex" height="2.765ex" role="img" focusable="false" viewBox="0 -877 3352.1 1222" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-2-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-2-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-2-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-2-TEX-I-1D439" d="M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z"></path><path id="MJX-2-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-2-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mfrac" transform="translate(1152, 0)"><g data-mml-node="mrow" transform="translate(220, 394) scale(0.707)"><g data-mml-node="mi"><use xlink:href="#MJX-2-TEX-I-1D440"></use></g><g data-mml-node="mi" transform="translate(1051, 0)"><use xlink:href="#MJX-2-TEX-I-1D441"></use></g></g><g data-mml-node="mi" transform="translate(640.7, -345) scale(0.707)"><use xlink:href="#MJX-2-TEX-I-1D439"></use></g><rect width="1571.1" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(2963.1, 0)"><use xlink:href="#MJX-2-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
<li>ç©ºé—´å¤æ‚åº¦ï¼š<em>æ— </em></li>
</ul>
<h1 id="kmpè§£æ³•">KMPè§£æ³•</h1>
<p>çœ‹äº†<code>Carl</code>å¤§å¸ˆå…„çš„KMPç®—æ³•è§£è¯»ï¼Œç»ˆäºâ€œå…¥é—¨â€äº†KMPğŸ¤ªï¼Œè¿™è¾¹å¼ºçƒˆæ¨èä¸‹ï¼š</p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1PD4y1o7nd">å¸®ä½ æŠŠKMPç®—æ³•å­¦ä¸ªé€šé€ï¼ï¼ˆç†è®ºç¯‡ï¼‰Bç«™è§†é¢‘</a></li>
<li><a href="https://www.bilibili.com/video/BV1M5411j7Xx">å¸®ä½ æŠŠKMPç®—æ³•å­¦ä¸ªé€šé€ï¼ï¼ˆä»£ç ç¯‡ï¼‰Bç«™è§†é¢‘</a></li>
</ul>
<p>KMPç®—æ³•çš„å…·ä½“ç†è®ºç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œå¤§å®¶å¯ä»¥ç™¾åº¦ï¼Œè¿™é‡Œæä¸€ä¸‹æˆ‘çš„ç†è§£</p>
<p>æ ¹æ®æˆ‘çš„ç†è§£ï¼ŒKMPç®—æ³•çš„æ ¸å¿ƒå°±åœ¨äºæ±‚å¾—<strong>å‰ç¼€è¡¨</strong>ï¼Œä½“ç°åœ¨ä»£ç ä¸Šå°±æ˜¯<strong>æ„é€ æ¨¡å¼ä¸²åŒ¹é…å­—ç¬¦æŒ‡é’ˆçš„è½¬ç§»æ•°ç»„</strong>ï¼Œå³ <code>next</code> æ•°ç»„</p>
<p>ä¸ªäººæ„Ÿè§‰æ±‚ <code>next</code> æ•°ç»„çš„è¿‡ç¨‹æœ‰ç‚¹åƒåŠ¨æ€è§„åˆ’</p>
<p>ä¸‹é¢ç”±èœé¸¡ä¸ºå¤§å®¶æ‰‹æ’•KMP</p>
<h2 id="å®ç°">å®ç°</h2>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">strStr</span><span class="params">(string haystack, string needle)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> h_len = haystack.<span class="built_in">size</span>(), n_len = needle.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span> (!n_len)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> next = <span class="built_in">getNext</span>(needle); <span class="comment">// é¢„å¤„ç†</span></span><br><span class="line">        <span class="type">int</span> j = <span class="number">0</span>; <span class="comment">// j æ¨¡å¼ä¸²æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; h_len; ++i) &#123; <span class="comment">// i ä¸»ä¸²æŒ‡é’ˆ</span></span><br><span class="line">            <span class="keyword">while</span> (j &gt; <span class="number">0</span> &amp;&amp; haystack[i] != needle[j]) <span class="comment">// ä¸åŒ¹é…</span></span><br><span class="line">                j = next[j - <span class="number">1</span>]; <span class="comment">// j å›æº¯åˆ°ä¹‹å‰åŒ¹é…çš„ä½ç½®</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (haystack[i] == needle[j]) <span class="comment">// åŒ¹é…</span></span><br><span class="line">                ++j;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (j == n_len) <span class="comment">// j æŒ‡é’ˆèµ°åˆ°äº†æ¨¡å¼ä¸²çš„æœ«å°¾ï¼ˆå³åœ¨ä¸»ä¸²ä¸­æ‰¾åˆ°äº†æ¨¡å¼ä¸²ï¼‰</span></span><br><span class="line">                <span class="keyword">return</span> i - j + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// æ„é€ å‰ç¼€è¡¨</span></span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">getNext</span><span class="params">(<span class="type">const</span> string&amp; s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = s.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">next</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">        next[<span class="number">0</span>] = j; <span class="comment">// ç¬¬ä¸€ä¸ªå­—ç¬¦çš„å‰ç¼€é•¿åº¦å¿…å®šæ˜¯0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123; <span class="comment">// i ä»1å¼€å§‹</span></span><br><span class="line">            <span class="keyword">while</span> (j &gt; <span class="number">0</span> &amp;&amp; s[i] != s[j]) <span class="comment">// å‰åç¼€ä¸åŒ</span></span><br><span class="line">                j = next[j - <span class="number">1</span>]; <span class="comment">// å‘å‰å›æº¯</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (s[i] == s[j]) <span class="comment">// å‰åç¼€ç›¸åŒ </span></span><br><span class="line">                ++j;</span><br><span class="line"></span><br><span class="line">            next[i] = j; <span class="comment">// ä¿å­˜å‰ç¼€é•¿åº¦</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="å¤æ‚åº¦åˆ†æ-1">å¤æ‚åº¦åˆ†æ</h2>
<ul>
<li>é¢„å¤„ç†æ—¶é—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="5.864ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2592 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-2-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-2-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-2-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-2-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-2-TEX-I-1D440"></use></g><g data-mml-node="mo" transform="translate(2203, 0)"><use xlink:href="#MJX-2-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
<li>åŒ¹é…æ—¶é—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2429 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-2-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-2-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-2-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-2-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-2-TEX-I-1D441"></use></g><g data-mml-node="mo" transform="translate(2040, 0)"><use xlink:href="#MJX-2-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
<li>ç©ºé—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="5.864ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2592 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-2-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-2-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-2-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-2-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-2-TEX-I-1D440"></use></g><g data-mml-node="mo" transform="translate(2203, 0)"><use xlink:href="#MJX-2-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
</ul>
<h1 id="sundayè§£æ³•">Sundayè§£æ³•</h1>
<p>Sundayç®—æ³•æ˜¯BMHç®—æ³•çš„å˜ç§ï¼Œå†™æ³•æ¯”BMHæ›´ç®€å•ï¼Œæ€æƒ³æ¯”KMPç®€å•ï¼Œä¸”åœ¨å®é™…æƒ…å†µä¸‹ï¼Œéƒ½æ¯”BMHå’ŒKMPæœ‰æ›´å¥½çš„æ•ˆç‡<a href="#refer"><sup>[3]</sup></a>ã€‚</p>
<p>è¿™ç§åˆç®€å•æ•ˆç‡åˆé«˜çš„ç®—æ³•ï¼Œå½“ç„¶è¦å­¦ä¸€å­¦äº†ï¼ŒSundayçš„æ€æƒ³åœ¨äºå¦‚ä½•åœ¨é‡åˆ°ä¸åŒ¹é…çš„å­—ç¬¦æ—¶<strong>è·³è¿‡å°½å¯èƒ½å¤šçš„å­—ç¬¦</strong>ï¼Œä»¥å‡å°‘å¯¹æ¯”æ¬¡æ•°ã€‚</p>
<p>ä¸‹é¢ç”±èœé¸¡è¡¨æ¼”</p>
<h2 id="å®ç°-1">å®ç°</h2>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">strStr</span><span class="params">(string haystack, string needle)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> h_len = haystack.<span class="built_in">size</span>(), n_len = needle.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span> (!n_len)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// æ„å»ºåç§»è¡¨</span></span><br><span class="line">        <span class="type">int</span> shift[<span class="number">0xFF</span> + <span class="number">1</span>]&#123;&#125;;</span><br><span class="line">        <span class="comment">// å¿…é¡»æ­£å‘éå†ï¼Œå› ä¸ºå¦‚æœæœ‰é‡å¤çš„å­—æ¯</span></span><br><span class="line">        <span class="comment">// éœ€è¦åŒ¹é…ç´¢å¼•æœ€å¤§çš„(ç§»åŠ¨æ­¥é•¿æœ€çŸ­)</span></span><br><span class="line">        <span class="comment">// é˜²æ­¢è·³çš„è¿‡è¿œé—æ¼æ•°æ®</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n_len; ++i) &#123;</span><br><span class="line">            shift[needle[i]] = n_len - i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= h_len - n_len;) &#123; <span class="comment">// i ä¸»ä¸²æŒ‡é’ˆ</span></span><br><span class="line">            <span class="type">bool</span> found = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; n_len; ++j) &#123; <span class="comment">// j æ¨¡å¼ä¸²æŒ‡é’ˆ</span></span><br><span class="line">                <span class="keyword">if</span> (haystack[i + j] != needle[j]) &#123; <span class="comment">// ä¸åŒ¹é…</span></span><br><span class="line">                    found = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (found) <span class="comment">// åŒ¹é…ï¼Œè¿”å›ç´¢å¼•</span></span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// ä¸åŒ¹é…ï¼Œåˆ¤æ–­å‚ä¸åŒ¹é…çš„æœ«å°¾å­—ç¬¦çš„ä¸‹ä¸€ä½æ˜¯å¦åœ¨æ¨¡å¼ä¸²ä¸­å­˜åœ¨</span></span><br><span class="line">            <span class="type">int</span> step = shift[haystack[i + n_len]];</span><br><span class="line">            <span class="keyword">if</span> (step &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                i += step; <span class="comment">// å‡ºç°åœ¨æ¨¡å¼ä¸²ä¸­ï¼ŒæŒ‰åç§»é‡è·³è¿‡</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                i += n_len + <span class="number">1</span>; <span class="comment">// æ²¡å‡ºç°åœ¨æ¨¡å¼ä¸²ä¸­ï¼Œè·³è¿‡æ¨¡å¼ä¸²é•¿åº¦ + 1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="å¤æ‚åº¦åˆ†æ-2">å¤æ‚åº¦åˆ†æ</h2>
<ul>
<li>é¢„å¤„ç†æ—¶é—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="5.864ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2592 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-2-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-2-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-2-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-2-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-2-TEX-I-1D440"></use></g><g data-mml-node="mo" transform="translate(2203, 0)"><use xlink:href="#MJX-2-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
<li>åŒ¹é…æ—¶é—´å¤æ‚åº¦ï¼š
<ul>
<li>å¹³å‡ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2429 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-2-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-2-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-2-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-2-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-2-TEX-I-1D441"></use></g><g data-mml-node="mo" transform="translate(2040, 0)"><use xlink:href="#MJX-2-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
<li>æœ€å¥½ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.781ex" xmlns="http://www.w3.org/2000/svg" width="6.163ex" height="2.765ex" role="img" focusable="false" viewBox="0 -877 2724.2 1222" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-1-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mfrac" transform="translate(1152, 0)"><g data-mml-node="mi" transform="translate(277.6, 394) scale(0.707)"><use xlink:href="#MJX-1-TEX-I-1D441"></use></g><g data-mml-node="mi" transform="translate(220, -345) scale(0.707)"><use xlink:href="#MJX-1-TEX-I-1D440"></use></g><rect width="943.2" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(2335.2, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
<li>æœ€å·®ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="7.873ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3480 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-1-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-1-TEX-I-1D440"></use></g><g data-mml-node="mi" transform="translate(2203, 0)"><use xlink:href="#MJX-1-TEX-I-1D441"></use></g><g data-mml-node="mo" transform="translate(3091, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
</ul></li>
<li>ç©ºé—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="5.864ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2592 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-1-TEX-I-1D440"></use></g><g data-mml-node="mo" transform="translate(2203, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container></li>
</ul>
<div id="refer">

</div>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<h2 id="å…±åŒçš„æ ¸å¿ƒæ€æƒ³">å…±åŒçš„æ ¸å¿ƒæ€æƒ³</h2>
<p>æ— è®ºæ˜¯KMPå’ŒSundayç®—æ³•ï¼Œ <strong>å‡å°‘é‡å¤åŒ¹é…</strong> éƒ½æ˜¯æ ¸å¿ƒæ€æƒ³ï¼Œä¸”éƒ½æ˜¯é€šè¿‡<em>è·³è½¬</em>æ¥å®Œæˆçš„</p>
<h2 id="æ€æƒ³">æ€æƒ³</h2>
<ul>
<li><p>KMPé€šè¿‡å‰ç¼€è¡¨ï¼Œä¹Ÿå°±æ˜¯<code>next</code>æ•°ç»„ï¼Œå‘Šè¯‰<code>j</code>ï¼Œå¦‚æœåŒ¹é…å¤±è´¥çš„è¯åº”è¯¥è·³è½¬åˆ°<code>next[j]</code>ä½ç½®è¿›è¡ŒåŒ¹é…ï¼Œ<code>next</code>æ•°ç»„èƒ½ä¿è¯çš„æ˜¯<code>next[j]</code>å‰é¢çš„ä½ç½®å·²ç»åŒ¹é…ä¸Šäº†</p></li>
<li><p>Sundayåˆ™æ˜¯é€šè¿‡åç§»è¡¨ï¼Œåœ¨åŒ¹é…å¤±è´¥æ—¶ï¼Œç¡®å®šéœ€è¦ç§»åŠ¨çš„ä½æ•°ï¼Œç„¶åè®©<code>i</code>å»ä½ç§»</p></li>
</ul>
<h2 id="å®ç”¨æ„ä¹‰">å®ç”¨æ„ä¹‰</h2>
<ul>
<li>KMPåœ¨å®é™…çš„å­—ç¬¦ä¸²åŒ¹é…éœ€æ±‚ä¸­å·²ç»è¢«æŠ›å¼ƒï¼Œä½†KMPçš„æ€æƒ³æ˜¯å€¼å¾—å­¦ä¹ çš„ã€‚</li>
<li>Sundayåœ¨ç°å®ä¸­çš„å®ç”¨æ„ä¹‰å¾ˆå¤§ï¼Œå› ä¸ºå…¶æ•ˆç‡å¾ˆé«˜ï¼ˆå‘æ˜è€…å®£ç§°åœ¨å®é™…åœºæ™¯ä¸‹ï¼Œæ¯”BMå¿«å¤§çº¦4.5å€ï¼‰ã€‚ä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œæ¯”å¦‚é‡åˆ°<code>"aaaaaaaaaaaab","ab"</code>ï¼Œå°±ä¼šé€€åŒ–æˆæœ´ç´ ç®—æ³•ï¼Œæ—¶é—´å¤æ‚åº¦ï¼š<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex" xmlns="http://www.w3.org/2000/svg" width="7.873ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3480 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path><path id="MJX-1-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><use xlink:href="#MJX-1-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763, 0)"><use xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152, 0)"><use xlink:href="#MJX-1-TEX-I-1D440"></use></g><g data-mml-node="mi" transform="translate(2203, 0)"><use xlink:href="#MJX-1-TEX-I-1D441"></use></g><g data-mml-node="mo" transform="translate(3091, 0)"><use xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container> ï¼Œä¸è¿‡ç°å®ä¸­æå°‘æœ‰è¿™ä¹ˆæç«¯çš„æƒ…å†µã€‚</li>
</ul>
<h1 id="åŸ‹å‘">åŸ‹å‘</h1>
<p>å®ç°ä¸€ä¸ª<a href="/2021/02/23/fuzzy-matching-algorithm-supporting-wildcard-based-on-Sunday/">æ”¯æŒå•å­—é€šé…ç¬¦çš„Sundayæ¨¡ç³ŠåŒ¹é…ç®—æ³•</a></p>
<h1 id="å¼•ç”¨">å¼•ç”¨</h1>
<ol type="1">
<li>Kumar, Aditya. <a href="https://reviews.llvm.org/D27068">"libc++: Improve string::find algorithm"</a></li>
<li>Kumar, Aditya. <a href="https://gcc.gnu.org/legacy-ml/libstdc++/2017-01/msg00039.html">"libstdc++: Improve string::find algorithm"</a></li>
<li>Hume; Sunday (1991). <a href="https://www.semanticscholar.org/paper/Fast-string-searching-Hume-Sunday/d9912ea262986794e29e3f15e5f8930d42f2ced4">"Fast String Searching"</a></li>
<li>Wiki. <a href="https://en.wikipedia.org/wiki/String-searching_algorithm">"String-searching algorithm"</a></li>
</ol>
<h1 id="æ›´æ”¹">æ›´æ”¹</h1>
<ul>
<li>[2021-02-23] æ›´æ–°Sundayç®—æ³•ä»£ç ï¼Œå°†åç§»è¡¨ä»<code>unordered_map</code>æ”¹ä¸ºåŸç”Ÿæ•°ç»„ï¼Œ<code>unordered_map</code>è¿‡é‡ï¼Œç›´æ¥ç”¨æ•°ç»„å½“åšç‰¹æ®Šçš„å“ˆå¸Œè¡¨å³å¯</li>
</ul>
]]></content>
      <categories>
        <category>ç®—æ³•</category>
      </categories>
      <tags>
        <tag>ç®—æ³•</tag>
        <tag>C++</tag>
        <tag>å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•</tag>
        <tag>Sunday</tag>
        <tag>KMP</tag>
      </tags>
  </entry>
  <entry>
    <title>æˆ‘çš„2021æ˜¥æ‹›é¢è¯•ç»éªŒ</title>
    <url>/2021/03/19/interview-experience-of-2021-spring-recruitment/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>å‚åŠ äº†ä¸€ä¸ªæ˜ŸæœŸçš„é¢è¯•ï¼Œç»ˆäºå®šä¸‹æ¥äº†ï¼ŒæŠŠé¢è¯•ç»éªŒè®°å½•ä¸€ä¸‹ï¼ˆå…¨å‡­å›å¿†ï¼Œé—®é¢˜å¯èƒ½ä¸å…¨ï¼‰</p>
<a id="more"></a>
<h1 id="qtå¼€å‘æœªå‘offer">Qtå¼€å‘ï¼ˆæœªå‘Offerï¼‰</h1>
<ol type="1">
<li>ä½ çš„çº¿ç¨‹æ± æ˜¯æ€ä¹ˆå®ç°çš„</li>
<li>ä½ çš„çº¿ç¨‹æ± æœ‰ä»€ä¹ˆåœ°æ–¹å¯ä»¥æ”¹è¿›çš„</li>
<li>ç®€å•è®²ä¸€è®²epoll</li>
<li>ä½ å¯¹Qtæœ‰å¤šå°‘äº†è§£ï¼ˆä¸æ€ä¹ˆäº†è§£ï¼Œåªåœ¨å¤§å­¦ç”¨Qtåšè¿‡è¯¾ç¨‹ä½œä¸šï¼‰</li>
<li>C++ä¸Cçš„åŒºåˆ«</li>
<li>è™šå‡½æ•°çš„åŸç†</li>
<li>C++ç±»å¯¹è±¡åˆå§‹åŒ–çš„é¡ºåºï¼Ÿ</li>
<li>é‚£ææ„çš„é¡ºåºå‘¢ï¼Ÿ</li>
</ol>
<p>æŠ€æœ¯é¢è¯•è‡ªæˆ‘æ„Ÿè§‰ç­”çš„è¿˜å¯ä»¥ï¼Œè¿‡äº†åï¼Œç»ç†å°±ä¸€ç›´åœ¨è¯´ä½ ä¸ä¼šQtï¼Œè¦å­¦ä¹ å•¥çš„ï¼Œåæ­£å°±åœ¨å¼ºè°ƒè‡ªå­¦èƒ½åŠ›å’Œç”¨äººæˆæœ¬....è¯´çš„æˆ‘ä¸è€çƒ¦äº†ï¼Œä»–çœ‹æˆ‘ä¸å’‹æƒ³å¬å°±ç»“æŸé¢è¯•äº†</p>
<h1 id="åˆåˆ›å…¬å¸javaå®ä¹ å·²å‘offer">åˆåˆ›å…¬å¸Javaå®ä¹ ï¼ˆå·²å‘Offerï¼‰</h1>
<ol type="1">
<li>è‡ªæˆ‘ä»‹ç»</li>
<li>ä½ ä»¥å‰ç”¨è¿‡IoCæ¡†æ¶ï¼Œé‚£ä¹ˆè¯·ä½ è§£é‡Šä¸€ä¸‹IoCå’ŒDI</li>
<li>ä½ ä»¥å‰ç”¨è¿‡RabbitMQï¼Œè¯·ä½ æè¿°ä¸€ä¸‹æ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨åœºæ™¯</li>
<li>RabbitMQçš„3å¤§æ¨¡å¼ ï¼ˆè¿™é‡Œåªè¯´å‡ºæ¥ä¸€ç§ï¼Œ2å¹´å‰ç”¨çš„ï¼Œå¿˜äº†ï¼‰</li>
<li>è¯·è¯´ä¸€ä¸‹æµè§ˆå™¨è®¿é—®ä¸€ä¸ªç½‘é¡µçš„å…¨è¿‡ç¨‹ ï¼ˆåŸºæœ¬ç»†èŠ‚éƒ½è¯´åˆ°äº†ï¼Œé¢è¯•å®˜è¯´å¯ä»¥æŠŠDNSè§£æé‚£å—å†è¯´è¯¦ç»†ç‚¹ï¼‰</li>
<li>ArrayListå’ŒLinkedListçš„åŒºåˆ«ï¼ˆJavaå…«è‚¡æ–‡ï¼Œå®Œå…¨ä¸ä¼šï¼Œå’Œé¢è¯•å®˜è§£é‡Šæˆ‘çš„Javaåªåœç•™åœ¨æœ€æœ€æœ€åŸºç¡€åï¼Œè¡¨ç¤ºæ²¡å…³ç³»ï¼‰</li>
<li>è¯´ä¸€è¯´æ•°ç»„å’Œé“¾è¡¨çš„åŒºåˆ«</li>
<li>ä½ çŸ¥é“å“ªäº›æ•°æ®ç»“æ„</li>
<li>æ‰‹å†™ä»£ç ï¼Œç»Ÿè®¡å·¦å³æ‹¬å·åˆæ³•åŒ¹é…çš„ä¸ªæ•° ï¼ˆç”¨æ ˆï¼Œå¾ˆç®€å•ï¼‰</li>
<li>åé—®ç¯èŠ‚</li>
</ol>
<p>æœ€å¥½çš„ä¸€æ¬¡é¢è¯•ä½“éªŒï¼Œé¢è¯•å®˜å…¨ç¨‹é¢å¸¦å¾®ç¬‘ï¼Œä¹Ÿä¼šé¼“åŠ±ä½ å»æ€è€ƒï¼Œé¼“åŠ±ä½ å°è¯•æ‰‹å†™ä»£ç ã€‚ä¹Ÿæ˜¯å”¯ä¸€ä¸€å®¶é¢è¯•å®˜ä¸»åŠ¨ç»™æˆ‘å€’å¼€æ°´çš„ï¼Œè®©æˆ‘æ„Ÿå—åˆ°äº†æ— æ¯”çš„å°Šé‡ã€‚</p>
<h1 id="åŒ»ç–—å™¨æ¢°cå¼€å‘-å·²å‘offer">åŒ»ç–—å™¨æ¢°C++å¼€å‘ ï¼ˆå·²å‘Offerï¼‰</h1>
<ol type="1">
<li>è‡ªæˆ‘ä»‹ç»</li>
</ol>
<p>åŸºæœ¬å°±ä¸€ç›´åœ¨èŠå¤©ï¼ŒèŠå¯¹åŒ»ç–—å™¨æ¢°çš„çœ‹æ³•ï¼Œå¯¹ä¸šåŠ¡çš„çœ‹æ³•ï¼Œå¯¹å…¬å¸çš„çœ‹æ³•ï¼Œæ²¡æœ‰é—®æŠ€æœ¯</p>
<h1 id="é€šä¿¡åè®®cå¼€å‘-å·²å‘offer">é€šä¿¡åè®®C++å¼€å‘ ï¼ˆå·²å‘Offerï¼‰</h1>
<p>è¿›æ¥ç›´æ¥å†™ç¬”è¯•é¢˜</p>
<ol type="1">
<li>ä½ è§‰å¾—<code>if (n == 1)</code>å’Œ<code>if (1 == n)</code>å“ªç§æ›´å¥½ ï¼ˆå½“æ—¶æ²¡å¤ªç†è§£ï¼Œä½†æˆ‘å¹³æ—¶å†™ä»£ç å¤§å¤šç”¨ç¬¬ä¸€ç§ã€‚åæ¥è¯´ç¬¬äºŒç§å¯ä»¥é˜²æ­¢å¤±è¯¯å†™æˆ<code>if (n = 1)</code>...ç¡®å®æœ‰ç‚¹é“ç†ï¼‰</li>
<li>ä»¥ä¸‹ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜ ï¼ˆä»£ç ä¸è´´äº† 1. mallocæ²¡æœ‰free 2. mallocè¿”å›å€¼æ˜¯void*éœ€è¦æ˜¾å¼ç±»å‹è½¬æ¢ï¼‰</li>
<li>æŒ‡é’ˆå’Œå¼•ç”¨çš„åŒºåˆ«</li>
<li>ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿå¦‚ä½•é¿å…</li>
<li>å¦‚æœé‡åˆ°äº†å†…å­˜æ³„æ¼ï¼Œå¦‚ä½•è§£å†³</li>
<li>ä»€ä¹ˆæ˜¯è™šå‡½æ•°ï¼Ÿ</li>
<li>ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè°ƒç”¨å¤åˆ¶æ„é€ å‡½æ•°ï¼ˆ3ç§ï¼Œå½“æ—¶å†™å‡ºæ¥2ç§ã€‚åæ¥ä¸€æƒ³ï¼Œå‚æ•°å€¼ä¼ é€’æ—¶ä¹Ÿæ˜¯ä¼šè°ƒç”¨å¤åˆ¶æ„é€ å‡½æ•°çš„ï¼‰</li>
<li>deleteå’Œdelete[]çš„åŒºåˆ«</li>
<li>ææ„å‡½æ•°ä¸ºä»€ä¹ˆéœ€è¦å®šä¹‰æˆè™šå‡½æ•°ï¼Ÿ</li>
<li>æµ…æ‹·è´å’Œæ·±æ‹·è´çš„åŒºåˆ«</li>
</ol>
<p>å†™å®Œåå’Œç»ç†èŠï¼Œä»¥åŠä¸€äº›åé—®ç¯èŠ‚</p>
<h1 id="æ¨¡æ‹Ÿä»¿çœŸcå¼€å‘-å·²å‘offer">æ¨¡æ‹Ÿä»¿çœŸC++å¼€å‘ ï¼ˆå·²å‘Offerï¼‰</h1>
<p>å…ˆå¡«ä¸ªäººä¿¡æ¯ï¼Œç„¶åä¸¤ä¸ªé¢è¯•å®˜æŠ€æœ¯é¢</p>
<ol type="1">
<li>è‡ªæˆ‘ä»‹ç»</li>
<li>C++å’ŒC#çš„åŒºåˆ«</li>
<li>æ‰˜ç®¡ä»£ç å’Œéæ‰˜ç®¡ä»£ç çš„ä¼˜åŠ£ ï¼ˆè¿™ä¸ªæ²¡ç­”å¥½ï¼Œå½“æ—¶è¯´æ‰˜ç®¡ä»£ç æ²¡å•¥ç‰¹åˆ«çš„å¥½å¤„ï¼Œé¢è¯•å®˜è®©æˆ‘å›å»å†æ€è€ƒæ€è€ƒï¼Œå“ˆå“ˆï¼‰</li>
<li>ç¼–è¯‘æ—¶å¤šæ€å’Œè¿è¡Œæ—¶å¤šæ€çš„åŒºåˆ«</li>
<li>è¯·ç»†è‡´çš„è¯´ä¸€ä¸‹è™šå‡½æ•°å’Œçº¯è™šå‡½æ•°ï¼ˆè¿™é‡ŒèŠçš„ç‰¹åˆ«æ·±ï¼‰</li>
<li>è™šå‡½æ•°æœ‰æ€§èƒ½æŸå¤±å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</li>
<li>äº†è§£å“ªäº›è®¾è®¡æ¨¡å¼</li>
<li>å•ä¾‹æ¨¡å¼æœ‰å“ªäº›å®ç°æ–¹å¼</li>
<li>å•ä¾‹æ¨¡å¼é‡Œçš„æ‡’æ±‰æ¨¡å¼ï¼Œé¥¿æ±‰æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿåˆ†åˆ«æœ‰ä»€ä¹ˆåº”ç”¨åœºæ™¯ï¼Ÿ</li>
<li>è¯·ç»†è‡´è¯´ä¸€ä¸‹æŠ½è±¡å·¥å‚æ¨¡å¼çš„å®ç°æ–¹å¼ï¼Œæœ‰ä»€ä¹ˆåº”ç”¨åœºæ™¯</li>
<li>æ™ºèƒ½æŒ‡é’ˆæ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>è¯·ä½ è¯¦ç»†å¯¹æ¯”ä¸€ä¸‹shared_ptrã€unique_ptrå’Œweak_ptrçš„åŒºåˆ«</li>
<li>shared_ptrçš„åŸç†å’Œweak_ptrçš„åŸç†ï¼ˆè¿™é‡Œweak_ptrçš„åŸç†ä¸çŸ¥é“ï¼‰</li>
<li>vectorå’Œlistçš„åŒºåˆ«ï¼Œvectoræ˜¯å¦‚ä½•æ‰©å®¹çš„ï¼Ÿæ‰©å®¹æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li>
<li>ä½ çŸ¥é“å“ªäº›æ•°æ®ç»“æ„</li>
<li>å¦‚ä½•åˆ¤æ–­é“¾è¡¨æœ‰æ²¡æœ‰ç¯ï¼ˆå¿«æ…¢æŒ‡é’ˆï¼‰</li>
<li>ä½ çŸ¥é“å“ªäº›STLå®¹å™¨</li>
<li>setå’Œunordered_setçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>setçš„é¡ºåºæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿï¼ˆä¸çŸ¥é“ï¼Œå“ˆå“ˆï¼‰</li>
<li>æ’åºç®—æ³•äº†è§£å“ªäº›ï¼Ÿæ—¶é—´å¤æ‚åº¦åˆ†åˆ«æ˜¯å¤šå°‘ï¼Ÿ</li>
<li>å¿«é€Ÿæ’åºçš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿæ—¶é—´å¤æ‚åº¦ä»€ä¹ˆæ—¶å€™æœ€å·®ï¼Œä»€ä¹ˆæ—¶å€™æœ€å¥½ï¼Ÿ</li>
<li>TCPå’ŒUDPçš„åŒºåˆ«ï¼Ÿä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹äº†è§£å—ï¼Ÿ</li>
<li>ä»€ä¹ˆæ˜¯TCPç²˜åŒ…ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿï¼ˆè¿™ä¸ªä¸çŸ¥é“ï¼Œç½‘ç»œåŸºç¡€è¿˜æ˜¯å¤ªå·®äº†ï¼‰</li>
<li>selectã€pollã€epollçš„åŒºåˆ«ï¼Ÿä½ ä¸ºä»€ä¹ˆé€‰æ‹©epollï¼Ÿ</li>
<li>epollä¸€å®šèƒ½ä¿è¯æ€§èƒ½æ˜¯æœ€å¥½çš„å˜›ï¼Ÿ</li>
<li>è¯·ä½ è®¾è®¡ä¸€ä¸ªselectã€epollèåˆçš„å¤šè·¯IOè½¬æ¥</li>
<li>å¤šçº¿ç¨‹äº†è§£å¤šå°‘ï¼Œå¤šçº¿ç¨‹ä¹‹é—´å¦‚ä½•åŒæ­¥ï¼Ÿ</li>
<li>ä¿¡å·é‡æœ‰å‡ ä¸ªçŠ¶æ€ï¼ˆä¸æ¸…æ¥šï¼Œä¿¡å·é‡ç”¨å¾—å°‘ã€‚å¹³æ—¶äº’æ–¥é”å’Œæ¡ä»¶å˜é‡ç”¨çš„æ¯”è¾ƒå¤šï¼‰</li>
<li>å¯¹Qtæœ‰å¤šå°‘äº†è§£ï¼Ÿï¼ˆä¸æ€ä¹ˆäº†è§£ï¼Œåªåœ¨å¤§å­¦ç”¨Qtåšè¿‡è¯¾ç¨‹ä½œä¸šï¼‰</li>
<li>åé—®ç¯èŠ‚</li>
</ol>
<p>è¿™å®¶å…¬å¸çš„HRæ˜¯æœ€æœ‰äº²å’ŒåŠ›çš„ï¼Œä¹Ÿæ˜¯æœ€å¥½çš„ï¼Œä¼šå’Œä½ ç»¼åˆåˆ†ææ‰‹ä¸Šçš„offerï¼Œä¸ªäººå‘å±•å‰æ™¯ç­‰ç­‰</p>
<h1 id="é‡‘èäººå·¥æ™ºèƒ½cå¼€å‘-å·²å‘offer">é‡‘èäººå·¥æ™ºèƒ½C++å¼€å‘ ï¼ˆå·²å‘Offerï¼‰</h1>
<h3 id="åˆè¯•">åˆè¯•</h3>
<p>è¿›æ¥ä¹Ÿæ˜¯ç›´æ¥å†™ç¬”è¯•é¢˜</p>
<p>7é“ç®—æ³•é¢˜ï¼Œå…¨éƒ¨æ‰‹å†™ï¼Œå› ä¸ºèµ¶æ—¶é—´ï¼ˆå½“æ—¶ä¸‹åˆçº¦äº†ä¸¤åœºé¢è¯•ï¼‰ï¼Œåªå†™äº†å‰5é“</p>
<ol type="1">
<li>äºŒåˆ†æŸ¥æ‰¾ï¼ˆå·¦é—­å³å¼€åŒºé—´ç‰ˆæœ¬çš„å®ç°ï¼‰</li>
<li>ç»Ÿè®¡å­ä¸²åœ¨ä¸»ä¸²é‡Œçš„ä¸ªæ•°ï¼ˆKMPç®—æ³•ï¼Œè¿™ä¸ªæˆ‘ç†Ÿå“ˆå“ˆï¼‰</li>
<li>å†™ä¸€ä¸ªæ’åºç®—æ³•ï¼ˆå†™äº†å¿«é€Ÿæ’åºï¼‰</li>
<li>å®ç°atoiå‡½æ•°ï¼ˆæŠŠintå€¼æº¢å‡ºä¹Ÿè€ƒè™‘äº†è¿›å»ï¼ŒæƒŠè‰³åˆ°äº†é¢è¯•å®˜ï¼Œå“ˆå“ˆï¼‰</li>
<li>åè½¬é“¾è¡¨ï¼ˆå†™äº†é€’å½’çš„å®ç°ï¼‰</li>
</ol>
<p>é—®ç­”ç¯èŠ‚ï¼š</p>
<ol type="1">
<li>å¿«æ’çš„å¦ä¸€ç§å®ç°æ–¹æ³•äº†è§£å—ï¼ˆäº†è§£ï¼ŒåŒæŒ‡é’ˆçš„æ–¹æ³•ï¼‰</li>
<li>åè½¬é“¾è¡¨çš„è¿­ä»£å®ç°ä¼šä¹ˆï¼ˆä¼šï¼‰</li>
<li>KMPç®—æ³•çš„åŸç†æ˜¯ä»€ä¹ˆ</li>
<li>sizeofçš„ä¸€äº›é¢˜ç›®ï¼ˆä¸€èˆ¬è¿™ç±»é¢˜ç›®éƒ½æ˜¯çœ‹ä½ äº†ä¸äº†è§£ C/C++ä¸­å­—ç¬¦æ•°ç»„åˆå§‹åŒ–ä¼šæºå¸¦ç»“æŸç¬¦ã€æ•°ç»„ä¼šè‡ªåŠ¨é€€åŒ–æˆæŒ‡é’ˆã€ç©ºç±»é»˜è®¤å 1ä¸ªå­—èŠ‚ç­‰..ï¼‰</li>
<li>å†…å­˜å¯¹é½æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦å†…å­˜å¯¹é½ï¼Ÿ</li>
<li>å…³äºå†…å­˜çš„çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼ˆæŒ‡é’ˆæ˜¯å€¼ä¼ é€’ã€å †å†…å­˜å’Œæ ˆå†…å­˜çš„åŒºåˆ«ç­‰ç­‰ï¼‰</li>
<li><code>std::future</code>äº†è§£å—ï¼Ÿ</li>
</ol>
<h3 id="å¤è¯•">å¤è¯•</h3>
<ol type="1">
<li>èŠä¸€èŠä½ å¯¹é¢å‘å¯¹è±¡ç‰¹æ€§ï¼Œå°è£…ã€ç»§æ‰¿ã€å¤šæ€çš„ç†è§£</li>
<li>æŠ½è±¡å·¥å‚æ¨¡å¼çš„å…·ä½“å®ç°ï¼Ÿæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</li>
<li>è™šå‡½æ•°åŸç†ï¼ˆåŒæ ·èŠçš„ä¹Ÿæ¯”è¾ƒæ·±ï¼‰</li>
<li>ç±»çš„æˆå‘˜å‡½æ•°æ€ä¹ˆåˆ†è¾¨ä¸åŒå¯¹è±¡å®ä¾‹ï¼ˆéé™æ€æˆå‘˜å‡½æ•°è°ƒç”¨æ—¶ä¼šéšå¼ä¼ é€’thisæŒ‡é’ˆï¼Œç„¶åé€šè¿‡offsetè®¿é—®å¯¹è±¡çš„æˆå‘˜å˜é‡ã€‚ä¼šé€†å‘çš„ä¸å¯èƒ½ä¸çŸ¥é“è¿™ä¸ªï¼‰</li>
<li>vectorå’Œlistçš„åŒºåˆ«ï¼Œvectoræ˜¯å¦‚ä½•æ‰©å®¹çš„ï¼Ÿæ‰©å®¹æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li>
<li>STLé‡Œçš„ç®—æ³•ï¼Œå®¹å™¨æ˜¯å¦‚ä½•è”ç³»åœ¨ä¸€èµ·çš„ï¼Ÿï¼ˆè¿­ä»£å™¨ã€ç±»å‹èƒå–ã€‚è¿˜å¥½çœ‹è¿‡STLæºç è§£æï¼Œå“ˆå“ˆï¼‰</li>
<li>è¯´ä¸€è¯´epoll</li>
<li>ä½ çš„çº¿ç¨‹æ± æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</li>
<li><code>std::future</code>æ˜¯å¹²å˜›çš„ï¼Œèƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li>
<li>çº¿ç¨‹åŒæ­¥æœ‰å“ªäº›æ–¹æ³•ï¼Ÿå®é™…åº”ç”¨æ—¶å¦‚ä½•åšæŠ‰æ‹©ï¼Ÿ</li>
<li>æ™ºèƒ½æŒ‡é’ˆshared_ptrçš„åŸç†ï¼Ÿ</li>
<li>weak_ptrå’Œshared_ptrçš„åŒºåˆ«ï¼Ÿåº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>make_sharedçš„ä¼˜åŠ¿æœ‰å“ªäº›ï¼Ÿï¼ˆå¯ä»¥ç”¨autoä¿è¯è¯­å¥ç®€æ´ã€ä¿è¯äº†å¼‚å¸¸å®‰å…¨ã€‚æ²¡è¯´å‡ºæ€§èƒ½ä¼˜åŠ¿ï¼šmake_sharedä¼šä¸€æ¬¡æ€§åœ¨å †ä¸Šåˆ†é…è¶³å¤Ÿå®¹çº³æ§åˆ¶å—å’Œç®¡ç†å¯¹è±¡çš„å†…å­˜ã€‚è€Œä½¿ç”¨æ„é€ å‡½æ•°ä¼šè§¦å‘äºŒæ¬¡å †åˆ†é…ï¼Œäº§ç”Ÿé¢å¤–çš„å¼€é”€ï¼‰</li>
<li>åé—®ç¯èŠ‚</li>
</ol>
<p>è¿™å®¶æ„Ÿè§‰é¢è¯•éš¾åº¦åº”è¯¥æ˜¯æœ€å¤§çš„äº†ï¼Œéœ€è¦å†™è¿™ä¹ˆå¤šç®—æ³•é¢˜...</p>
<h1 id="éŸ³è§†é¢‘cå¼€å‘-æœªå‘offer">éŸ³è§†é¢‘C++å¼€å‘ ï¼ˆæœªå‘Offerï¼‰</h1>
<p>è¿›æ¥ä¾æ—§æ˜¯ç¬”è¯•é¢˜</p>
<ol type="1">
<li>sizeofçš„é¢˜ç›®</li>
<li><code>i += (i++)</code>, <code>i += (++i)</code>ï¼Œ<code>(++i) += (i++)</code>, <code>(i++) += (i++)</code>çš„å¼±æ™ºé¢˜ç›®...æˆ‘å‘Šè¯‰é¢è¯•å®˜é™¤äº†æœ€åä¸€ä¸ªä¼šæŠ¥é”™ï¼ˆi++æ˜¯å³å€¼ï¼Œæ— æ³•+=ï¼‰ï¼Œå…¶ä»–é¢˜ç›®çœ‹ä¸å‡ºæœ‰å•¥å®é™…çš„è€ƒæ ¸æ„ä¹‰ï¼Œé¡ºä¾¿è¡¨ç¤ºè°è¦æ˜¯åœ¨çœŸæ­£çš„å¼€å‘ä¸­å†™å‡ºè¿™ç§ä»£ç ï¼Œæˆ‘éæ‰“æ­»ä»–ä¸å¯ï¼ˆå½“æ—¶é¢è¯•å®˜å¥½åƒå¯¹æˆ‘çš„æƒ³æ³•ä¸å¤ªè®¤åŒï¼‰ã€‚</li>
<li>æ‰‹å†™åœ¨ä¸€ä¸ªæ•°ç»„é‡Œæ‰¾åˆ°ç¬¬äºŒå¤§çš„æ•°ï¼ˆå†™çš„O(N)çš„å®ç°ï¼Œå½“æ—¶è¡¨ç¤ºè¿˜æœ‰æ’åºçš„æ–¹æ³•ï¼Œä½†æ—¶é—´å¤æ‚åº¦æ˜¯O(NlogN))</li>
<li>æ‰‹å†™æ·»åŠ èŠ‚ç‚¹åˆ°é“¾è¡¨å°¾éƒ¨</li>
<li>æ‰‹å†™åˆ é™¤é“¾è¡¨ä¸­æŒ‡å®šèŠ‚ç‚¹ ï¼ˆè¿™é¢˜é¢è¯•å®˜è¯´è¯´æœ‰é—®é¢˜ï¼Œæˆ‘å†çœ‹äº†ä¸€éï¼Œç¡®å®šæ²¡é—®é¢˜ï¼Œç»™ä»–è®²äº†ä¸€éï¼Œä»–å‘ç°æ˜¯ä»–é”™äº†ï¼‰</li>
</ol>
<p>è‡ªæ­¤ï¼Œè¿™ä¸ªé¢è¯•å®˜æ¼ç¾æˆæ€’ï¼Œå¼€å§‹æ•…æ„åˆéš¾æˆ‘...</p>
<p>é—®ç­”ç¯èŠ‚ï¼š</p>
<p>å¼€å§‹é—®é¡¹ç›® 1. æˆ‘è§‰å¾—ä½ çš„çº¿ç¨‹æ± é—®é¢˜å¾ˆå¤§ 2. æˆ‘è§‰å¾—ä½ è¿™ä¸ªå°é¡¶å †æœ‰é—®é¢˜ 3. æˆ‘è§‰å¾—ä½ è¿™æ ·åšï¼Œæ€§èƒ½ä¼šå¾ˆå·®å‘€</p>
<p>å’Œä»–è§£é‡Šäº†åŠå¤©ï¼Œå‘ç°ä»–è¿å°é¡¶å †éƒ½ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œå°±æ˜¯ä¸ºäº†æ•…æ„åˆéš¾æˆ‘ï¼Œæ‰€ä»¥æˆ‘åé¢ç›´æ¥æ‹æ¡Œå­èµ°äººäº†</p>
<p>ä½“éªŒæœ€å·®åŠ²çš„ä¸€æ¬¡é¢è¯•ï¼ŒçœŸæ˜¯å®¶åƒåœ¾å…¬å¸...</p>
<h1 id="ä¿¡æ¯å®‰å…¨goå¼€å‘-å·²å‘offer">ä¿¡æ¯å®‰å…¨Goå¼€å‘ ï¼ˆå·²å‘Offerï¼‰</h1>
<p>leaderç›´æ¥å¾®ä¿¡è”ç³»çš„æˆ‘ï¼Œè¡¨ç¤ºçœ‹è¿‡æˆ‘çš„Githubå’Œåšå®¢ï¼ŒæŠ€æœ¯æ–¹é¢å¾ˆä¿¡ä»»ï¼Œå°±æ²¡æ€ä¹ˆé—®æŠ€æœ¯é—®é¢˜</p>
<ol type="1">
<li>è‡ªæˆ‘ä»‹ç»</li>
<li>ç›®å‰æ‰‹ä¸ŠOfferæƒ…å†µ</li>
<li>åé—®ç¯èŠ‚</li>
</ol>
<p>è¡¨ç¤ºå¯¹äººæ‰çš„æ¸´æœ›ï¼Œå¹¶å¼€å‡ºäº†å¾ˆæœ‰ç«äº‰åŠ›çš„è–ªèµ„ï¼Œéå¸¸å¥½çš„leaderã€‚æœŸå¾…ä»¥åå¯ä»¥æœ‰åˆä½œ</p>
<h1 id="ä¿¡æ¯å®‰å…¨cå¼€å‘å·²å‘offer">ä¿¡æ¯å®‰å…¨C++å¼€å‘ï¼ˆå·²å‘Offerï¼‰</h1>
<p>æ²¡æœ‰ç¬”è¯•ï¼Œæ²¡æœ‰ç®—æ³•ï¼Œé¢è¯•éš¾åº¦ä¸å¤§</p>
<ol type="1">
<li>è‡ªæˆ‘ä»‹ç»</li>
<li>Windowså†…æ ¸äº†è§£åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿï¼ˆring3è¿›å…¥ring0çš„è¿‡ç¨‹ï¼ŒSSDT/SSSDTï¼Œ32ä½ä¸‹SSDT Hookï¼Œè¿›ç¨‹/çº¿ç¨‹çš„å†…æ ¸ç»“æ„åŠä¸Linuxç³»ç»Ÿçš„ä¸åŒï¼‰</li>
<li>ä½ ä»¥å‰å®ä¹ ç”¨è¿‡Vueï¼Œè¯·ä½ è§£é‡Šä¸€ä¸‹Vueæ•°æ®ç»‘å®šçš„åŸç†ï¼ˆå› ä¸ºæˆ‘å¥³æœ‹å‹æ˜¯å†™å‰ç«¯çš„ï¼Œè€Œä¸”æ­£å¥½æ˜¯Vueæ–¹å‘çš„ï¼Œæ‰€ä»¥è¿™é¢˜æˆ‘å½“ç„¶çƒ‚ç†Ÿäºå¿ƒï¼Œå“ˆå“ˆï¼‰</li>
<li>çœ‹åˆ°ä½ æŠ€æœ¯åšå®¢é‡Œæœ‰Sundayç®—æ³•ï¼Œè¯·ä½ è§£é‡Šä¸€ä¸‹Sundayç®—æ³•</li>
<li>ä½ çš„æ”¹è¿›ç‰ˆSundayç®—æ³•æ˜¯å¦‚ä½•å®ç°æ”¯æŒé€šé…ç¬¦çš„ï¼Ÿ</li>
<li>C++çš„ä¸€äº›åŸºç¡€é¢˜</li>
<li>ä½ è§‰å¾—ä½ è‡ªå·±æœ€å¤§çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>ä½ è§‰å¾—ä½ è‡ªå·±æœ€å¤§çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>ä½ åœ¨ä»¥å‰çš„é¡¹ç›®å¼€å‘ä¸­ï¼Œé‡åˆ°æœ€å¤§çš„éš¾é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>ä½ å¯¹ä¿¡æ¯å®‰å…¨çš„ç†è§£ï¼Ÿ</li>
<li>ä½ çŸ¥é“å“ªäº›çš„æ”»å‡»æ–¹å¼ï¼Œä½ æœ‰è¿‡å®æˆ˜å—ï¼Ÿï¼ˆXSSæ”»å‡»è¿˜çœŸæœ‰å®æˆ˜ç»éªŒï¼‰</li>
<li>åé—®ç¯èŠ‚</li>
</ol>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>å…±é¢è¯•äº†9å®¶ï¼Œ7å®¶æ‹¿åˆ°äº†Offer</p>
<p>ç›®å‰å·²ç­¾æœ€åä¸€å®¶ä¿¡æ¯å®‰å…¨å…¬å¸</p>
]]></content>
      <categories>
        <category>é¢è¯•ç»éªŒ</category>
      </categories>
      <tags>
        <tag>ç®—æ³•</tag>
        <tag>C++</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
        <tag>æ“ä½œç³»ç»Ÿ</tag>
        <tag>æ•°æ®ç»“æ„</tag>
        <tag>é¢è¯•ç»éªŒ</tag>
      </tags>
  </entry>
  <entry>
    <title>libmemifæºç åˆ†æ</title>
    <url>/2021/09/26/libmemif-source-code-analysis/</url>
    <content><![CDATA[<h1 id="libmemif">libmemif</h1>
<p>memifæ˜¯Mmeory Interfaceçš„ç¼©å†™ï¼Œmemifåº“å®ç°äº†è¿›ç¨‹é—´<strong>é«˜æ€§èƒ½</strong>æ•°æ®åŒ…ä¼ è¾“</p>
<h1 id="ä¸ºä»€ä¹ˆé«˜æ€§èƒ½">ä¸ºä»€ä¹ˆé«˜æ€§èƒ½ï¼Ÿ</h1>
<ul>
<li>å…±äº«å†…å­˜å®ç°è¿›ç¨‹é—´é€šä¿¡</li>
<li>æ— é”ç¯å½¢ç¼“å†²åŒº + æ‰¹é‡æ”¶å‘ + åŒç¼“å†²å®ç°æ•°æ®åŒ…ä¼ è¾“</li>
<li>epollå®ç°äº‹ä»¶æ¨¡å¼</li>
</ul>
<blockquote>
<p>ç¯å½¢ç¼“å†²åŒºä¹Ÿç§°ä¸ºå¾ªç¯é˜Ÿåˆ—</p>
</blockquote>
<h1 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h1>
<ul>
<li>æ”¯æŒå¤šçº¿ç¨‹</li>
<li>æ”¯æŒ0æ‹·è´</li>
<li>æ”¯æŒepollå¤–éƒ¨å¤„ç†</li>
<li>æ”¯æŒä¸­æ–­(äº‹ä»¶)æ¨¡å¼æˆ–è½®è¯¢æ¨¡å¼</li>
</ul>
<a id="more"></a>
<h1 id="å¸¸ç”¨ç»“æ„ä½“">å¸¸ç”¨ç»“æ„ä½“</h1>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** \brief Memifè¿æ¥å‚æ•°</span></span><br><span class="line"><span class="comment">    @param socket - Memif socket å¥æŸ„, ä¸º NULL æ—¶ä½¿ç”¨é»˜è®¤ socket.</span></span><br><span class="line"><span class="comment">		    é»˜è®¤å¥—æ¥å­—ä»…åœ¨å…¨å±€æ•°æ®åº“ä¸­å—æ”¯æŒï¼ˆå‚è§memif_initï¼‰ã€‚</span></span><br><span class="line"><span class="comment">            è‡ªå®šä¹‰æ•°æ®åº“ä¸åˆ›å»ºé»˜è®¤å¥—æ¥å­—ï¼ˆå‚è§memif_per_thread_initï¼‰ã€‚</span></span><br><span class="line"><span class="comment">            Memifè¿æ¥ä¸å¥—æ¥å­—å­˜å‚¨åœ¨åŒä¸€æ•°æ®åº“ä¸­.</span></span><br><span class="line"><span class="comment">    @param secret - ç”¨ä½œèº«ä»½éªŒè¯çš„å¯é€‰å‚æ•°</span></span><br><span class="line"><span class="comment">    @param num_s2m_rings - ä¸»æœºåˆ°ä»æœºçš„ç¯å½¢ç¼“å†²åŒºæ•°é‡</span></span><br><span class="line"><span class="comment">    @param num_m2s_rings -  ä»æœºåˆ°ä¸»æœºçš„ç¯å½¢ç¼“å†²åŒºæ•°é‡</span></span><br><span class="line"><span class="comment">    @param buffer_size - å…±äº«å†…å­˜ä¸­ç¼“å†²åŒºçš„å¤§å°</span></span><br><span class="line"><span class="comment">    @param log2_ring_size - ç¯å½¢ç¼“å†²åŒºçš„å¤§å°ï¼ˆä»¥2ä¸ºåº•çš„å¯¹æ•°ï¼‰</span></span><br><span class="line"><span class="comment">    @param is_master - 0 == ä¸»æœº, 1 == ä»æœº</span></span><br><span class="line"><span class="comment">    @param interface_id - ç”¨äºæ ‡è¯†å¯¹ç­‰è¿æ¥çš„id</span></span><br><span class="line"><span class="comment">    @param interface_name - æ¥å£å</span></span><br><span class="line"><span class="comment">    @param mode - 0 == ä»¥å¤ªç½‘ï¼ˆè¿è¡Œåœ¨2å±‚ï¼‰, 1 == ipï¼ˆè¿è¡Œåœ¨3å±‚ï¼‰ , 2 == punt/inject</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">memif_socket_handle_t</span> socket;	<span class="comment">/*!&lt; é»˜è®¤ = /run/vpp/memif.sock */</span></span><br><span class="line">  <span class="type">uint8_t</span> secret[<span class="number">24</span>];		<span class="comment">/*!&lt; å¯é€‰ (èº«ä»½éªŒè¯) */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> num_s2m_rings;	<span class="comment">/*!&lt; é»˜è®¤ = 1 */</span></span><br><span class="line">  <span class="type">uint8_t</span> num_m2s_rings;	<span class="comment">/*!&lt; é»˜è®¤ = 1 */</span></span><br><span class="line">  <span class="type">uint16_t</span> buffer_size;		<span class="comment">/*!&lt; é»˜è®¤ = 2048 */</span></span><br><span class="line">  <span class="type">uint8_t</span> log2_ring_size;	<span class="comment">/*!&lt; é»˜è®¤ = 10 (1 &lt;&lt; 10 = 1024) */</span></span><br><span class="line">  <span class="type">uint8_t</span> is_master;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> interface_id;</span><br><span class="line">  <span class="type">uint8_t</span> interface_name[<span class="number">32</span>];</span><br><span class="line">  <span class="type">memif_interface_mode_t</span> mode:<span class="number">8</span>;</span><br><span class="line">&#125; <span class="type">memif_conn_args_t</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** \brief Memif æ•°æ®åŒ…ç¼“å†²åŒº</span></span><br><span class="line"><span class="comment">    @param desc_index - ç¯å½¢ç¼“å†²åŒºæè¿°ç¬¦ç´¢å¼•</span></span><br><span class="line"><span class="comment">    @param ring - æŒ‡å‘åŒ…å«æ­¤ç¼“å†²åŒºæè¿°ç¬¦çš„ç¯å½¢ç¼“å†²åŒºçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">    @param len - æ•°æ®æœ‰æ•ˆé•¿åº¦</span></span><br><span class="line"><span class="comment">    @param flags - æ ‡å¿—ä½</span></span><br><span class="line"><span class="comment">    @param data - æŒ‡å‘å…±äº«å†…å­˜æ•°æ®çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint16_t</span> desc_index;</span><br><span class="line">  <span class="type">void</span> *ring;</span><br><span class="line">  <span class="type">uint32_t</span> len;</span><br><span class="line"><span class="comment">/** è¡¨ç¤ºbufferä¸å¤Ÿå¤§ï¼Œæ— æ³•åŒ…å«æ•´ä¸ªæ•°æ®åŒ…ï¼Œå› æ­¤ä¸‹ä¸€ä¸ªç¼“å†²å™¨åŒ…å«åŒ…çš„å…¶ä½™éƒ¨åˆ†ï¼ˆé“¾å¼ç¼“å†²åŒºï¼‰ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MEMIF_BUFFER_FLAG_NEXT (1 &lt;&lt; 0)</span></span><br><span class="line"><span class="comment">/** è¡¨ç¤ºbufferæ¥è‡ªRxç¯å½¢ç¼“å†²åŒº */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MEMIF_BUFFER_FLAG_RX (1 &lt;&lt; 1)</span></span><br><span class="line">  <span class="type">uint8_t</span> flags;</span><br><span class="line">  <span class="type">void</span> *data;</span><br><span class="line">&#125; <span class="type">memif_buffer_t</span>;</span><br></pre></td></tr></table></figure>
<h1 id="å¸¸ç”¨api">å¸¸ç”¨API</h1>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** \brief Memif åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">    @param on_control_fd_update - æ–‡ä»¶æè¿°ç¬¦äº‹ä»¶è½®è¯¢å›è°ƒå‡½æ•°ï¼ˆç”¨äºè‡ªå®šä¹‰epollï¼‰</span></span><br><span class="line"><span class="comment">    @param app_name - åº”ç”¨ç¨‹åºåç§°ï¼ˆè¢«æˆªæ–­ä¸º32ä¸ªå­—ç¬¦ï¼‰</span></span><br><span class="line"><span class="comment">    @param memif_alloc - è‡ªå®šä¹‰å†…å­˜åˆ†é…å™¨, NULL = é»˜è®¤ï¼ˆmallocï¼‰</span></span><br><span class="line"><span class="comment">    @param memif_realloc - è‡ªå®šä¹‰å†…å­˜é‡åˆ†é…å™¨, NULL = é»˜è®¤ï¼ˆreallocï¼‰</span></span><br><span class="line"><span class="comment">    @param memif_free - è‡ªå®šä¹‰å†…å­˜é‡Šæ”¾å™¨, NULL = é»˜è®¤ï¼ˆfreeï¼‰</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    å¦‚æœå‚æ•°on_control_fd_updateè®¾ç½®ä¸ºNULLï¼Œlibmemifå°†åœ¨å†…éƒ¨å¤„ç†æ–‡ä»¶æè¿°ç¬¦äº‹ä»¶è½®è¯¢å¦‚æœè®¾ç½®äº†æœ‰æ•ˆçš„å›è°ƒï¼Œåˆ™éœ€è¦é€šè¿‡ç”¨æˆ·åº”ç”¨ç¨‹åºï¼Œæ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ç±»å‹éƒ½å°†ä¼ å…¥æ­¤å›è°ƒå°†è¿”å›åˆ°ç”¨æˆ·åº”ç”¨ç¨‹åº</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    åˆå§‹åŒ–å†…éƒ¨libmemifç»“æ„ã€‚åˆ›å»ºtimerfdï¼ˆç”¨äºåœ¨ä»å±æ¨¡å¼ä¸‹é€šè¿‡æ–­å¼€è¿æ¥çš„memifså®šæœŸè¯·æ±‚è¿æ¥ï¼Œæ— éœ€é¢å¤–çš„APIè°ƒç”¨ï¼‰ã€‚æ­¤fdé€šè¿‡memif_control_fd_update_tä¼ é€’ç»™ç”¨æˆ·</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    è®¡æ—¶å™¨åœ¨æ­¤çŠ¶æ€ä¸‹å¤„äºéæ´»åŠ¨çŠ¶æ€ã€‚å¦‚æœåœ¨ä»å±æ¨¡å¼ä¸‹è‡³å°‘æœ‰ä¸€ä¸ªmemifï¼Œåˆ™ä¼šæ¿€æ´»ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    \return memif_err_t</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">memif_init</span> <span class="params">(<span class="type">memif_control_fd_update_t</span> * on_control_fd_update,</span></span><br><span class="line"><span class="params">		<span class="type">char</span> *app_name, <span class="type">memif_alloc_t</span> * memif_alloc,</span></span><br><span class="line"><span class="params">		<span class="type">memif_realloc_t</span> * memif_realloc, <span class="type">memif_free_t</span> * memif_free)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** \brief åˆ›å»ºå†…å­˜æ¥å£å¹¶è¿æ¥</span></span><br><span class="line"><span class="comment">    @param conn - è¿”å›è¿æ¥å¥æŸ„ [out]</span></span><br><span class="line"><span class="comment">    @param args - è¿æ¥å‚æ•°</span></span><br><span class="line"><span class="comment">    @param on_connect - è¿æ¥ä¸Šè§¦å‘çš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment">    @param on_disconnect - æ–­å¼€è¿æ¥è§¦å‘çš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment">    @param on_interrupt - é€šçŸ¥ç”¨æˆ·ä¸­æ–­ï¼Œå¦‚æœè®¾ç½®ä¸ºnullï¼Œåˆ™ä¸ä¼šé€šçŸ¥ç”¨æˆ·ä¸­æ–­ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨memif_get_queue_efdè°ƒç”¨è·å–ä¸­æ–­fdä»¥è½®è¯¢äº‹ä»¶</span></span><br><span class="line"><span class="comment">    @param private_ctx - é€šè¿‡å›è°ƒä¼ é€’å›ç”¨æˆ·çš„ä¸Šä¸‹æ–‡æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ä¸»æœºæ¨¡å¼ -</span></span><br><span class="line"><span class="comment">        Start timer that will send events to timerfd. If this fd is passed to memif_control_fd_handler</span></span><br><span class="line"><span class="comment">        every disconnected memif in slave mode will send connection request.</span></span><br><span class="line"><span class="comment">        On success new fd is passed to user with memif_control_fd_update_t.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ä»æœºæ¨¡å¼ -</span></span><br><span class="line"><span class="comment">        Create listener socket and pass fd to user with memif_control_fd_update_t.</span></span><br><span class="line"><span class="comment">        If this fd is passed to memif_control_fd_handler accept will be called and</span></span><br><span class="line"><span class="comment">        new fd will be passed to user with memif_control_fd_update_t.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    \return memif_err_t</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">memif_create</span> <span class="params">(<span class="type">memif_conn_handle_t</span> * conn, <span class="type">memif_conn_args_t</span> * args,</span></span><br><span class="line"><span class="params">		  <span class="type">memif_connection_update_t</span> * on_connect,</span></span><br><span class="line"><span class="params">		  <span class="type">memif_connection_update_t</span> * on_disconnect,</span></span><br><span class="line"><span class="params">		  <span class="type">memif_interrupt_t</span> * on_interrupt, <span class="type">void</span> *private_ctx)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** \brief å‘é€ç¼“å†²åŒºè„‰å†²</span></span><br><span class="line"><span class="comment">    @param conn - è¿æ¥å¥æŸ„</span></span><br><span class="line"><span class="comment">    @param qid - é˜Ÿåˆ—ID</span></span><br><span class="line"><span class="comment">    @param bufs - æ•°æ®åŒ…ç¼“å†²åŒº(æ•°ç»„)</span></span><br><span class="line"><span class="comment">    @param count - è¦ä¼ è¾“çš„æ•°æ®åŒ…ç¼“å†²åŒºæ•°é‡</span></span><br><span class="line"><span class="comment">    @param tx - è¿”å›å·²ä¼ è¾“çš„æ•°æ®åŒ…ç¼“å†²åŒºæ•°é‡ [out]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    \return memif_err_t</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">memif_tx_burst</span> <span class="params">(<span class="type">memif_conn_handle_t</span> conn, <span class="type">uint16_t</span> qid,</span></span><br><span class="line"><span class="params">		    <span class="type">memif_buffer_t</span> * bufs, <span class="type">uint16_t</span> count, <span class="type">uint16_t</span> * tx)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** \brief æ¥å—ç¼“å†²åŒºè„‰å†²</span></span><br><span class="line"><span class="comment">    @param conn - è¿æ¥å¥æŸ„</span></span><br><span class="line"><span class="comment">    @param qid - é˜Ÿåˆ—ID</span></span><br><span class="line"><span class="comment">    @param bufs - æ•°æ®åŒ…ç¼“å†²åŒº(æ•°ç»„)</span></span><br><span class="line"><span class="comment">    @param count - è¦æ¥æ”¶çš„æ•°æ®åŒ…ç¼“å†²åŒºæ•°é‡</span></span><br><span class="line"><span class="comment">    @param rx - è¿”å›å·²æ¥æ”¶çš„æ•°æ®åŒ…ç¼“å†²åŒºæ•°é‡ [out]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ä¸ºæ¥æ”¶é˜Ÿåˆ—æ¶ˆè€—ä¸­æ–­äº‹ä»¶.</span></span><br><span class="line"><span class="comment">    å¦‚æœmemif_rx_burstå¤±è´¥ï¼Œåˆ™äº‹ä»¶ä¸ä¼šè¢«æ¶ˆè´¹.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    \return memif_err_t</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">memif_rx_burst</span> <span class="params">(<span class="type">memif_conn_handle_t</span> conn, <span class="type">uint16_t</span> qid,</span></span><br><span class="line"><span class="params">		    <span class="type">memif_buffer_t</span> * bufs, <span class="type">uint16_t</span> count, <span class="type">uint16_t</span> * rx)</span>;</span><br></pre></td></tr></table></figure>
<h1 id="æºç åˆ†æ">æºç åˆ†æ</h1>
<blockquote>
<p>ä¸‹æ–‡ä¸­çš„<strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>æŒ‡çš„æ˜¯å»ºç«‹socketè¿æ¥åï¼Œlibmemifä½¿ç”¨å•é“¾è¡¨å®ç°çš„ç®€å•é˜Ÿåˆ—ï¼Œç”¨äºè¿›è¡Œå»ºç«‹è¿æ¥ç±»çš„æ¶ˆæ¯é€šè®¯</p>
</blockquote>
<blockquote>
<p>ä¸‹æ–‡ä¸­çš„<strong>æ•°æ®ä¼ è¾“é˜Ÿåˆ—</strong>æŒ‡çš„æ˜¯å»ºç«‹memifè¿æ¥åï¼Œlibmemifä½¿ç”¨å…±äº«å†…å­˜å®ç°çš„ç¯å½¢ç¼“å†²åŒºï¼Œç”¨äºè¿›è¡Œæ•°æ®åŒ…çš„ä¼ è¾“</p>
</blockquote>
<img data-src="/2021/09/26/libmemif-source-code-analysis/control.drawio.png" class="">
<h2 id="åˆå§‹åŒ–memif_initæµç¨‹">åˆå§‹åŒ–<code>memif_init</code>æµç¨‹</h2>
<ol type="1">
<li>æ³¨å†Œè‡ªå®šä¹‰å†…å­˜ç®¡ç†å‡½æ•°</li>
<li>æ³¨å†Œè‡ªå®šä¹‰epollè½®è¯¢å›è°ƒå‡½æ•°</li>
<li>åˆå§‹åŒ–è¿æ¥åˆ—è¡¨ã€ä¸­æ–­åˆ—è¡¨ã€socketåˆ—è¡¨ç­‰</li>
<li>åˆ›å»ºå®šæ—¶å™¨ï¼Œå¹¶åˆå§‹åŒ–ä¸º2ç§’(ç”¨äºé‡è¿)</li>
<li>åˆ›å»ºé»˜è®¤memif_socket_tç»“æ„ä½“ï¼ˆæ³¨æ„ï¼ä¸æ˜¯socketï¼‰</li>
</ol>
<h2 id="åˆ›å»ºmemif_createæµç¨‹">åˆ›å»º<code>memif_create</code>æµç¨‹</h2>
<ol type="1">
<li>å°†è¿æ¥å‚æ•°ã€å›è°ƒå‡½æ•°ç­‰æ·»åŠ åˆ°memif_sockeçš„interface_listé‡Œ</li>
<li>å¦‚æœæ˜¯ä¸»æœºï¼Œå°±å¼€å§‹ç›‘å¬è¿æ¥ï¼ˆç›‘å¬åˆ°çš„ä»æœºsocketè¿æ¥æ·»åŠ socket_listé‡Œï¼Œå¹¶æŒ‚åˆ°epollä¸Šï¼‰</li>
<li>å¦‚æœæ˜¯ä»æœºï¼Œå°±å°†è¿æ¥å‚æ•°æ·»åŠ åˆ°control_listé‡Œï¼ˆç”±äºè¿˜æ²¡è¿ä¸Šä¸»æœºï¼Œæ‰€ä»¥æ­¤æ—¶contort_listé‡Œçš„fdæ˜¯-1ï¼‰ï¼Œå¹¶å°è¯•è¿æ¥åˆ°ä¸»æœºï¼ˆå¦‚æœè¿æ¥å¤±è´¥å°±å¯åŠ¨å®šæ—¶å™¨ä¸€ç›´å°è¯•é‡è¿ï¼‰</li>
</ol>
<h2 id="è¯·æ±‚è¿æ¥memif_request_connectionæµç¨‹">è¯·æ±‚è¿æ¥<code>memif_request_connection</code>æµç¨‹</h2>
<ol type="1">
<li>åˆ›å»º<code>AF_UNIX</code>åŸŸsocketï¼Œå°è¯•è¿æ¥åˆ°ä¸»æœº</li>
<li>æ³¨å†Œsocketçš„è¯»ã€å†™å›è°ƒï¼ˆå…³é”®ï¼è¯»å›è°ƒç”¨äºä¸ä¸»æœºè¿›è¡Œç®€å•çš„é€šä¿¡ã€‚åå•†åˆ›å»ºå…±äº«å†…å­˜åŸŸã€ç¯å½¢ç¼“å†²åŒºç­‰ç­‰ï¼Œå†™å›è°ƒç”¨äºå‘é€æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ç»™å¯¹ç«¯ï¼‰</li>
<li>ä¿®æ”¹control_listé‡Œçš„fdä¸ºsocketçš„fdï¼Œå¹¶å°†fdæŒ‚åˆ°epollä¸Šï¼ˆç”¨äºé€šçŸ¥è¯»ã€å†™å›è°ƒï¼‰</li>
<li>ï¼ˆå¦‚æœè¿æ¥å¤±è´¥å°±å¯åŠ¨å®šæ—¶å™¨ä¸€ç›´å°è¯•é‡è¿ï¼‰</li>
</ol>
<h2 id="ä¸»æœºacceptåæµç¨‹">ä¸»æœºacceptåæµç¨‹</h2>
<ol type="1">
<li>ç›´æ¥å‘é€HELLOæ¶ˆæ¯ï¼ˆä¸ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼‰</li>
</ol>
<h2 id="helloæ¶ˆæ¯å¤„ç†æµç¨‹">HELLOæ¶ˆæ¯å¤„ç†æµç¨‹</h2>
<ol type="1">
<li>åå•†é˜Ÿåˆ—æ•°é‡ã€å•ä¸ªæ•°æ®åŒ…å¤§å°ã€‚è·å–å¯¹ç«¯æ¥å£åç­‰</li>
<li>åˆå§‹åŒ–å…±äº«å†…å­˜åŸŸå’Œå¾ªåé˜Ÿåˆ—(æ•°æ®ä¼ è¾“é˜Ÿåˆ—ã€æ¶ˆæ¯ä¼ è¾“é˜Ÿåˆ—)</li>
<li>æ¥å£å¯†ç ï¼ˆå¯é€‰ï¼‰æ¶ˆæ¯å…¥é˜Ÿ</li>
<li>å…±äº«å†…å­˜åŸŸã€ç¯å½¢ç¼“å†²åŒºçš„ä¿¡æ¯å…¥é˜Ÿ</li>
</ol>
<h2 id="initæ¶ˆæ¯å¤„ç†æµç¨‹">INITæ¶ˆæ¯å¤„ç†æµç¨‹</h2>
<ol type="1">
<li>å¤„ç†æ¥å£å¯†ç ï¼ˆå¯é€‰ï¼‰å…¥é˜Ÿ</li>
<li>ACKå…¥é˜Ÿ</li>
</ol>
<h2 id="åˆ›å»ºæ•°æ®ä¼ è¾“é˜Ÿåˆ—æµç¨‹">åˆ›å»ºæ•°æ®ä¼ è¾“é˜Ÿåˆ—æµç¨‹</h2>
<ol type="1">
<li>æ ¹æ®è¿æ¥å‚æ•°ï¼Œå…ˆåˆ›å»ºåˆé€‚å¤§å°çš„å…±äº«å†…å­˜</li>
<li>å°†å…±äº«å†…å­˜åˆ†ä¸º2ä¸ªåŒºåŸŸï¼ŒåŒºåŸŸ0å­˜å‚¨ç¯å½¢ç¼“å†²åŒºçš„ä¿¡æ¯ï¼›åŒºåŸŸ1å­˜å‚¨å…·ä½“çš„æ•°æ®åŒ…å†…å®¹</li>
<li>åˆ›å»ºæ•°æ®ä¼ è¾“é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ•°æ®ä¼ è¾“é˜Ÿåˆ—æœ‰2ä¸ªç¯å½¢ç¼“å†²åŒºï¼šRxå’ŒTx</li>
<li>ä¸ºæ¯ä¸ªç¯å½¢ç¼“å†²åŒºéƒ½åˆ›å»ºä¸€ä¸ªeventfd</li>
</ol>
<blockquote>
<p>eventfdç”¨äºå†™å…¥æ•°æ®åï¼Œè§¦å‘å¯¹ç«¯çš„ä¸­æ–­on_interruptå›è°ƒ</p>
</blockquote>
<h2 id="ä¼ é€æ•°æ®åŒ…memif_tx_burstè¿‡ç¨‹">ä¼ é€æ•°æ®åŒ…<code>memif_tx_burst</code>è¿‡ç¨‹</h2>
<ol type="1">
<li>æ ¹æ®é˜Ÿåˆ—IDæ‹¿åˆ°å¯¹åº”çš„Txç¯å½¢ç¼“å†²åŒº(ä¸‹æ–‡ç§°ä¸ºring)</li>
<li>è®¡ç®—æ©ç ï¼ˆç”¨äºç¡®å®šæ•°æ®åŒ…ç¼“å†²åŒºåœ¨ringä¸­çš„ä½ç½®ï¼‰</li>
<li>å¾ªç¯è¦ä¼ è¾“çš„æ•°æ®åŒ…</li>
<li>ä½¿ç”¨å†…å­˜å±éšœä¿è¯æ‰€æœ‰æ•°æ®åŒ…å·²ç»æ­£ç¡®å†™å…¥é•¿åº¦</li>
<li>è§¦å‘å¯¹ç«¯çš„ä¸­æ–­on_interruptå›è°ƒ</li>
</ol>
<h2 id="æ¥æ”¶æ•°æ®åŒ…memif_rx_burstè¿‡ç¨‹">æ¥æ”¶æ•°æ®åŒ…<code>memif_rx_burst</code>è¿‡ç¨‹</h2>
<ol type="1">
<li>æ ¹æ®é˜Ÿåˆ—IDæ‹¿åˆ°å¯¹åº”çš„Rxç¯å½¢ç¼“å†²åŒº(ä¸‹æ–‡ç§°ä¸ºring)</li>
<li>è®¡ç®—æ©ç ï¼ˆç”¨äºç¡®å®šæ•°æ®åŒ…ç¼“å†²åŒºåœ¨ringä¸­çš„ä½ç½®ï¼‰</li>
<li>å¾ªç¯å–å‡ºæ•°æ®åŒ…</li>
<li>å¦‚æœæ˜¯ä»æœºï¼Œåœ¨å–å®Œæ•°æ®åéœ€è¦é‡ç½®æ•°æ®åŒ…ç¼“å†²åŒºå¤§å°</li>
<li>è®°å½•ä¸‹è¿™æ¬¡å·²ç»å¤„ç†å®Œringçš„ç´¢å¼•ï¼ˆç”¨äºä¸‹æ¬¡ç¡®å®šä»ringçš„å“ªé‡Œå¼€å§‹è¯»å–æ•°æ®åŒ…ï¼‰</li>
</ol>
<h1 id="æ‰©å±•çŸ¥è¯†">æ‰©å±•çŸ¥è¯†</h1>
<h2 id="ä¸ºå•¥ç¯å½¢ç¼“å†²åŒºé«˜æ€§èƒ½">ä¸ºå•¥ç¯å½¢ç¼“å†²åŒºé«˜æ€§èƒ½ï¼Ÿ</h2>
<p>å½“ä¸€ä¸ªæ•°æ®å…ƒç´ è¢«ç”¨æ‰åï¼Œå…¶ä½™æ•°æ®å…ƒç´ ä¸éœ€è¦ç§»åŠ¨å…¶å­˜å‚¨ä½ç½®ï¼Œä»è€Œå‡å°‘æ‹·è´æé«˜æ•ˆç‡</p>
<h2 id="ä¸ºå•¥å¾ªç¯ç¼“å†²åŒºçš„å¤§å°åªèƒ½æ˜¯ä»¥2ä¸ºåº•çš„å¯¹æ•°">ä¸ºå•¥å¾ªç¯ç¼“å†²åŒºçš„å¤§å°åªèƒ½æ˜¯ä»¥2ä¸ºåº•çš„å¯¹æ•°ï¼Ÿ</h2>
<p>å®ç°ç¯å½¢ç¼“å†²åŒºéœ€è¦ä½¿ç”¨<strong>å–æ¨¡è¿ç®—</strong>ï¼ˆç”¨äºç¡®å®šå¤´ã€å°¾æŒ‡é’ˆåœ¨ç¯ä¸­çš„ä½ç½®ï¼‰</p>
<p>è€Œä¼—æ‰€å‘¨çŸ¥ä½è¿ç®—æ˜¯æœ€å¿«çš„ä¸€ç»„è¿ç®—ï¼Œå½“ç„¶ä¹Ÿæ¯”å–æ¨¡è¿ç®—å¿«</p>
<p>è€Œæ‰€æœ‰ä»¥2ä¸ºç¬¬çš„å¯¹æ•°ï¼Œéƒ½å¯ä»¥å°†å–æ¨¡è¿ç®—è½¬æ¢æˆä½è¿ç®—</p>
<p>å³ï¼šè‹¥ $ M = 2^x $ä¸” <span class="math inline">\(x\)</span> ä¸ºè‡ªç„¶æ•°ï¼Œåˆ™ä»¥ä¸‹å…¬å¼æˆç«‹ <span class="math display">\[ M \bmod N =  M\ \\\&amp;\ (\ N\ -\ 1\ ) \]</span></p>
<p>æ‰€ä»¥<code>8 % 7</code>å°±å¯ä»¥å†™æˆ <code>8 &amp; (7 - 1)</code>ï¼Œæé«˜äº†è¿ç®—æ€§èƒ½</p>
<details>
<p><summary>ç­‰å¼è¯æ˜</summary></p>
<p>å‡è®¾$ M = 8 = 2^3 <span class="math inline">\(ï¼Œé‚£ä¹ˆ\)</span> M - 1 = 7 $ï¼ŒäºŒè¿›åˆ¶ä¸º<code>0000 0111b</code></p>
<ol type="1">
<li><p>è‹¥ $ M &lt; 8 $ï¼Œ $ M = M $ , $ M  = M $ï¼Œç­‰å¼æˆç«‹</p></li>
<li><p>è‹¥ $ M &gt; 8 <span class="math inline">\(ï¼Œ\)</span> M = 2<sup>a+2</sup>b+2^c+... $ æ¯”å¦‚ï¼Œ$ 51 = 1+2+16+32 = 2<sup>0+2</sup>1+2<sup>4+2</sup>5 $ ï¼Œæ±‚ $ 51  $æ—¶ï¼Œç”±äº7çš„äºŒè¿›åˆ¶æ˜¯<code>0000 0111b</code>ï¼Œæ‰€ä»¥2çš„å¹‚åªè¦å¤§äºç­‰äº<span class="math inline">\(2^3\)</span>çš„æ•°ï¼Œä¸ä¸Š7ç»“æœéƒ½æ˜¯0ï¼Œæ‰€ä»¥$ 2^4  = 0 , 2^5 \&amp; 7 = 0, (2<sup>0+2</sup>1+2<sup>4+2</sup>5) \&amp; (7) = 2<sup>0+2</sup>1=3 <span class="math inline">\(ã€‚è€Œæ ¹æ®ç»“è®º1ï¼Œ\)</span>(2<sup>0+2</sup>1) \&amp; 7 = (2<sup>0+2</sup>1)  <span class="math inline">\(ï¼Œæ‰€ä»¥\)</span> 51 \&amp; 7=51  $</p></li>
</ol>
<p>ç»¼ä¸Šå¾—è¯ã€‚</p>
</details>
<h2 id="ä¸ºå•¥å¯ä»¥å®ç°æ— é”å¹¶å‘">ä¸ºå•¥å¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Ÿ</h2>
<ol type="1">
<li><p><code>volatile</code>å…³é”®å­—</p></li>
<li><p>å†…å­˜å±éšœ</p></li>
<li><p><code>volatile</code>å…³é”®å­—é˜»æ­¢äº†ç¼–è¯‘å™¨ä¸ºäº†æé«˜é€Ÿåº¦å°†å˜é‡ç¼“å­˜èµ·æ¥ï¼Œè€Œä¿®æ”¹åä¸å†™å›</p></li>
<li><p>å†…å­˜å±éšœé˜»æ­¢äº†ç°ä»£CPUçš„ä¹±åºæ‰§è¡Œï¼Œä¿è¯åœ¨å±éšœä¹‹å‰çš„æŒ‡ä»¤ä¸ä¼šåœ¨å±éšœä¹‹åæ‰§è¡Œ</p></li>
</ol>
<p>è¿™æ ·å°±ä¿è¯äº†ä¼ è¾“æ•°æ®æ—¶ï¼Œæ¯ä¸ªæ•°æ®åŒ…çš„é•¿åº¦éƒ½è¢«æ­£ç¡®å†™å…¥åï¼Œå†é€šçŸ¥å¯¹ç«¯</p>
<p>å¦‚æœä¸åŠ å†…å­˜å±éšœï¼Œå¯èƒ½æ•°æ®ã€æ•°æ®é•¿åº¦è¿˜æ²¡å†™å®Œï¼Œç”±äºCPUçš„ä¹±åºæ‰§è¡Œä¼˜åŒ–ï¼Œå°±é€šçŸ¥å¯¹ç«¯ï¼Œè¿™æ ·è¯»åˆ°çš„ç¼“å†²åŒºå†…çš„æ•°æ®å°±ä¸å®Œæ•´</p>
<blockquote>
<p>åªèƒ½åœ¨å•ç”Ÿäº§/å•æ¶ˆè´¹æ¨¡å¼æ—¶ä¸éœ€è¦åŠ é”åŒæ­¥</p>
</blockquote>
<h2 id="ä¸ºå•¥æºç ä¸­å…³äºsocketæ¶ˆæ¯çš„ç»“æ„ä½“éƒ½æœ‰__attribute__packed">ä¸ºå•¥æºç ä¸­å…³äºsocketæ¶ˆæ¯çš„ç»“æ„ä½“éƒ½æœ‰<code>__attribute__((packed))</code>ï¼Ÿ</h2>
<h3 id="è¿™ä¸ªç¼–è¯‘æŒ‡ä»¤æ˜¯ä»€ä¹ˆ">è¿™ä¸ªç¼–è¯‘æŒ‡ä»¤æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
<p>å‘Šè¯‰ç¼–è¯‘å™¨æŒ‰ç…§å®é™…å ç”¨å­—èŠ‚æ•°è¿›è¡Œ<strong>å†…å­˜å¯¹é½</strong></p>
<h3 id="å­˜åœ¨çš„æ„ä¹‰">å­˜åœ¨çš„æ„ä¹‰ï¼Ÿ</h3>
<p>å…¶å®è¿™é‡Œçš„åšæ³•å’ŒLinuxå†…æ ¸ä¸­å…³äºç½‘ç»œåè®®çš„å®ç°ä¸€è‡´</p>
<p>å› ä¸ºä¸åŒå¹³å°ï¼ˆæŒ‡æ“ä½œç³»ç»Ÿã€ç¼–è¯‘å™¨ç­‰ï¼‰çš„å†…å­˜å¯¹é½æ–¹å¼ä¸åŒï¼Œå¦‚æœä½¿ç”¨ç»“æ„ä½“è¿›è¡Œå¹³å°é—´çš„é€šä¿¡ï¼Œå°±å¯èƒ½ä¼šæœ‰é—®é¢˜</p>
<p>ä¸¾ä¾‹ï¼š å‡è®¾æ²¡æœ‰ä½¿ç”¨ <code>__attribute__((packed))</code></p>
<p>å‘é€æ¶ˆæ¯çš„ç¨‹åºæ˜¯GCCç¼–è¯‘çš„ï¼Œ<code>xxx_msg_t</code>ç»“æ„ä½“é»˜è®¤çš„å†…å­˜å¯¹é½ç­–ç•¥ä¸º24å­—èŠ‚ï¼Œè€Œæ¥å—æ¶ˆæ¯çš„ç¨‹åºæ˜¯å¦ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œè€Œå¦ä¸€ä¸ªç¼–è¯‘å™¨ä¸‹<code>xxx_msg_t</code>ç»“æ„ä½“é»˜è®¤çš„å†…å­˜å¯¹é½ç­–ç•¥ä¸º32å­—èŠ‚ï¼ˆåªæ˜¯éšä¾¿ä¸¾ä¸ªä¾‹å­ï¼‰ï¼Œé‚£ä¹ˆæ¯ä¸ªå˜é‡å¯¹åº”çš„å€¼å°±ä¸å¯¹äº†ã€‚</p>
<h2 id="memif_ring_té‡Œçš„cachelineæ˜¯ä¸ªä»€ä¹ˆç©æ„"><code>memif_ring_t</code>é‡Œçš„cachelineæ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼Ÿ</h2>
<h3 id="cache-lineæ˜¯ä»€ä¹ˆ">Cache Lineæ˜¯ä»€ä¹ˆï¼Ÿ</h3>
<p>ç”±äºCPUé«˜é€Ÿç¼“å­˜çš„å­˜åœ¨ï¼ŒCPUä¸å†æ˜¯æŒ‰å­—èŠ‚è®¿é—®å†…å­˜ï¼Œè€Œæ˜¯ä»¥64å­—èŠ‚ä¸ºå•ä½çš„å—(Chunk)æ‹¿å–ï¼Œç§°ä¸ºä¸€ä¸ªç¼“å­˜è¡Œ(Cache Line)</p>
<p>è€Œå½“ä½ è¯»ä¸€ä¸ªç‰¹å®šçš„å†…å­˜åœ°å€ï¼Œæ•´ä¸ªç¼“å­˜è¡Œå°†ä»ä¸»å­˜/ä½é€Ÿç¼“å­˜æ¢å…¥é«˜é€Ÿç¼“å­˜ï¼Œä»¥æä¾›é«˜é€Ÿè®¿é—®</p>
<blockquote>
<p>è¿™æ—¶å€™æœ‰å¤§èªæ˜è¦é—®äº†ï¼Œä¸ºå•¥CPUä¸èƒ½ç›´æ¥è¯»ä¸»å­˜å‘¢ï¼Œå¤šçœäº‹å•Šï¼Ÿå› ä¸ºCPUè¿è¡Œé€Ÿåº¦æå¿«ï¼Œè€Œä¸»å­˜å®Œå…¨è·Ÿä¸ä¸ŠCPUçš„é€Ÿåº¦ï¼Œç›´æ¥è¯»ä¸»å­˜ä¼šæ‹–ç´¯CPUçš„è¿è¡Œé€Ÿåº¦ï¼ˆCPUé•¿æ—¶é—´å¤„äºç­‰å¾…IOçŠ¶æ€ä¸­ï¼‰</p>
</blockquote>
<h3 id="cache-lineå¯¹é½æ˜¯ä»€ä¹ˆ">Cache Lineå¯¹é½æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œç»“æ„ä½“å†…å­˜ä¼šæŒ‰ç…§æ•°æ®å¤§å°å¯¹é½, è€ŒCache Lineå¯¹é½å°±æ˜¯å°†ç»“æ„ä½“çš„å†…å­˜å¯¹é½åˆ°ä¸Cache Lineçš„å¤§å°ä¸€è‡´</p>
<h3 id="å­˜åœ¨çš„æ„ä¹‰-1">å­˜åœ¨çš„æ„ä¹‰ï¼Ÿ</h3>
<p>Cache Lineå¯¹é½æ˜¯å¯¹CPUç¼“å­˜ä¼˜åŒ–çš„ä¸€ç§æ–¹å¼</p>
<p>ä¸€èˆ¬æ¥è¯´</p>
<p>å¦‚æœæŒ‰æ•°æ®å¤§å°å¯¹é½ï¼Œç»“æ„ä½“é‡Œçš„æ•°æ®å¯èƒ½ä¼šè·¨Cacheè¡Œå­˜æ”¾ï¼ŒCPUè¯»å–æ—¶å°±éœ€è¦è®¿é—®å¤šæ¬¡ç¼“å­˜è¡Œï¼Œå½±å“æ€§èƒ½</p>
<p>è€Œæˆ‘ä»¬å¯ä»¥å°†ç»“æ„ä½“æŒ‰ç…§ä¸€ä¸ªç¼“å­˜è¡Œçš„å¤§å°ï¼ˆ64å­—èŠ‚ï¼‰è¿›è¡Œå†…å­˜å¯¹é½</p>
<p>è¿™æ ·å°±å¯ä»¥ä¸€æ¬¡å°†æ•´ä¸ªç»“æ„ä½“è¯»å…¥Cacheä¸­ï¼Œå‡å°‘CPUé«˜çº§ç¼“å­˜ä¸ä½çº§ç¼“å­˜ã€å†…å­˜çš„æ•°æ®äº¤æ¢æ¬¡æ•°</p>
<p>ä½†åœ¨<code>memif_ring_t</code>ä¸­ï¼Œå…¶å®å¦æœ‰å…¶ä»–æ›´é‡è¦çš„ä½œç”¨</p>
<h3 id="åœ¨memif_ring_té‡Œä½¿ç”¨cache-lineå¯¹é½æ„ä¹‰">åœ¨<code>memif_ring_t</code>é‡Œä½¿ç”¨Cache Lineå¯¹é½æ„ä¹‰ï¼Ÿ</h3>
<ul>
<li>cacheline0çš„ä½œç”¨</li>
</ul>
<p>è¿™è¡Œçš„æ„ä¹‰ä¸æ˜ï¼Œåœ¨GCCä¸‹æœ‰æ²¡æœ‰è¿™è¡Œéƒ½ä¸€æ ·ã€‚ä¸ªäººçŒœæµ‹åº”è¯¥æ˜¯ä¸ºäº†GDBè°ƒè¯•æ—¶æ–¹ä¾¿æŸ¥çœ‹ç»“æ„ä½“çš„å†…å­˜å¸ƒå±€</p>
<ul>
<li>cacheline1å’Œcacheline2çš„ä½œç”¨</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">....</span><br><span class="line">  <span class="keyword">volatile</span> <span class="type">uint16_t</span> head;</span><br><span class="line">    MEMIF_CACHELINE_ALIGN_MARK (cacheline1); </span><br><span class="line">  <span class="keyword">volatile</span> <span class="type">uint16_t</span> tail;</span><br><span class="line">    MEMIF_CACHELINE_ALIGN_MARK (cacheline2);</span><br><span class="line">....</span><br><span class="line">&#125; <span class="type">memif_ring_t</span>;</span><br></pre></td></tr></table></figure>
<p>å¼ºåˆ¶headä¸tailä¸åœ¨åŒçš„Cache Lineä¸­</p>
<h4 id="ä¸ºä»€ä¹ˆéœ€è¦å°†ä¸¤ä¸ªvolatileå˜é‡å­˜åœ¨ä¸åŒçš„cache-lineä¸­">ä¸ºä»€ä¹ˆéœ€è¦å°†ä¸¤ä¸ª<code>volatile</code>å˜é‡å­˜åœ¨ä¸åŒçš„Cache Lineä¸­ï¼Ÿ</h4>
<p>ä¸ºäº†è§£å†³<strong>ä¼ªå…±äº«</strong>çš„é—®é¢˜</p>
<img data-src="/2021/09/26/libmemif-source-code-analysis/volatile.png" class="">
<p>åœ¨å¤šCPUç¯å¢ƒä¸‹ï¼Œé¦–å…ˆæ˜ç¡®<code>volatile</code>å˜é‡åœ¨æŸä¸ªCPUä¿®æ”¹åï¼Œåœ¨å†™å›æ—¶ï¼Œä¼šé€šçŸ¥å…¶ä»–CPUé‡æ–°è¯»å–ç¼“å­˜ï¼Œä»¥ç¡®ä¿ä¸€è‡´æ€§</p>
<img data-src="/2021/09/26/libmemif-source-code-analysis/false-sharing.png" class="">
<p>å¦‚æœ<strong>ä¸¤ä¸ª</strong><code>volatile</code>å˜é‡<code>X</code>å’Œ<code>Y</code>åœ¨<strong>åŒä¸€ä¸ª</strong>Cache Lineï¼Œè€Œè¿™ä¸¤ä¸ªå˜é‡æŸä¸€ä¸ªè¢«ä¿®æ”¹æ—¶ï¼Œç”±äº<code>volatile</code>çš„ç‰¹æ€§ï¼Œå¦ä¸€ä¸ªCPUå°±ä¼šè¢«é€šçŸ¥é‡è¯»ç¼“å­˜ã€‚è¿™ç§æ— è°“çš„é€šçŸ¥å°±æµªè´¹äº†æ€§èƒ½ã€‚è¿™ç§ç°è±¡å°±å«<strong>ä¼ªå…±äº«</strong></p>
<img data-src="/2021/09/26/libmemif-source-code-analysis/cache-line-align.png" class="">
<p>è€Œå°†ä¸¤ä¸ª<code>volatile</code>çš„å˜é‡æ”¾åˆ°ä¸åŒçš„Cache Lineä¸­ï¼Œå°±ä¸éœ€è¦ä¸€ç›´é€šçŸ¥å¦ä¸€ä¸ªCPUæ›´æ–°æ•°æ®äº†ï¼Œå› ä¸ºå¦ä¸€ä¸ªCPUæ ¹æœ¬æ²¡æœ‰ä¹Ÿä¸éœ€è¦è¿™ä¸ªæ•°æ®</p>
<img data-src="/2021/09/26/libmemif-source-code-analysis/GDB.png" class="">
<blockquote>
<p>Linuxä¸‹æŸ¥çœ‹Cache Linuxå¤§å°<code>$ cat /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size</code></p>
</blockquote>
<h2 id="å¦‚ä½•è¿›ä¸€æ­¥æé«˜æ€§èƒ½">å¦‚ä½•è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Ÿ</h2>
<ol start="0" type="1">
<li>memifçš„æœ€å…³é”®çš„æ€§èƒ½ç“¶é¢ˆåœ¨äºæ•°æ®åŒ…çš„æ‹·è´ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•ä½¿ç”¨SIMDï¼ˆAVX2ã€AVX512ï¼‰æŒ‡ä»¤é›†æé«˜æ‹·è´æ€§èƒ½</li>
<li>åœ¨æµé‡å¯†é›†æƒ…å†µä¸‹ä½¿ç”¨è½®è¯¢æ¨¡å¼ï¼Œè€Œéä¸­æ–­æ¨¡å¼ï¼Œå‡å°‘ä¸­æ–­å¼€é”€ï¼ˆå®ç°NAPIï¼‰</li>
<li>ä½¿ç”¨è‡ªå®šä¹‰çš„å†…å­˜ç®¡ç†æ¨¡å—ï¼ˆæ¯”å¦‚å†…å­˜æ± ï¼‰ã€‚ä»¥æé«˜ç¼“å­˜å‘½ä¸­ã€å‡ä½å†…å­˜ç¢ç‰‡åŒ–</li>
<li>å¦‚æœä½ çš„ç¨‹åºä¸­æœ‰å…¶ä»–æ¨¡å—éœ€è¦ä½¿ç”¨åˆ°epollï¼Œè¯·ä½¿ç”¨è‡ªå®šä¹‰çš„epollï¼Œä»¥å‡å°‘å¤šä½™çš„å†…å­˜æ¶ˆè€—ã€ä»¥åŠå¤šä¸ªçº¿ç¨‹epoll_waitçš„å¼€é”€</li>
<li>å®ç°0æ‹·è´ï¼ˆç›´æ¥ä¿®æ”¹æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ï¼Œå†ç›´æ¥é‡æ–°å…¥é˜Ÿï¼‰</li>
<li>ä½¿ç”¨çº¿ç¨‹æ± å®ç°å¤šçº¿ç¨‹ï¼ˆä¸è¦å¼€å¤ªå¤šå·¥ä½œçº¿ç¨‹ï¼Œä¸€èˆ¬ä¸CPUæ ¸å¿ƒæ•°ä¸€è‡´å³å¯ï¼Œå‡å°‘CPUåœ¨çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢æˆæœ¬ï¼‰</li>
</ol>
<blockquote>
<p>epollä½¿ç”¨çº¢é»‘æ ‘å®ç°ï¼Œæä¾›O(logN)çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ï¼Œå³ä½¿å¤§é‡æŒ‚è½½ä¹Ÿæ¯”å¤šå¼€å‡ ä¸ªepollçš„æˆæœ¬ï¼ˆé¢å¤–çš„CPUçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ã€å†…å­˜æˆæœ¬ï¼‰å°</p>
</blockquote>
<h1 id="å¸¸è§qa">å¸¸è§Q&amp;A</h1>
<blockquote>
<p>Q: è¿æ¥ä¸ä¸Šï¼ŒæŠ›å‡º<code>Connection refused</code>å¼‚å¸¸ï¼Œæˆ–åˆšè¿å°±ç›´æ¥è§¦å‘<code>Disconnect</code>äº‹ä»¶</p>
<p>A: æ£€æŸ¥ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´è¿æ¥å‚æ•°æ˜¯å¦ä¸€è‡´ï¼æ¯”å¦‚<code>Socket</code>çš„ä½ç½®ã€<code>Rx / Tx</code>é˜Ÿåˆ—æ•°æ˜¯å¦ä¸€è‡´ç­‰ç­‰</p>
</blockquote>
<blockquote>
<p>Q: æ— æ³•å‘å…±äº«å†…å­˜ç¼“å†²åŒº<code>memif_buffer_t</code>ä¸­æ‹·è´æ•°æ®ï¼ŒæŠ›å‡º<code>segmentation fault</code>å¼‚å¸¸</p>
<p>A: æ£€æŸ¥æ˜¯å¦æ‰‹åŠ¨ä¸ºå…±äº«å†…å­˜ç¼“å†²åŒº<code>memif_buffer_t</code>åˆ†é…å†…å­˜ã€‚æ³¨æ„ï¼šè¿™é‡Œçš„æ‰‹åŠ¨åˆ†é…å†…å­˜ä¸æ˜¯æŒ‡è°ƒç”¨<code>memif_buffer_alloc</code></p>
</blockquote>
<blockquote>
<p>Q: è¿æ¥æ­£å¸¸ï¼Œä½†å‘å‡ºå»çš„æ•°æ®å¯¹é¢æ”¶ä¸åˆ°ï¼Œä¹Ÿéƒ½ä¸æŠ›å‡ºå¼‚å¸¸</p>
<p>A: æ£€æŸ¥å¯¹æ–¹æ˜¯å¦æ­£ç¡®çš„å®ç°äº†<code>on_interrupt</code>æˆ–è½®è¯¢</p>
</blockquote>
<blockquote>
<p>Q: æˆ‘æƒ³ç”¨æˆ‘è‡ªå·±çš„epollï¼ˆè‡ªå·±å¤„ç†epolläº‹ä»¶ï¼‰æ€ä¹ˆåŠ?</p>
<p>A: <code>memif_init</code>æ—¶ä¼ å…¥epolläº‹ä»¶çš„å›è°ƒï¼Œå¯ä»¥å‚è€ƒ<code>/examples/icmp_responder-epoll</code>ä¸­çš„å®ç°</p>
</blockquote>
<blockquote>
<p>Q: <code>memif_init</code>æŠ¥é”™æ€ä¹ˆåŠ?</p>
<p>A: ç¡®ä¿ä½ çš„<code>memif_init</code>æ•´ä¸ªè¿›ç¨‹è¿è¡Œæ—¶åªè¢«è°ƒç”¨è¿‡ä¸€æ¬¡</p>
</blockquote>
]]></content>
      <categories>
        <category>memif</category>
      </categories>
      <tags>
        <tag>æ“ä½œç³»ç»Ÿ</tag>
        <tag>æ•°æ®ç»“æ„</tag>
        <tag>C</tag>
        <tag>ç¼“å­˜</tag>
        <tag>é«˜æ€§èƒ½</tag>
        <tag>æºç åˆ†æ</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸€é¢˜å¼•å‡ºC++å†…å­˜ç®¡ç†å’Œè®¾è®¡åŸåˆ™</title>
    <url>/2021/01/15/mem-managerment-and-design-principles/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>æœ€è¿‘åœ¨åˆ·LeetCodeï¼Œæ˜¨å¤©åšåˆ°äº†è¿™ä¸€é¢˜ <a href="https://leetcode-cn.com/problems/delete-node-in-a-linked-list/">237. åˆ é™¤é“¾è¡¨ä¸­çš„èŠ‚ç‚¹</a>ï¼Œé¢˜ç›®å¾ˆç®€å•ï¼Œå®˜æ–¹é¢˜è§£ä¸­ï¼Œç»™å‡ºçš„Javaä»£ç å¦‚ä¸‹ <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteNode</span><span class="params">(ListNode node)</span> &#123;</span><br><span class="line">    node.val = node.next.val;</span><br><span class="line">    node.next = node.next.next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½œè€…ï¼šLeetCode</span></span><br><span class="line"><span class="comment">// é“¾æ¥ï¼šhttps://leetcode-cn.com/problems/delete-node-in-a-linked-list/solution/shan-chu-lian-biao-zhong-de-jie-dian-by-leetcode/</span></span><br><span class="line"><span class="comment">// æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰</span></span><br></pre></td></tr></table></figure> å¯ä»¥çœ‹å‡ºï¼Œå®˜æ–¹é¢˜è§£çš„æ€è·¯æ˜¯ç›´æ¥å°†è‡ªèº«<strong>æ›¿æ¢</strong>æˆäº†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</p>
<p>æˆ‘å¹³æ—¶ä½¿ç”¨C++æ¥åšé¢˜ï¼Œä½†å¦‚æœç®€å•çš„å°†ä¸Šè¿°ä»£ç ä¿®æ”¹æˆC++å°±å¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡çš„<strong>å†…å­˜æ³„æ¼</strong>äº‹æ•…</p>
<a id="more"></a>
<h1 id="cå†…å­˜é‡Šæ”¾">C++å†…å­˜é‡Šæ”¾</h1>
<p>å¤§å®¶éƒ½çŸ¥é“Javaæ˜¯æœ‰åƒåœ¾å›æ”¶ä¹Ÿå°±æ˜¯GCçš„ï¼Œæ‰€ä»¥ä¸Šè¿°ä»£ç åœ¨Javaä¸­æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºè¢«æ›¿æ¢æ‰çš„èŠ‚ç‚¹ä¼šç”±GCæ¥é‡Šæ”¾</p>
<p>è€Œåœ¨C++ä¸­ï¼Œæ¯ä¸€ä¸ªè¢«<code>new</code>å‡ºæ¥çš„<em>åŸç”ŸæŒ‡é’ˆ</em>(<em>Raw Pinter</em>)éƒ½å¿…é¡»ä½¿ç”¨<code>delete</code>é‡Šæ”¾ï¼Œä¸é‡Šæ”¾ä¼šå†…å­˜æ³„æ¼</p>
<p>é‚£æˆ‘ä»¬ç›´æ¥å†™æˆä¸‹é¢è¿™æ ·</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">deleteNode</span><span class="params">(ListNode* node)</span> </span>&#123;</span><br><span class="line">        ListNode* del = node-&gt;next;</span><br><span class="line">        node-&gt;val = node-&gt;next-&gt;val;</span><br><span class="line">        node-&gt;next = node-&gt;next-&gt;next;</span><br><span class="line">        <span class="keyword">delete</span> del;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å¯èƒ½åˆ°è¿™é‡Œï¼Œå¤§éƒ¨åˆ†äººå°±è§‰å¾—OKäº†ï¼Œä¸‡æ— ä¸€å¤±äº†ã€‚</p>
<p>ä½†C++ä¸­çš„å¯¹è±¡æ˜¯åˆ†ä¸º<em>é™æ€åˆ†é…</em>å’Œ<em>åŠ¨æ€åˆ†é…</em>çš„</p>
<p>ç¡®å®åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯æ²¡æœ‰é—®é¢˜äº†ï¼Œä½†ï¼Œ<code>delete</code>åªèƒ½ç”¨äºé‡Šæ”¾å †æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯<code>new</code>å‡ºæ¥çš„æŒ‡é’ˆï¼Œè€Œä¸èƒ½ç”¨äºæ ˆæŒ‡é’ˆã€‚</p>
<p>æ‰€ä»¥ä»¥ä¸‹ä»£ç åœ¨VC++ Debugä¸‹ä¼šæŠ›å‡º<code>_CrtIsValidHeapPointer(block)</code>æˆ–<code>is_block_type_valid(header-&gt;block_use)</code>å¼‚å¸¸ï¼Œå› ä¸ºCè¿è¡Œæ—¶æ£€æµ‹åˆ°äº†ä½ è¦<code>delete</code>çš„æŒ‡é’ˆä¸æ˜¯ä¸€ä¸ªå †æŒ‡é’ˆ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">ListNode <span class="title">a</span><span class="params">(<span class="number">4</span>)</span>, <span class="title">b</span><span class="params">(<span class="number">5</span>)</span>, <span class="title">c</span><span class="params">(<span class="number">1</span>)</span>, <span class="title">d</span><span class="params">(<span class="number">9</span>)</span></span>;</span><br><span class="line">    a.next = &amp;b;</span><br><span class="line">    b.next = &amp;c;</span><br><span class="line">    c.next = &amp;d;</span><br><span class="line"></span><br><span class="line">    Solution solution;</span><br><span class="line">    solution.<span class="built_in">deleteNode</span>(&amp;b);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶æœ‰äººè¦è¯´äº†ï¼Œè¿™æ˜¯ä¸ªé“¾è¡¨èŠ‚ç‚¹å•Šï¼Œè°ä¼šé™æ€åˆ†é…å•Šï¼Œé™æ€åˆ†é…ä¸å°±æ²¡æ„ä¹‰äº†å˜›ï¼</p>
<p>ä½†ä¸ºäº†ä»¥é˜²ä¸‡ä¸€ï¼Œè¿˜æ˜¯éœ€è¦ä½¿ç”¨è®¾è®¡æ¥é™åˆ¶<code>NodeList</code>åªèƒ½åŠ¨æ€åˆ†é…</p>
<h1 id="åªèƒ½åŠ¨æ€åˆ†é…">åªèƒ½åŠ¨æ€åˆ†é…</h1>
<p>ç®€å•æ¥è¯´ï¼Œåªéœ€è¦å°†æ„é€ ã€ææ„å‡½æ•°è®¾ä¸º<code>protected</code>å±æ€§ï¼Œå†å°†å°†åŠ¨æ€åˆ†é…çš„èŒè´£ç»™åˆ°é™æ€å‡½æ•°å³å¯</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ListNode</span> &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">ListNode</span>(<span class="type">int</span> x) : <span class="built_in">val</span>(x), <span class="built_in">next</span>(<span class="literal">NULL</span>) &#123;&#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    ListNode* next;</span><br><span class="line">    <span class="function"><span class="type">static</span> ListNode* <span class="title">create</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ListNode</span>(x); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ListNode a(4);  é”™è¯¯ï¼š æ„é€ å‡½æ•°ä¸å¯è®¿é—®</span></span><br><span class="line">    ListNode* a = ListNode::<span class="built_in">create</span>(<span class="number">4</span>);</span><br><span class="line">    ListNode* b = ListNode::<span class="built_in">create</span>(<span class="number">5</span>);</span><br><span class="line">    ListNode* c = ListNode::<span class="built_in">create</span>(<span class="number">1</span>);</span><br><span class="line">    ListNode* d = ListNode::<span class="built_in">create</span>(<span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">    a-&gt;next = b;</span><br><span class="line">    b-&gt;next = c;</span><br><span class="line">    c-&gt;next = d;</span><br><span class="line"></span><br><span class="line">    Solution solution;</span><br><span class="line">    solution.<span class="built_in">deleteNode</span>(b);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¯ä»¥ä¿è¯<code>deleteNode</code>å‡½æ•°ä¸ä¼š<code>delete</code>åˆ°æ ˆæŒ‡é’ˆäº†</p>
<h1 id="è®¾è®¡åŸåˆ™">è®¾è®¡åŸåˆ™</h1>
<h2 id="å­˜åœ¨çš„é”™è¯¯">å­˜åœ¨çš„é”™è¯¯</h2>
<p>ç»è¿‡ä¸Šé¢çš„æ”¹é€ ï¼Œå¤§éƒ¨åˆ†äººå¯èƒ½å°±è§‰å¾—æ²¡æœ‰å•¥é—®é¢˜äº†ã€‚ä½†å®˜æ–¹ç»™å‡ºçš„â€œ<strong>åˆ é™¤</strong>â€çœŸçš„æ˜¯åˆ é™¤å—ï¼Ÿ</p>
<p>å¾ˆæ˜¾ç„¶è¿™ä¸æ˜¯çœŸæ­£çš„åˆ é™¤äº†è¯¥åˆ é™¤çš„èŠ‚ç‚¹ï¼Œè€Œæ˜¯å°†åŸèŠ‚ç‚¹ä¿®æ”¹äº†å€¼ã€‚</p>
<img data-src="/2021/01/15/mem-managerment-and-design-principles/debug.png" class="">
<p>åœ¨Dbuegä¸‹çœ‹åˆ°ï¼Œ<code>deleteNode</code>å‡½æ•°ä»è¯­ä¹‰ä¸Šçœ‹æ˜¯åˆ é™¤äº†<code>b</code>èŠ‚ç‚¹ï¼Œä½†å®é™…ä¸Šï¼Œ<code>b</code>èŠ‚ç‚¹è¿˜å­˜åœ¨ï¼Œè€Œ<code>c</code>èŠ‚ç‚¹å´è¢«<code>delete</code>äº†ã€‚</p>
<p>è¿™å°±è¦å¼•å‡ºå¦ä¸€ä¸ªé—®é¢˜äº†ï¼Œå¦‚æœåœ¨<code>deleteNode</code>å‰åœ¨ä½¿ç”¨<code>c</code>èŠ‚ç‚¹æœ¬èº«ï¼Œé‚£å°±å¯èƒ½å¼•å‘ä¸ç¡®å®šè¡Œä¸ºã€‚</p>
<h2 id="å¯¹é¢˜ç›®çš„åæ€">å¯¹é¢˜ç›®çš„åæ€</h2>
<p>ç”±äº<code>ListNode</code>æ˜¯ä¸ªå•é“¾è¡¨èŠ‚ç‚¹ï¼Œè€Œå•é“¾è¡¨èŠ‚ç‚¹æœ¬è´¨ä¸Šæ˜¯æ— æ³•åšåˆ°åœ¨é“¾è¡¨é‡Œåˆ é™¤è‡ªèº«çš„ï¼Œæ‰€ä»¥è¿™é¢˜åªèƒ½é€šè¿‡è¿™ç§æ›¿æ¢çš„æ–¹å¼æ¥ä¼ªé€ åˆ é™¤äº†èŠ‚ç‚¹ã€‚</p>
<p>è¿™é¢˜ä¼šè¯¯å¯¼å¾ˆå¤šå¼€å‘è€…ï¼Œè¿™é¢˜çš„è®¾è®¡æ¨¡å¼æ›´æ˜¯ä¸å¯å–ï¼</p>
<p>ä¸ªäººè®¤ä¸ºè¿™é¢˜åº”è¯¥åˆ é™¤</p>
<p>è€Œ<a href="https://leetcode-cn.com/problems/remove-linked-list-elements/">203. ç§»é™¤é“¾è¡¨å…ƒç´ </a>è¿™é¢˜æ‰æ˜¯çœŸæ­£çš„ç§»é™¤é“¾è¡¨å…ƒç´ ï¼</p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>å†…å­˜ç®¡ç†</tag>
        <tag>è®¾è®¡åŸåˆ™</tag>
      </tags>
  </entry>
  <entry>
    <title>è™šå‡½æ•°è¡¨ï¼ˆVMTï¼‰Hook</title>
    <url>/2020/12/07/vmt-hook/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p><strong>è™šå‡½æ•°è¡¨ï¼ˆVMTï¼‰Hook</strong>ï¼Œåˆå«æŒ‡é’ˆé‡å®šå‘ï¼Œæ˜¯ä¸€ç§å¸¸è§çš„HookæŠ€æœ¯ï¼Œåœ¨æ¸¸æˆå¤–æŒ‚ç¨‹åºä¸­æœ€å¸¸è§ã€‚ä¸”å¤šç”¨äºåœ¨Direct3D / OpenGLå¼•æ“æ¸¸æˆé‡Œå®ç°å†…ç½®å åŠ å±‚ã€‚</p>
<h1 id="è™šå‡½æ•°è¡¨vmt">è™šå‡½æ•°è¡¨ï¼ˆVMTï¼‰</h1>
<blockquote>
<p>æœ¬æ–‡ä¸­VMTå°±ä»£æŒ‡è™šå‡½æ•°è¡¨ã€‚</p>
</blockquote>
<p>è™šå‡½æ•°è¡¨æ˜¯C++å®ç°å¤šæ€çš„ä¸€ç§æ–¹å¼ã€‚</p>
<p>æ¯ä¸€ä¸ªæœ‰è™šå‡½æ•°çš„ç±»ï¼ˆæˆ–æœ‰è™šå‡½æ•°ç±»çš„æ´¾ç”Ÿç±»ï¼‰éƒ½æœ‰ä¸€ä¸ªVMTï¼ŒVMTæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œé€šå¸¸ä½äºå¯¹è±¡å†…å­˜å¸ƒå±€çš„å¼€å¤´æˆ–ç»“å°¾ã€‚æ¯å½“C++ç±»å£°æ˜è™š(<code>virtual</code>)å‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨éƒ½ä¼šå¢åŠ ä¸€ä¸ªæ¡ç›®åˆ°VMTä¸­ã€‚</p>
<a id="more"></a>
<p>ä¾‹å¦‚ï¼Œåœ¨x86ç³»ç»Ÿä¸Šä½¿ç”¨VS2019ç¼–è¯‘ä»¥ä¸‹ä»£ç ï¼š <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Base</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;-  Base::Base\n&quot;</span>; &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Base</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;-  Base::~Base\n&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">A</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;-  Base::A\n&quot;</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">B</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;-  Base::B\n&quot;</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">C</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;-  Base::C\n&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> <span class="keyword">final</span> : <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Derived</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;-  Derived::Derived\n&quot;</span>; &#125;</span><br><span class="line">    ~<span class="built_in">Derived</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;-  Derived::~Derived\n&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">B</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;-  Derived::B\n&quot;</span>; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">C</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;-  Derived::C\n&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure> <code>Base</code>ç±»æœ‰ä¸‰ä¸ªè™šå‡½æ•°ï¼š<code>~Base</code>ã€<code>B</code>å’Œ<code>C</code>. <code>Derived</code>ç±»æ´¾ç”Ÿè‡ª<code>Base</code>ï¼Œå¹¶é‡å†™äº†ä¸¤ä¸ªè™šå‡½æ•°<code>B</code>hå’Œ<code>C</code>.</p>
<p>è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸‰ä¸ªå®ä¾‹ <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">Base base;</span><br><span class="line">Derived derived;</span><br><span class="line">Base* pBase = <span class="keyword">new</span> <span class="built_in">Derived</span>();</span><br></pre></td></tr></table></figure> æˆ‘ä»¬æŠŠä»£ç è·‘èµ·æ¥ï¼Œç”¨è°ƒè¯•å™¨è§‚å¯Ÿï¼Œå‘ç°<code>Base</code>å®ä¾‹çš„VMTåŒ…å«äº†<code>~Base</code>ã€<code>B</code>å’Œ<code>C</code></p>
<img data-src="/2020/12/07/vmt-hook/base.png" class="">
<p>è€Œä¸¤ä¸ª<code>Derived</code>å®ä¾‹çš„VMTåŒ…å«äº†<code>~Derived</code>ã€<code>B</code>å’Œ<code>C</code>ã€‚ä½†VMTé‡Œçš„å‡½æ•°åœ°å€ä¸<code>Base</code>å®ä¾‹ä¸­çš„ä¸ä¸€æ ·ï¼ˆè§ä¸‹å›¾ï¼‰</p>
<img data-src="/2020/12/07/vmt-hook/derived.png" class="">
<img data-src="/2020/12/07/vmt-hook/pBase.png" class="">
<p>é‚£ä¹ˆåº”è¯¥å¦‚ä½•ä½¿ç”¨è¿™äº›å‡½æ•°å‘¢ï¼Ÿ</p>
<p>ä»¥ä¸€ä¸ªå‡½æ•°ä¸ºä¾‹ï¼Œè¯¥å‡½æ•°è·å–ä¸€ä¸ªæŒ‡å‘<code>Base</code>çš„æŒ‡é’ˆå¹¶è°ƒç”¨å‡½æ•°<code>A</code>ï¼Œ<code>B</code>å’Œ<code>C</code>ï¼š <figure class="highlight cpp"><figcaption><span>Invoke</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Invoke</span><span class="params">(Base* <span class="type">const</span> pBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pBase-&gt;<span class="built_in">A</span>();</span><br><span class="line">    pBase-&gt;<span class="built_in">B</span>();</span><br><span class="line">    pBase-&gt;<span class="built_in">C</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> ä»¥ä»¥ä¸‹æ–¹å¼è°ƒç”¨ï¼š <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Invoke</span>(&amp;base);</span><br><span class="line"><span class="built_in">Invoke</span>(&amp;derived);</span><br><span class="line"><span class="built_in">Invoke</span>(pBase);</span><br></pre></td></tr></table></figure></p>
<p>å°†<code>Invoke</code>å‡½æ•°åæ±‡ç¼–ï¼Œçœ‹çœ‹åœ¨æ±‡ç¼–å±‚é¢ï¼ŒVMTå†…çš„å‡½æ•°æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼š &gt; å¯ä»¥å°†RTCå…³é—­ï¼ˆé¡¹ç›®å±æ€§-&gt;C/C++-&gt;ä»£ç ç”Ÿæˆ-&gt;åŸºæœ¬è¿è¡Œæ—¶æ£€æŸ¥-&gt;é»˜è®¤å€¼ï¼‰ï¼Œçœå»__RTC_CheckEspç­‰æ£€æŸ¥ï¼Œè®©åæ±‡ç¼–ä»£ç æ›´ç®€æ´ &gt; <img data-src="/2020/12/07/vmt-hook/invoke-asm.png" class=""></p>
<p>å¯¹äº<code>B</code>çš„è°ƒç”¨ï¼Œç¼–è¯‘å™¨å°†<code>pBase</code>ä¹Ÿå°±æ˜¯å¯¹è±¡çš„åœ°å€ç§»å…¥<code>EAX</code>å¯„å­˜å™¨ï¼Œç„¶åé—´æ¥è·å–VTMçš„åŸºåœ°å€ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨<code>EDX</code>å¯„å­˜å™¨ä¸­ã€‚é€šè¿‡<code>EDX</code>ä½œä¸ºç´¢å¼•+4å°†å‡½æ•°åœ°å€å­˜å‚¨åœ¨<code>EAX</code>å¯„å­˜å™¨ä¸­ï¼Œç„¶åè°ƒç”¨<code>EAX</code></p>
<p>å¯¹<code>C</code>çš„è°ƒç”¨å¦‚å‡ºä¸€è¾™ï¼Œåªæ˜¯VMTä¸­å‡½æ•°åœ°å€çš„åç§»é‡ä¸º8ã€‚</p>
<p>ç”±æ­¤å¯è§ï¼ŒVMTçš„åº•å±‚å®ç°å°±æ˜¯ä¸€ä¸ª<strong>å‡½æ•°æŒ‡é’ˆæ•°ç»„</strong>ã€‚</p>
<p>æ˜ç™½äº†VMTè°ƒç”¨çš„åŸç†ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾ˆè½»æ¾çš„å†™ä¸€ä¸ªå‡½æ•°æ¥æ‰“å°VMT: <figure class="highlight cpp"><figcaption><span>PrintVTable</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintVTable</span><span class="params">(Base* <span class="type">const</span> pBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> pVTableBase = *<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>***&gt;(pBase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;First: %p\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Second: %p\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Third: %p\n&quot;</span>,</span><br><span class="line">        pVTableBase[<span class="number">0</span>] , pVTableBase[<span class="number">1</span>], pVTableBase[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> # VMT Hookçš„å®ç° æ˜ç™½äº†VMTè°ƒç”¨çš„åŸç†ï¼Œå½“ç„¶ä¹Ÿå°±å¯ä»¥è½»æ¾çš„å®ç°Hookäº†ã€‚</p>
<p>æˆ‘ä»¬åªè¦è¦†ç›–æ‰éœ€è¦Hookçš„å‡½æ•°åœ¨VMTä¸­çš„åœ°å€å³å¯ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆVMT Hookä¹Ÿå«æŒ‡é’ˆé‡å®šå‘ã€‚ <figure class="highlight cpp"><figcaption><span>HookVMT</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">HookVMT</span><span class="params">(Base* <span class="type">const</span> pBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> pVTableBase = *<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>***&gt;(pBase);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ulOldProtect = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">VirtualProtect</span>(&amp;pVTableBase[<span class="number">1</span>], <span class="built_in">sizeof</span>(<span class="type">void</span>*), PAGE_EXECUTE_READWRITE, &amp;ulOldProtect);</span><br><span class="line">    pVTableBase[<span class="number">1</span>] = VMTHookFnc;</span><br><span class="line">    <span class="built_in">VirtualProtect</span>(&amp;pVTableBase[<span class="number">1</span>], <span class="built_in">sizeof</span>(<span class="type">void</span>*), ulOldProtect, &amp;ulOldProtect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><figcaption><span>VMTHookFnc</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">VMTHookFnc</span><span class="params">(<span class="type">void</span>* pEcx, <span class="type">void</span>* pEdx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Base* pThisPtr = (Base*)pEcx;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;In VMTHookFnc\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™é‡Œåˆ©ç”¨<code>__fastcall</code>è°ƒç”¨çº¦å®šç”¨æ¥è·å–<code>this</code>æŒ‡é’ˆ</p>
</blockquote>
<p>æˆåŠŸHookä½è™šå‡½æ•°<code>B</code>!</p>
<img data-src="/2020/12/07/vmt-hook/output.png" class="">
<p>åˆ©ç”¨è°ƒè¯•å™¨ï¼Œè¿›å…¥Hookå‡½æ•°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°<code>this</code>æŒ‡é’ˆVMTé‡Œçš„<code>B</code>å·²ç»è¢«æ›¿æ¢æˆäº†<code>VMTHookFuc</code></p>
<img data-src="/2020/12/07/vmt-hook/hooked-ptr.png" class="">
<h1 id="å°è£…">å°è£…</h1>
<p>å‰©ä¸‹çš„å°±æ˜¯å°è£…äº†</p>
<p>è¿™é‡Œçš„å‘½åè§„åˆ™éµå¾ªSTLæ ‡å‡†åº“çš„å°å†™è§„åˆ™</p>
<p>è¿™é‡Œçš„å®ç°æ˜¯æ•´ä¸ªVMTæ›¿æ¢ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æ–¹ä¾¿çš„å®ç°è·å–åŸå‡½æ•°ã€‚ <figure class="highlight cpp"><figcaption><span>vmt_hook.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">vmt_hook</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">vmt_hook</span>(<span class="type">void</span>* obj, <span class="type">size_t</span> num_funcs);</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">hook</span><span class="params">(<span class="type">size_t</span> index, <span class="type">void</span>* func)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">unhook</span><span class="params">(<span class="type">size_t</span> index)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">	<span class="function">T <span class="title">get_original</span><span class="params">(<span class="type">size_t</span> index)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">enable</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">disable</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="type">void</span>*** m_object;</span><br><span class="line">	<span class="type">size_t</span> m_num_funcs;</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span>** m_original_table;</span><br><span class="line">	std::unique_ptr&lt;<span class="type">void</span>*[]&gt; m_new_table;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> T <span class="title">vmt_hook::get_original</span><span class="params">(<span class="type">size_t</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;T&gt;(m_original_table[index]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><figcaption><span>vmt_hook.cpp</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vmt_hook.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">vmt_hook::<span class="built_in">vmt_hook</span>(<span class="type">void</span>* obj, <span class="type">size_t</span> num_funcs) :</span><br><span class="line">	<span class="built_in">m_object</span>(<span class="built_in">static_cast</span>&lt;<span class="type">void</span>***&gt;(obj)),</span><br><span class="line">	<span class="built_in">m_num_funcs</span>(num_funcs + <span class="number">1</span>),</span><br><span class="line">	<span class="built_in">m_original_table</span>(*m_object),</span><br><span class="line">	<span class="built_in">m_new_table</span>(std::<span class="built_in">make_unique</span>&lt;<span class="type">void</span>*[]&gt;(m_num_funcs))</span><br><span class="line">&#123;</span><br><span class="line">	std::<span class="built_in">copy_n</span>(m_original_table - <span class="number">1</span>, m_num_funcs, m_new_table.<span class="built_in">get</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">vmt_hook::hook</span><span class="params">(<span class="type">size_t</span> index, <span class="type">void</span>* func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_new_table[index + <span class="number">1</span>] = func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">vmt_hook::unhook</span><span class="params">(<span class="type">size_t</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_new_table[index + <span class="number">1</span>] = m_original_table[index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">vmt_hook::enable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	*m_object = m_new_table.<span class="built_in">get</span>() + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">vmt_hook::disable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	*m_object = m_original_table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<ul>
<li><strong>æ‰§è¡Œé€Ÿåº¦:10</strong></li>
<li><strong>ç¼–å†™éš¾åº¦:3-5</strong></li>
<li><strong>æ£€æµ‹ç‡:3</strong></li>
</ul>
<p>VMT Hookæ˜¯æœ€å¥½çš„Hookæ–¹æ³•ä¹‹ä¸€ï¼Œå› ä¸ºæ²¡æœ‰APIæˆ–è€…æ£€æµ‹è¿™ç±»Hookçš„é€šç”¨æ–¹æ³•ã€‚ ä½†å¤§å¤šæ•°åä½œå¼Šå¼•æ“éƒ½ä¼šåœ¨D3Dæ¸²æŸ“å¼•æ“ä¸Šæ£€æµ‹VMT Hookã€‚å½“ç„¶ï¼Œåªè¦ä½ æœ‰ç»éªŒï¼Œä½ çš„Hookå°±ä¸ä¼šè¢«æ£€æµ‹</p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>é€†å‘</tag>
        <tag>Hook</tag>
        <tag>è™šå‡½æ•°</tag>
      </tags>
  </entry>
  <entry>
    <title>Zeekæºç åˆ†æï¼ˆ1ï¼‰</title>
    <url>/2022/10/08/zeek-soucre-code-analysis-1/</url>
    <content><![CDATA[<h1 id="zeekçš„ä¸»å¾ªç¯">Zeekçš„ä¸»å¾ªç¯</h1>
<h2 id="ioå¾ªç¯">IOå¾ªç¯</h2>
<p>æŸ¥é˜…èµ„æ–™å¾—çŸ¥ï¼Œåœ¨Zeek 3.1ä¹‹å‰ï¼ŒZeekçš„ä¸»å¾ªç¯ä½¿ç”¨è½®è¯¢å¿™ç­‰å¾…æ¥æ£€æŸ¥æ˜¯å¦æœ‰Readyçš„IOæºï¼Œæ¥å¤„ç†çš„æ•°æ®ã€äº‹ä»¶</p>
<p>åœ¨3.1ä¹‹åï¼ŒZeek è½¬è€Œä¾èµ–äºæ“ä½œç³»ç»Ÿçš„å†…ç½®çš„IOå¤šè·¯å¤ç”¨æ¥fdä¸Šçš„æ›´æ”¹ï¼Œæ‰€ä»¥å¼•å…¥äº† libkqueue</p>
<p>libkqueueæ˜¯ä¸ªè·¨å¹³å°çš„IOå¤šè·¯å¤ç”¨å®ç°ã€‚å®ƒåœ¨ macOS å’Œ FreeBSD ä¸‹ä½¿ç”¨ kqueue å®ç°ï¼Œåœ¨ Linux ç³»ç»Ÿä¸‹å®é™…ä½¿ç”¨ epoll å®ç°ï¼ˆepollä¸å¯ç”¨æ—¶ä½¿ç”¨pollå®ç°ï¼‰</p>
<p>åœ¨åˆ›å»ºæ–°çš„IOæºæ—¶ï¼Œä¼šå‘IOæºç®¡ç†å™¨æ³¨å†Œfdã€‚å½“æºæœ‰è¦å¤„ç†çš„æ•°æ®æ—¶ï¼Œæ­¤fdç”¨äºé€šçŸ¥ kqueueï¼Œå°†æ–°æ•°æ®çš„å¤„ç†æ¨å…¥ IO æºã€‚è€Œä¸æ˜¯æˆ‘ä»¬é—®æºæ˜¯å¦æœ‰äº‹æƒ…è¦åš</p>
<a id="more"></a>
<h2 id="zeekä¸»å¾ªç¯å¹²äº†å“ªäº›äº‹">Zeekä¸»å¾ªç¯å¹²äº†å“ªäº›äº‹ï¼Ÿ</h2>
<ol type="1">
<li>éå†å¤„ç†å°±ç»ªçš„ IO æºï¼ˆå¦‚æ‹¿åˆ°NICä¸­çš„åŒ…ã€è§¦å‘å®šæ—¶å™¨ç­‰ï¼‰</li>
<li>æ›´æ–°å…¨å±€çš„network_timeå¹¶è§¦å‘å®šæ—¶å™¨</li>
<li>æ´¾å‘äº‹ä»¶é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰äº‹ä»¶</li>
<li>åˆ¤æ–­æ˜¯å¦æœ‰ä¸­æ–­ã€ç»ˆç»“ä¿¡å·</li>
<li>æ›´æ–°ç»Ÿè®¡æ•°æ®</li>
</ol>
<h1 id="zeekè„šæœ¬ä¸­functioneventhookçš„åŒºåˆ«">Zeekè„šæœ¬ä¸­Functionã€Eventã€Hookçš„åŒºåˆ«</h1>
<table>
<thead>
<tr class="header">
<th></th>
<th>åŒ¿å</th>
<th>å¤šå®ç°å’Œä¼˜å…ˆçº§</th>
<th>ç«‹å³è°ƒç”¨</th>
<th>å¯è°ƒåº¦</th>
<th>é»˜è®¤å‚æ•°</th>
<th>å¼•ç”¨ç±»å‹å‚æ•°å¯å˜æ€§</th>
<th>å¤‡ç”¨å£°æ˜</th>
<th>è¿”å›å€¼</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Function</td>
<td>âˆš</td>
<td>Ã—</td>
<td>âˆš</td>
<td>Ã—</td>
<td>âˆš</td>
<td>âˆš</td>
<td>Ã—</td>
<td>âˆš</td>
</tr>
<tr class="even">
<td>Hook</td>
<td>Ã—</td>
<td>âˆš</td>
<td>âˆš</td>
<td>Ã—</td>
<td>âˆš</td>
<td>âˆš</td>
<td>âˆš</td>
<td>âˆš</td>
</tr>
<tr class="odd">
<td>Event</td>
<td>Ã—</td>
<td>âˆš</td>
<td>Ã—</td>
<td>âˆš</td>
<td>âˆš</td>
<td>âˆš</td>
<td>âˆš</td>
<td>Ã—</td>
</tr>
</tbody>
</table>
<h1 id="ä¾µå…¥å¼æŒ‡é’ˆ">ä¾µå…¥å¼æŒ‡é’ˆ</h1>
<p>ä¸€ç§æ™ºèƒ½æŒ‡é’ˆã€‚å’Œ<code>std::shared_ptr</code>è¯­ä¹‰ä¸€è‡´</p>
<p><code>std::shared_ptr</code>çš„å¼•ç”¨è®¡æ•°ä¸Objectæ— å…³ï¼Œç”±<code>std::shared_ptr</code>å­˜å‚¨</p>
<p>è€Œä¾µå…¥å¼æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°ç”±Objectå†…éƒ¨å­˜å‚¨</p>
<p>è¿™æ ·çš„è®¾è®¡å¯ä»¥é¿å…å‡ºç°ä¸¤ä¸ªControl Blockç®¡ç†ä¸€ä¸ªObjectçš„æƒ…å†µ</p>
<p>çœ‹ä¸€ä¸‹ä»¥ä¸‹é”™è¯¯ä»£ç ç‰‡æ®µï¼š <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="type">int</span> data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  A* raw_p = <span class="keyword">new</span> A;</span><br><span class="line">  <span class="function">std::shared_ptr&lt;A&gt; <span class="title">p</span><span class="params">(raw_p)</span></span>;</span><br><span class="line">  <span class="function">std::shared_ptr&lt;A&gt; <span class="title">p2</span><span class="params">(raw_p)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">250</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¾ˆæ˜æ˜¾å¯ä»¥çœ‹å‡ºç¼–å†™è€…å¯¹<code>std::shared_ptr</code>ç†è§£ä¸å¤Ÿæ·±åˆ»ã€‚è¿™æ˜¯ä¸€æ®µç­‰ç€æ­»çš„ä»£ç ã€‚å› ä¸ºpå’Œp2å„è‡ªç»´æŠ¤äº†è‡ªå·±çš„å¼•ç”¨è®¡æ•°</p>
<p>åˆ›å»ºæ—¶éƒ½åŠ 1ï¼Œé”€æ¯æ—¶éƒ½å‡1ï¼Œç»“æœæŠŠA deleteäº†ä¸¤æ¬¡</p>
<p>æ‰€ä»¥å®‰å…¨çš„ä½¿ç”¨<code>std::shared_ptr</code>å¾—å……åˆ†ç†è§£<code>make_shared</code>å’Œ<code>enable_shared_from_this</code></p>
<p>è€Œä½¿ç”¨ä¾µå…¥å¼æŒ‡é’ˆå°±ä¸éœ€è¦è€ƒè™‘è¿™äº›äº‹æƒ…</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ä¼˜äº<code>std::shared_ptr</code>çš„æ€§èƒ½ã€‚ä½¿ç”¨<code>make_shared</code>æ—¶ä¼šæœ‰ä¸¤æ¬¡newæ“ä½œï¼Œä¸€æ¬¡æ˜¯æŒ‡é’ˆæœ¬èº«ï¼Œä¸€æ¬¡æ˜¯å¼•ç”¨è®¡æ•°</li>
<li>é¿å…åŒä¸€ä¸ªObjectè¢«å¤šä¸ªå¼•ç”¨è®¡æ•°ç®¡ç†å¯¼è‡´double freeã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ‰€æœ‰ç±»éƒ½è¦ç»§æ‰¿åŸºç±»ã€‚è€¦åˆæ€§è¿‡é«˜</li>
</ul>
<blockquote>
<p>å®é™…ä¸Šå¦‚æœè§‚å¯ŸåŸºäºå¼•ç”¨è®¡æ•°æ¥GCçš„è¯­è¨€ï¼Œæ¯”å¦‚Pythonï¼Œå°±ä¼šå‘ç°åŸºç±»PyObjectå°±æ˜¯ä¾µå…¥å¼å¼•ç”¨è®¡æ•°</p>
</blockquote>
<h1 id="zeekè¿è¡Œæ—¶çš„æ•°æ®æµ">Zeekè¿è¡Œæ—¶çš„æ•°æ®æµ</h1>
<p>TFTPæ•°æ®åŒ…åˆ°è¾¾<code>Analyzer</code>çš„è¿‡ç¨‹</p>
<p>è°ƒç”¨æ ˆï¼š <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">evnet <span class="title">tftp_read_request</span><span class="params">()</span></span></span><br><span class="line"><span class="function">....  <span class="comment">// æ­¤å¤„çœç•¥äº‹ä»¶ç®¡ç†å™¨åˆ†å‘äº‹ä»¶çš„è¿‡ç¨‹...</span></span></span><br><span class="line"><span class="function"><span class="comment">/*------------- Zeekè„šæœ¬äº‹ä»¶å¼€å§‹ -------------*/</span></span></span><br><span class="line"><span class="function">analyzer::tftp::<span class="title">TFTP_Analyzer::DeliverPacket</span><span class="params">()</span> <span class="comment">// åˆ†æå‡ºTFTPçš„æ“ä½œç ã€æ–‡ä»¶åç­‰ä¿¡æ¯</span></span></span><br><span class="line"><span class="function"><span class="comment">/*------------- åº”ç”¨å±‚åè®®åˆ†æå¼€å§‹ -------------*/</span></span></span><br><span class="line"><span class="function">analyzer::pia::<span class="title">PIA::ReplayPacketBuffer</span><span class="params">()</span> <span class="comment">// å°†ä¹‹å‰æ„é€ çš„Bufferé‡Œçš„è´Ÿè½½å…¨éƒ¨è½¬ç»™åè®®åˆ†æå™¨ï¼ˆåŒ…æ‹¬åŒ¹é…ä¹‹å‰æ‰€æœ‰åŒä¼šè¯çš„è´Ÿè½½ï¼‰</span></span></span><br><span class="line"><span class="function">analyzer::pia::<span class="title">PIA_UDP::ActivateAnalyzer</span><span class="params">()</span> <span class="comment">// å®ä¾‹åŒ–TFTP_Analyzerï¼Œå¹¶æ”¾å…¥UDPSessionAdapterå­åˆ†æå™¨åˆ—è¡¨</span></span></span><br><span class="line"><span class="function">detail::<span class="title">RuleActionEnable::DoAction</span><span class="params">()</span> <span class="comment">// å¯åŠ¨dpd.sigé‡ŒæŒ‡å®šçš„åè®®åˆ†æå™¨ï¼ˆenable tftpï¼‰</span></span></span><br><span class="line"><span class="function">detail::<span class="title">RuleMatcher::ExecRuleActions</span><span class="params">()</span> <span class="comment">// æ‰§è¡ŒåŒ¹é…åˆ°çš„dpd.sigé‡Œçš„Actionå’ŒDependency Conditions</span></span></span><br><span class="line"><span class="function">detail::<span class="title">RuleMatcher::Match</span><span class="params">()</span> <span class="comment">// å°†è´Ÿè½½è¾“å…¥æ‰€æœ‰ç›¸å…³åŒ¹é…å™¨ä¸­ï¼Œæ£€æŸ¥Conditionsï¼ˆHeaderã€Contentï¼‰</span></span></span><br><span class="line"><span class="function">detail::<span class="title">RuleMatcherState::Match</span><span class="params">()</span> <span class="comment">// è°ƒç”¨rule_matcher-&gt;Match</span></span></span><br><span class="line"><span class="function">analyzer::pia::<span class="title">PIA::DoMatch</span><span class="params">()</span> <span class="comment">// æ£€æŸ¥RuleEndpointStateæ˜¯å¦åˆå§‹åŒ–ï¼Œå¦åˆ™åˆå§‹åŒ–ã€‚è½¬å‘ç»™åŸºç±»å¤„ç†</span></span></span><br><span class="line"><span class="function">analyzer::pia::<span class="title">PIA::PIA_DeliverPacket</span><span class="params">()</span> <span class="comment">// æ·»åŠ åˆ°Bufferä¸­ï¼ˆè¯¦è§ç»†èŠ‚11ï¼‰</span></span></span><br><span class="line"><span class="function">analyzer::pia::<span class="title">PIA_UDP::DeliverPacket</span><span class="params">()</span> <span class="comment">// è½¬å‘ç»™åŸºç±»PIAå¤„ç†</span></span></span><br><span class="line"><span class="function">analyzer::<span class="title">Analyzer::NextPacket</span><span class="params">()</span> <span class="comment">// å…ˆç»™SupportAnalyzerï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç„¶åå°†æ•°æ®è½¬å‘åˆ°DeliverPacket</span></span></span><br><span class="line"><span class="function">analyzer::<span class="title">Analyzer::ForwardPacket</span><span class="params">()</span> <span class="comment">// è½¬å‘ç»™å½“å‰ä¼šè¯çš„æ‰€æœ‰åè®®åˆ†æå™¨(å’Œå½“å‰ç«¯å£ç»‘å®šçš„åè®®åˆ†æå™¨ã€PIAã€ConnSize)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*------------- åŒ¹é…dpd.sigå¼€å§‹ -------------*/</span></span></span><br><span class="line"><span class="function">packet_analysis::UDP::<span class="title">UDPAnalyzer::DeliverPacket</span><span class="params">()</span> <span class="comment">// åˆ†æå‡ºæºç«¯å£ã€ç›®æ ‡ç«¯å£ã€è´Ÿè½½é•¿åº¦ç­‰</span></span></span><br><span class="line"><span class="function">packet_analysis::IP::<span class="title">IPBasedAnalyzer::AnalyzePacket</span><span class="params">()</span> <span class="comment">// åˆ›å»ºConnectionå¹¶æ”¾åˆ°session_mgré‡Œï¼Œæ„é€ UDPSessionAdapteræ ‘ï¼ˆè¯¦è§ç»†èŠ‚9ï¼‰</span></span></span><br><span class="line"><span class="function">packet_analysis::<span class="title">Analyzer::ForwardPacket</span><span class="params">()</span> <span class="comment">// è½¬å‘ç»™å¯¹åº”çš„ä¼ è¾“å±‚åŒ…åˆ†æå™¨</span></span></span><br><span class="line"><span class="function">packet_analysis::IP::<span class="title">IPAnalyzer::AnalyzePacket</span><span class="params">()</span> <span class="comment">// IPåŒ…åˆ†æå™¨ï¼Œåˆ†æå‡ºIPåœ°å€ã€ä¼ è¾“å±‚åè®®ç±»å‹ç­‰</span></span></span><br><span class="line"><span class="function">packet_analysis::<span class="title">Analyzer::ForwardPacket</span><span class="params">()</span> <span class="comment">// è½¬å‘ç»™å¯¹åº”çš„ç½‘ç»œå±‚åŒ…åˆ†æå™¨</span></span></span><br><span class="line"><span class="function">packet_analysis::Ethernet::<span class="title">EthernetAnalyzer::AnalyzePacket</span><span class="params">()</span> <span class="comment">// ä»¥å¤ªç½‘åŒ…åˆ†æå™¨ï¼Œåˆ†æå‡ºMacåœ°å€ã€ç½‘ç»œå±‚åè®®ç±»å‹ç­‰</span></span></span><br><span class="line"><span class="function">packet_analysis::<span class="title">Analyzer::ForwardPacket</span><span class="params">()</span> <span class="comment">// root_analyzeré€åˆ°å¯¹åº”çš„æ•°æ®é“¾è·¯å±‚åŒ…åˆ†æå™¨ä¸­</span></span></span><br><span class="line"><span class="function">packet_analysis::<span class="title">Manager::ProcessPacket</span><span class="params">()</span> <span class="comment">// packet_mgrå¼€å§‹å¤„ç†åŒ…</span></span></span><br><span class="line"><span class="function"><span class="comment">/*------------- åŒ…åˆ†æå¼€å§‹ -------------*/</span></span></span><br><span class="line"><span class="function">run_state::<span class="title">detail::dispatch_packet</span><span class="params">()</span> <span class="comment">// å°†åŒ…äº¤ç»™packet_mgrå¤„ç†</span></span></span><br><span class="line"><span class="function">iosource::<span class="title">PktSrc::Process</span><span class="params">()</span> <span class="comment">// å‘ç°æœ‰æ•°æ®åŒ…åˆ°æ¥å¹¶å¤„ç†</span></span></span><br><span class="line"><span class="function">run_state::<span class="title">detail::run_loop</span><span class="params">()</span> <span class="comment">// ä¸»å¾ªç¯</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure></p>
<ol type="1">
<li>IOæºå¾ªç¯ä¸­ï¼Œå‘ç°æœ‰æ•°æ®åŒ…åˆ°æ¥ã€‚æ‰§è¡Œ<code>IOSource::Process()</code>ï¼Œè°ƒç”¨æ´¾ç”Ÿç±»<code>PcapSource</code>å®ç°çš„çº¯è™šå‡½æ•°<code>ExtractNextPacket</code>å–åˆ°åŒ…ï¼Œå†è°ƒç”¨<code>dispatch_packet</code></li>
<li><code>dispatch_packet</code>ä¸­è°ƒç”¨<code>packet_mgr-&gt;ProcessPacket(pkt)</code>å¼€å§‹å¤„ç†åŒ…</li>
<li>è°ƒç”¨<code>root_analyzer-&gt;ForwardPacket</code>å°†åŒ…é€åˆ°å¯¹åº”çš„äºŒå±‚åŒ…åˆ†æå™¨çš„<code>AnalyzePacket</code>å‡½æ•°é‡Œ</li>
<li>å…ˆè¿›å…¥<code>EthernetAnalyzer</code>ç±»ï¼Œåˆ†æå‡ºæºMacåœ°å€å’Œç›®æ ‡Macåœ°å€ï¼Œä»¥åŠä¸Šå±‚åè®®æ˜¯IPï¼Œç„¶åå°†åŒ…è½¬å‘ç»™<code>IPAnalyzer</code>ç±»ã€æ•°æ®é“¾è·¯å±‚ã€‘</li>
<li><code>IPAnalyzer</code>ç±»åˆ†æå‡ºIPåè®®ç‰ˆæœ¬ã€æºIPåœ°å€ã€æ˜¯å¦åˆ†ç‰‡ã€ä¸Šå±‚åè®®ç­‰ç­‰ä¿¡æ¯ã€‚å¹¶éªŒè¯checksumç­‰ï¼Œæœ€åå°†åŒ…è½¬å‘ç»™<code>UDPAnalyzer</code>ç±»ã€ç½‘ç»œå±‚ã€‘</li>
<li><code>UDPAnalyzer</code>ç±»å…ˆç”±åŸºç±»<code>IPBasedAnalyzer</code>åˆ›å»ºConnectionï¼ˆå¹¶è§¦å‘new_connectionäº‹ä»¶ï¼‰å¹¶æ”¾åˆ°session_mgré‡Œã€æ„é€ <code>UDPSessionAdapter</code>æ ‘ï¼›ç„¶åè§£ææºç«¯å£ã€ç›®æ ‡ç«¯å£ã€è´Ÿè½½é•¿åº¦ç­‰ã€‚æœ€åå°†åŒ…è½¬å‘ç»™<code>UDPSessionAdapter</code>å¤„ç†ã€ä¼ è¾“å±‚ã€‘</li>
<li><code>UDPSessionAdapter</code>é€šè¿‡<code>PIA</code>åˆ†æå™¨çš„<code>Match</code>å‡½æ•°åŒ¹é…dpd.sigï¼ŒåŒ¹é…åˆ°åè°ƒç”¨<code>ExecRuleActions</code>å‡½æ•°æ‰§è¡Œ<code>enable tftp</code></li>
<li><code>enable tftp</code>ï¼Œä¼šå…ˆå°†<code>TFTP_Analyzer</code>æ·»åŠ åˆ°<code>UDPSessionAdapter</code>å­åˆ†æå™¨åˆ—è¡¨ä¸­ï¼Œéšåè°ƒç”¨<code>analyzer_mgr-&gt;InstantiateAnalyzer</code>å‡½æ•°å®ä¾‹åŒ–ä¸€ä¸ª<code>TFTP_Analyzer</code>å¯¹è±¡</li>
<li>å°†UDPçš„è´Ÿè½½é€šè¿‡<code>PIA</code>åˆ†æå™¨çš„<code>ReplayPacketBuffer</code>å‡½æ•°<code>DeliverPacket</code>ä¼ é€’ç»™<code>TFTP_Analyzer</code>å¯¹è±¡</li>
<li><code>TFTP_Analyzer</code>åˆ†æå‡ºTFTPçš„æ“ä½œç ã€æ–‡ä»¶åç­‰ä¿¡æ¯ã€åº”ç”¨å±‚ã€‘</li>
<li>æœ€åé€šè¿‡è‡ªå®šä¹‰å®ç°çš„äº‹ä»¶é€šçŸ¥åˆ°Zeekè„šæœ¬</li>
</ol>
<p>ä¸€äº›ç»†èŠ‚ï¼š</p>
<ol type="1">
<li><code>dispatch_packet</code>å‡½æ•°åœ¨ç¬¬ä¸€ä¸ªåŒ…åˆ°æ¥å‰ä¼šè§¦å‘<code>network_time_init</code>äº‹ä»¶</li>
<li><code>root_analyzer-&gt;ForwardPacket</code>ä¼šè§¦å‘è§¦å‘<code>raw_packet</code>äº‹ä»¶</li>
<li><code>IPAnalyzer</code>ç±»ä¼šåˆ†æIPv6çš„åŒ…æœ‰æ²¡æœ‰æ‰©å±•æ ‡å¤´ï¼Œæ¯”å¦‚æœ‰ESPçš„è¯å°±è§¦å‘esp_packetäº‹ä»¶ã€‚ä¸”è¯´æ˜è´Ÿè½½è¢«åŠ å¯†ï¼Œä¸æ‰§è¡Œåé¢çš„æ“ä½œ</li>
<li><code>TCPAnalyzer</code>ã€<code>UDPAnalyzer</code>éƒ½ç»§æ‰¿è‡ª<code>IPBasedAnalyzer</code>ï¼Œå› ä¸ºåŸºäºIPçš„æ•°æ®åŒ…ï¼Œåˆ†æå™¨çš„å¾ˆå¤šä»£ç æ˜¯ä¸€è‡´çš„</li>
<li><code>IPBasedAnalyzer</code>ä¼šæ£€æŸ¥Connectionæ˜¯å¦reusedï¼Œå¦‚æœæ˜¯ä¼šè§¦å‘connection_reusedäº‹ä»¶ï¼Œå¹¶é‡æ–°å°†Connectionæ”¾åˆ°session_mgré‡Œ</li>
<li><code>IPBasedAnalyzer</code>ä¼šè§¦å‘new_packetäº‹ä»¶</li>
<li><code>UDPAnalyzer</code>ç±»ä¼šè§¦å‘udp_requestæˆ–udp_replyäº‹ä»¶</li>
<li>æ‰€æœ‰çš„åè®®åˆ†æå™¨éƒ½æ˜¯æ ‘å½¢ç»“æ„çš„ï¼Œæ ¹èŠ‚ç‚¹éƒ½æ˜¯å…¶ä¼ è¾“å±‚åè®®çš„ä¼šè¯é€‚é…å™¨ï¼ˆ<code>UDPSessionAdapter</code>ã€<code>TCPSessionAdapter</code>ç­‰ï¼‰</li>
<li><code>UDPSessionAdapter</code>æ ‘æ„é€ æ—¶ï¼Œä¼šæ£€æŸ¥å¹¶æ·»åŠ ä¸ç«¯å£ç»‘å®šçš„åè®®åˆ†æå™¨ï¼›ä»¥åŠå¢åŠ <code>PIA</code>åˆ†æå™¨ã€<code>ConnSize</code>åˆ†æå™¨</li>
<li><code>PIA</code>åˆ†æå™¨ä¸ºTCPå’ŒUDPæä¾›é€šç”¨åŠŸèƒ½ï¼Œå¯ç”¨äºç¡®å®šä½¿ç”¨å“ªä¸ªåè®®åˆ†æå™¨å¯¹å…¶è¿›è¡Œè§£æï¼Œä¹Ÿå°±æ˜¯åŒ¹é…dpd.sigï¼›ä¹Ÿæä¾›reassemblesåŒ…çš„åŠŸèƒ½</li>
<li><code>PIA</code>åˆ†æå™¨é‡Œçš„<code>Buffer</code>ç”¨åŒå‘é“¾è¡¨å°†åŒ…è´Ÿè½½è¿èµ·æ¥ï¼Œç”¨äºä¿å­˜æ•°æ®åŒ…æœ‰æ•ˆè½½è·ï¼ˆåŒ…æ‹¬ TCP çš„åºåˆ—å·ï¼‰å’Œreassembles</li>
</ol>
<h1 id="æºç ä¸­å„ç§å…¨å±€managerçš„ç”¨é€”">æºç ä¸­å„ç§å…¨å±€Managerçš„ç”¨é€”</h1>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * é¢„åˆ†é…ä¸€äº›ç®€å•çš„Valå¯¹è±¡ï¼ˆboolã€portã€ç©ºstringç­‰ï¼‰</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨ä¾µå…¥å¼æŒ‡é’ˆåšå…±äº«æ‰€æœ‰æƒç®¡ç†ï¼Œä»¥ä¾¿èµ„æºå¤ç”¨ã€‚é¿å…æ— è°“çš„å†…å­˜åˆ†é…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ValManager* val_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç»´æŠ¤å’Œè°ƒåº¦ï¼ˆé“¾è·¯å±‚ã€ä¼ è¾“å±‚ã€ç½‘ç»œå±‚ï¼‰åŒ…åˆ†æå™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç»´æŠ¤åˆ†æå™¨åç§°ä¸æ ‡è¯†çš„æ˜ å°„ã€ä¸ºæ•°æ®åŒ…åˆ†é…åŒ…åˆ†æå™¨ã€è½¬å‚¨æ•°æ®åŒ…ç­‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">packet_analysis::Manager* packet_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç»´æŠ¤å’Œè°ƒåº¦ï¼ˆåº”ç”¨å±‚ï¼‰åè®®åˆ†æå™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç»´æŠ¤åˆ†æå™¨åç§°ä¸æ ‡è¯†çš„æ˜ å°„ã€ä¸ºæ–°è¿æ¥åˆå§‹åŒ–åˆ†æå™¨æ ‘ã€ç»™æŒ‡å®šç«¯å£æŒ‡å®šåˆ†æå™¨ç­‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">analyzer::Manager* analyzer_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ’ä»¶ç®¡ç†å™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * åŠ è½½åŠ¨æ€æ’ä»¶ã€åˆå§‹åŒ–æ’ä»¶é‡Œçš„bifã€ç®¡ç†æ’ä»¶çš„é’©å­ç­‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">plugin::Manager* plugin_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç­¾åç®¡ç†å™¨</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * æ³¨å†Œåè®®åˆ†æå™¨å†…çš„.sigæ–‡ä»¶ã€è¯†åˆ«æ–‡ä»¶çš„MIMEç±»å‹ç­‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">detail::RuleMatcher* detail::rule_matcher;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¼‚æ­¥DNSæ­£å‘/åå‘æŸ¥æ‰¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">detail::DNS_Mgr* detail::dns_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å®šæ—¶å™¨ç®¡ç†å™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å†…éƒ¨ç»´æŠ¤äº†ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ¯ä¸ªä»»åŠ¡ä¼šæ·»åŠ æ—¶é—´æˆ³ï¼Œæœ€è¿‘çš„æ—¶é—´æˆ³çš„ä»»åŠ¡ä¼šå…ˆå‡ºé˜Ÿ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">detail::TimerMgr* detail::timer_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ—¥å¿—æµç®¡ç†å™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * åˆ›å»º/ç§»é™¤/å¼€å¯/å…³é—­æ—¥å¿—æµã€è®¾ç½®ç­›é€‰å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">logging::Manager* log_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * çº¿ç¨‹ç®¡ç†å™¨ï¼Œè´Ÿè´£åè°ƒæ‰€æœ‰å­çº¿ç¨‹ï¼Œ æ¯ä¸ª BasicThread éƒ½ä¼šè¢«æ·»åŠ åˆ°ç®¡ç†å™¨ï¼Œç›´åˆ°ç»ˆæ­¢åè¢«åˆ é™¤</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * çº¿ç¨‹å¯ä»¥ç›´æ¥å‘é€Zeekäº‹ä»¶ï¼›MsgThread è¿˜å¯ä»¥å®šæ—¶è§¦å‘å¿ƒè·³</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">threading::Manager* thread_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è¾“å…¥æµç®¡ç†å™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç”¨äºå®ç°è¾“å…¥æ¡†æ¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">input::Manager* input_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ–‡ä»¶åˆ†æå™¨äº¤äº’çš„ä¸»è¦å…¥å£</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æä¾›è§£æåè®®ä¸­æ–‡ä»¶çš„å„ç§æ¥å£ï¼šæ–‡ä»¶é‡ç»„ã€MIMEæ£€æµ‹ç­‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">file_analysis::Manager* file_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç®¡ç†Zeekè„šæœ¬æ–‡ä»¶æ–‡æ¡£çš„è·Ÿè¸ªå’Œç”Ÿæˆ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">zeekygen::detail::Manager* detail::zeekygen_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * IOæºç®¡ç†å™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * åˆå§‹åŒ–æ³¨å†ŒIOæºï¼Œç„¶ååœ¨ä¸»å¾ªç¯ä¸­è½®è¯¢å¤„ç†Readyçš„IOæº</span></span><br><span class="line"><span class="comment"> * IOæºä¸ä»…é™äºpcapï¼ŒNICï¼Œä¹ŸåŒ…æ‹¬broker_mgrã€timer_mgrã€event_mgrç­‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">iosource::Manager* iosource_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç®¡ç† Zeek è¿›ç¨‹é—´é€šä¿¡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¿›ç¨‹é—´äº‹ä»¶åˆ†å‘ã€æ—¥å¿—æµåˆ†å‘ç­‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Broker::Manager* broker_mgr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * äº‹ä»¶ç®¡ç†å™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * äº‹ä»¶å…¥é˜Ÿï¼Œç”¨äºè§¦å‘Zeekäº‹ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">EventMgr event_mgrï¼›</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å½“å‰æ´»åŠ¨ä¼šè¯çš„ç®¡ç†å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">session::Manager* session_mgr;</span><br></pre></td></tr></table></figure>
<h1 id="ä»zeekæºç ä¸­çš„å›è°ƒå‡½æ•°å¼•å‘çš„å¯¹é¢å‘å¯¹è±¡çš„æ€è€ƒ">ä»Zeekæºç ä¸­çš„å›è°ƒå‡½æ•°å¼•å‘çš„å¯¹é¢å‘å¯¹è±¡çš„æ€è€ƒ</h1>
<h2 id="å›è°ƒå‡½æ•°">å›è°ƒå‡½æ•°</h2>
<p>å›è°ƒå‡½æ•°æ˜¯ç¼–ç ä¸­å¸¸ç”¨çš„ä¸€ç§æ‰‹æ®µï¼Œç”¨äºå®ç°å¼‚æ­¥æ“ä½œã€äº‹ä»¶å“åº”ç­‰</p>
<p>åœ¨C/C++ä¸­ï¼Œå®ç°å›è°ƒçš„æ–¹æ³•å¾ˆå¤šï¼Œæ¯”å¦‚æœ€å¸¸ç”¨ã€ç®€å•çš„å‡½æ•°æŒ‡é’ˆ</p>
<p>åœ¨Zeekæºç ä¸­çš„å›è°ƒå‡½æ•°ï¼ˆå¦‚Timerçš„å›è°ƒï¼‰å‡ ä¹éƒ½æ˜¯ä½¿ç”¨å¤šæ€å®ç°çš„</p>
<p>å…¶å®ä¸éš¾çœ‹å‡ºä¸ºä»€ä¹ˆä½¿ç”¨å¤šæ€å®ç°ï¼Œå› ä¸ºZeekçš„ä»£ç å‡ ä¹å…¨éƒ¨æ˜¯OOPçš„ï¼Œè€Œå‡½æ•°æŒ‡é’ˆæŒ‡å‘æˆå‘˜å‡½æ•°æ¯”è¾ƒçš„éº»çƒ¦ï¼ˆå¹¶ä¸æ˜¯ä¸èƒ½ï¼Œéœ€è¦å†™ä¸‘é™‹çš„using/typedefï¼Œè€Œä¸”è°ƒç”¨æ—¶è¿˜éœ€è¦ä¼ é€’thisæŒ‡é’ˆï¼Œç ´åäº†OOPã€‚æˆ–è€…ç›´æ¥å¹²è„†ç”¨staticæˆå‘˜å‡½æ•°ï¼‰</p>
<p>ä½¿ç”¨å¤šæ€å®ç°çš„å›è°ƒæ—¢ä¸ä¼šç ´åOOPã€ä¹Ÿæä¾›ä¸é”™çš„å›è°ƒæ€§èƒ½ï¼ˆæ¯”å‡½æ•°æŒ‡é’ˆå¤šä¸€æ¬¡å¯¹è™šè¡¨çš„å†…å­˜å¯»å€ï¼‰</p>
<p>ä½†ä¹Ÿæœ‰ä¸€å®šçš„ç¼ºç‚¹ï¼Œæ¯”å¦‚ï¼š</p>
<ol type="1">
<li>ç”±äºç»§æ‰¿æ˜¯å¼ºè€¦åˆçš„ï¼Œå¦‚æœæ–°éœ€æ±‚åˆ°æ¥éœ€è¦å†åŠ ä¸€ä¸ªå›è°ƒçš„ä¸šåŠ¡å®ç°ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€ä¸ªæ–°çš„æ´¾ç”Ÿç±»</li>
<li>ä»£ç å¯è¯»æ€§çš„ä¸‹é™</li>
</ol>
<p>å€Ÿæ­¤æˆ‘ä»¬å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„å†™æ³•</p>
<p>å…¶å®Modern C++æŒ‡å¯¼æ€æƒ³ä¸‹çš„å†™æ³•å°±æ˜¯ä½¿ç”¨<code>std::function</code> + å¼±å›è°ƒå®ç°</p>
<p>å¥½å¤„å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li><code>std::function</code>å¯ä»¥æ¥å—ä¸€ä¸ªCå‡½æ•°ã€C++æˆå‘˜å‡½æ•°ã€ä»¿å‡½æ•°æˆ–lambdaï¼Œæ›´çµæ´»</li>
<li>ä½¿ç”¨<code>std::bind</code>å¯ä»¥é¡ºä¾¿ä¿å­˜å“åº”å‡½æ•°çš„å‚æ•°ï¼Œå°†å›è°ƒå‡½æ•°å’Œå›è°ƒä¸Šä¸‹æ–‡ç»‘å®šèµ·æ¥ï¼Œå®ç°é—­åŒ…</li>
<li>å¼±å›è°ƒå¯ä»¥ä¿è¯ä¸å½±å“ï¼ˆå»¶é•¿ï¼‰å¯¹è±¡ç”Ÿå‘½å‘¨æœŸï¼Œä¸”å¯¹è±¡é”€æ¯åè§¦å‘å›è°ƒä¹Ÿä¸ä¼šå¯¼è‡´æ®µé”™è¯¯</li>
<li>è‰¯å¥½çš„ä»£ç å¯è¯»æ€§å’Œè‰¯å¥½çš„å›è°ƒæ€§èƒ½</li>
</ol>
<blockquote>
<p>å¼±å›è°ƒçš„å®ç°æ–¹æ³•ï¼šåˆ©ç”¨<code>std::weak_ptr</code>ï¼Œåœ¨å›è°ƒçš„æ—¶å€™å…ˆå°è¯•æå‡ä¸º<code>std::shared_ptr</code>ï¼Œå¦‚æœæå‡æˆåŠŸï¼Œè¯´æ˜æ¥å—å›è°ƒçš„å¯¹è±¡è¿˜åœ¨ï¼Œæ‰§è¡Œå›è°ƒï¼›å¦‚æœæå‡å¤±è´¥å°±å¿½ç•¥</p>
</blockquote>
<h1 id="å¯¹é¢å‘å¯¹è±¡çš„æ€è€ƒ">å¯¹é¢å‘å¯¹è±¡çš„æ€è€ƒ</h1>
<p>å…¶å®è¿™æ ·çš„æ€æƒ³å°±æ˜¯å‡½æ•°å¼ç¼–ç¨‹ï¼ŒæŠŠæ•°æ®å’Œè®¡ç®—æ”¾åˆ°é—­åŒ…é‡Œï¼Œè€ŒOOPæ˜¯æŠŠæ•°æ®å’Œæ“ä½œæ”¾åˆ°å¯¹è±¡é‡Œ</p>
<p>å¯ä»¥çœ‹å‡ºZeekæºç çš„ç¼–å†™è€…æ˜¯éå¸¸æ„¿æ„æ‹¥æŠ±ç°ä»£C++çš„ï¼ˆC++17æ ‡å‡†ã€<code>std::string_view</code>ç­‰çš„ä½¿ç”¨ï¼‰ã€‚ä½†ä»–ä»¬å¾ˆæ˜æ˜¾è¿˜åœ¨ä½¿ç”¨è¿‡æ—¶çš„è®¾è®¡æ€æƒ³ã€‚ä»–ä»¬å°è¯•æŠŠä¸€åˆ‡éƒ½ä½¿ç”¨OOPç¼–å†™ï¼Œä¹Ÿå°±æ˜¯â€œçº¯â€é¢å‘å¯¹è±¡</p>
<p>è®¡ç®—æœºç§‘å­¦ç•Œæœ‰å¾ˆå¤šå£°éŸ³æ‰¹åˆ¤â€œçº¯â€é¢å‘å¯¹è±¡çš„å£°éŸ³</p>
<p>ç‹å çš„ <a href="https://www.yinwang.org/blog-cn/2013/03/07/design-patterns">è§£å¯†â€œè®¾è®¡æ¨¡å¼â€</a> æ‰¹åˆ¤äº†ï¼ˆé¢å‘å¯¹è±¡ï¼‰è®¾è®¡æ¨¡å¼çš„ â€œå†å²å±€é™æ€§â€ï¼š</p>
<blockquote>
<p>ï¼ˆè®¾è®¡æ¨¡å¼ï¼‰å˜æˆäº†ä¸€ç§æ•™æ¡ï¼Œå¸¦æ¥äº†å…¬å¸é‡Œç¨‹åºçš„ä¸¥é‡å¤æ‚åŒ–ä»¥åŠæ•ˆç‡ä½ä¸‹ ... ä»€ä¹ˆéƒ½å¾—æ”¾è¿› class é‡Œ ... ä»£ç å¼¯äº†å‡ é“å¼¯ï¼Œè®©äººéš¾ä»¥ç†è§£ã€‚</p>
</blockquote>
<p>å­Ÿå²©çš„ <a href="https://blog.csdn.net/myan/article/details/5928531">function/bindçš„æ•‘èµï¼ˆä¸Šï¼‰</a> ä¹Ÿæåˆ° â€œé¢å‘ç±»ç¼–ç¨‹â€ è„±ç¦»äº† â€œå¯¹è±¡çš„æœ¬è´¨â€ï¼š</p>
<blockquote>
<p>C++ é™æ€æ¶ˆæ¯æœºåˆ¶ è¿˜å¼•èµ·äº†æ›´æ·±ä¸¥é‡çš„é—®é¢˜ â€”â€” æ‰­æ›²äº†äººä»¬å¯¹é¢å‘å¯¹è±¡çš„ç†è§£ ... â€œé¢å‘å¯¹è±¡ç¼–ç¨‹â€ å˜æˆäº† â€œé¢å‘ç±»ç¼–ç¨‹â€ï¼Œâ€œé¢å‘ç±»ç¼–ç¨‹â€ å˜æˆäº† â€œæ„é€ ç±»ç»§æ‰¿æ ‘â€ã€‚</p>
</blockquote>
<h1 id="å¦‚ä½•è¿›è¡Œä»£ç è®¾è®¡">å¦‚ä½•è¿›è¡Œä»£ç è®¾è®¡ï¼Ÿ</h1>
<p>å‡è®¾æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªâ€œå¼‚æ­¥ä¸‹è½½â€çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬çœ‹å¦‚ä½•è¿›è¡Œå®ç°</p>
<h2 id="é¢å‘è¿‡ç¨‹æœ´ç´ è®¾è®¡">é¢å‘è¿‡ç¨‹â€”â€”æœ´ç´ è®¾è®¡</h2>
<p>ä¸‹è½½å®Œæˆå<strong>æ‰“å°ç»“æœ</strong>å¯ä»¥å®ç°ä¸ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DownloadAsyncAndPrint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ... download async and construct |result| ...</span></span><br><span class="line">  <span class="built_in">Print</span>(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹è½½å®Œæˆå<strong>å†™æ•°æ®åº“</strong>å¯ä»¥å®ç°ä¸ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DownloadAsyncAndWriteToDB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ... download async and construct |result| ...</span></span><br><span class="line">  <span class="built_in">WriteToDB</span>(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°å¼‚æ­¥ä¸‹è½½è¿™éƒ¨åˆ†åŠŸèƒ½æ˜¯å…¬å…±é€»è¾‘ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡<strong>æŠ½å–å‡½æ•°</strong>(extract function)æ‰‹æ³•æ¥é‡æ„å‡ºå¼‚æ­¥ä¸‹è½½çš„æ ¸å¿ƒé€»è¾‘</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">std::future&lt;Result&gt; <span class="title">DownloadAsyncImpl</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DownloadAsyncAndPrint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Result result = <span class="keyword">co_await</span> <span class="built_in">DownloadAsyncImpl</span>();</span><br><span class="line">  <span class="built_in">Print</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DownloadAsyncAndWriteToDB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Result result = <span class="keyword">co_await</span> <span class="built_in">DownloadAsyncImpl</span>();</span><br><span class="line">  <span class="built_in">WriteToDB</span>(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­˜åœ¨çš„é—®é¢˜ï¼š - ä¸å¯èƒ½é’ˆå¯¹æ‰€æœ‰éœ€æ±‚æä¾›ä¸Šè¿°æ¥å£ï¼ˆæœ‰äººéœ€è¦æ‰“å°ç»“æœï¼Œæœ‰äººéœ€è¦å†™æ•°æ®åº“ï¼Œè¿˜æœ‰äººéœ€è¦...ï¼‰ - éœ€è¦æä¾›<strong>ä¸æ¶‰åŠå®ç°ç»†èŠ‚</strong>çš„æ¥å£ï¼ˆæ¯”å¦‚ <code>DownloadAsyncImpl</code> åŸºäº C++ 20 çš„åç¨‹ï¼Œå¯ä»¥æ”¹ç”¨å¤šçº¿ç¨‹å®ç°ï¼Œä½†è°ƒç”¨è€…å¹¶ä¸å…³å¿ƒï¼‰</p>
<p>æœ¬è´¨ä¸Šï¼Œé¢å‘è¿‡ç¨‹çš„ç»“æ„åŒ–è®¾è®¡ï¼Œå¯¼è‡´æ•°æ® result ç”Ÿäº§å’Œæ¶ˆè´¹çš„é€»è¾‘<strong>è€¦åˆ</strong>åœ¨äº†ä¸€èµ·ï¼Œä¸æ˜“äºæ‰©å±•</p>
<h2 id="é¢å‘å¯¹è±¡è§£è€¦å‘é€è€…å’Œæ¥æ”¶è€…">é¢å‘å¯¹è±¡â€”â€”è§£è€¦å‘é€è€…å’Œæ¥æ”¶è€…</h2>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å¼•å…¥<strong>æ§åˆ¶åè½¬</strong>(IoC)ï¼Œä»<strong>çº¯é¢å‘å¯¹è±¡</strong>çš„è§†è§’çœ‹ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ•°æ®ï¼šresult</li>
<li>ä¸¤ä¸ªè§’è‰²ï¼šå‘é€è€…ï¼ˆ<code>ownloadAsyncImpl</code>ï¼‰å’Œ æ¥æ”¶è€…ï¼ˆ<code>Print/WriteToDB</code>ï¼‰</li>
</ul>
<p>è€Œç›®çš„æ˜¯è§£è€¦é€è€…å’Œæ¥æ”¶è€…ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹æ³•å®ç°</p>
<h2 id="æ¨¡æ¿æ¨¡å¼">æ¨¡æ¿æ¨¡å¼</h2>
<p>é€šè¿‡<strong>ç»§æ‰¿</strong>ï¼Œåœ¨å‘é€è€…ï¼ˆè™šåŸºç±»ï¼‰ä¸Š<strong>é‡è½½</strong>æ¥æ”¶è€…ï¼ˆçº¯è™šæ–¹æ³•ï¼‰é€»è¾‘ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// interface</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Downloader</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Downloader</span>() = <span class="keyword">default</span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">DownloadAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Result result = <span class="keyword">co_await</span> <span class="built_in">DownloadAsyncImpl</span>();</span><br><span class="line">    <span class="built_in">Handle</span>(result);</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Handle</span><span class="params">(<span class="type">const</span> Result&amp; result)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// client code</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PrintDownloader</span> : <span class="keyword">public</span> Downloader &#123;</span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Handle</span><span class="params">(<span class="type">const</span> Result&amp; result)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="built_in">Print</span>(result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">auto</span> print_downloader = std::<span class="built_in">make_unique</span>&lt;PrintDownloader&gt;();</span><br><span class="line">print_downloader-&gt;<span class="built_in">DownloadAsync</span>();</span><br></pre></td></tr></table></figure>
<h2 id="ç­–ç•¥æ¨¡å¼">ç­–ç•¥æ¨¡å¼</h2>
<p>é€šè¿‡<strong>ç»„åˆ</strong>ï¼Œå‘å‘é€è€…ï¼ˆç±»/å‡½æ•°ï¼‰<strong>ä¼ é€’</strong>æ¥æ”¶è€…ï¼ˆæ´¾ç”Ÿç±»ï¼‰é€»è¾‘ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// interface</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Handler</span>() = <span class="keyword">default</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Handle</span><span class="params">(<span class="type">const</span> Result&amp; result)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DownloadAsync</span><span class="params">(std::unique_ptr&lt;Handler&gt; handler)</span> </span>&#123;</span><br><span class="line">  Result result = <span class="keyword">co_await</span> <span class="built_in">DownloadAsyncImpl</span>();</span><br><span class="line">  handler-&gt;<span class="built_in">Handle</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// client code</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WriteToDBHandler</span> : <span class="keyword">public</span> Handler &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Handle</span><span class="params">(<span class="type">const</span> Result&amp; result)</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="built_in">WriteToDB</span>(result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">DownloadAsync</span>(std::<span class="built_in">make_unique</span>&lt;WriteToDBHandler&gt;());</span><br></pre></td></tr></table></figure>
<p>åœ¨å®é™…çš„ä»£ç ç¼–å†™ä¸­ï¼Œå¦‚æœèƒ½å†™å‡ºä»¥ä¸Šä¸¤ç§è®¾è®¡çš„ä»£ç ï¼Œå…¶å®å·²ç»è¶³å¤Ÿå¥½äº†ã€‚ä½†ä¾ç„¶æœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š - æ¨¡æ¿æ¨¡å¼åœ¨è¿è¡Œæ—¶ä¸èƒ½åŠ¨æ€æ›´æ¢æ¥æ”¶è€… - ç­–ç•¥æ¨¡å¼è¦ä¸ºæ¯ç§ç±»å‹å®šä¹‰ä¸€ä¸ªæ¥æ”¶è€…çš„æ¥å£</p>
<p>åœ¨Zeekçš„æºç ä¸­ï¼Œå„ç§åˆ†æå™¨ï¼ˆ<code>Analyzer</code>ï¼‰å°±æ˜¯åŸºäºæ¨¡æ¿æ¨¡å¼è®¾è®¡çš„</p>
<p>è€Œç­–ç•¥æ¨¡å¼ä¹Ÿæœ‰åº”ç”¨ï¼Œæ¯”å¦‚<code>RuleCondition</code>ã€<code>Timer</code>ç­‰</p>
<p>æœ¬è´¨ä¸Šï¼Œé¢å‘å¯¹è±¡çš„<strong>å°è£…</strong>æŠŠ<strong>æ•°æ®</strong>å’Œ<strong>å¯¹æ•°æ®çš„æ“ä½œï¼ˆæ–¹æ³•ï¼‰</strong>æ†ç»‘åœ¨ç±»é‡Œï¼Œå¼•å…¥äº†å¤æ‚çš„<strong>ç±»å±‚æ¬¡ç»“æ„</strong>(class hierarchy)ï¼Œæœ€åæ²¦ä¸º<strong>é¢å‘ç±»ç¼–ç¨‹</strong></p>
<img data-src="/2022/10/08/zeek-soucre-code-analysis-1/class.png" class="">
<h2 id="å›è°ƒé—­åŒ…">å›è°ƒé—­åŒ…</h2>
<p>å…¶å®ï¼Œå¯ä»¥ä½¿ç”¨<strong>å›è°ƒé—­åŒ…</strong>(callback closure) å®ç°ç­‰æ•ˆçš„<strong>ä¾èµ–æ³¨å…¥</strong> (DI) åŠŸèƒ½ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// interface</span></span><br><span class="line"><span class="keyword">using</span> OnDoneCallable = std::function&lt;<span class="built_in">void</span>(<span class="type">const</span> Result&amp; result)&gt;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DownloadAsync</span><span class="params">(OnDoneCallable callback)</span> </span>&#123;</span><br><span class="line">  Result result = <span class="keyword">co_await</span> <span class="built_in">DownloadAsyncImpl</span>();</span><br><span class="line">  <span class="built_in">callback</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// client code</span></span><br><span class="line"><span class="built_in">DownloadAsync</span>(std::<span class="built_in">bind</span>(&amp;Print));</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç å»æ‰äº†classï¼ŒæŠŠ handler å¯¹è±¡æ”¹ä¸º callback é—­åŒ…ï¼ŒæŠŠ è™šå‡½æ•°è°ƒç”¨ æ”¹ä¸º å›è°ƒé—­åŒ…çš„è°ƒç”¨ï¼Œä¸å†éœ€è¦æ¥å£å’Œç»§æ‰¿</p>
<p>è„±ç¦»äº† â€œç±»â€ çš„æŸç¼šï¼Œæ˜¯ä¸æ˜¯ æ¸…æ™°å¤šäº†</p>
<h2 id="æ³›å‹ç¼–ç¨‹">æ³›å‹ç¼–ç¨‹</h2>
<p>å®é™…ä¸Šï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<strong>æ³›å‹ç¼–ç¨‹</strong>(generic programming) è¿›ä¸€æ­¥åŒ–ç®€</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// interface</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> OnDoneCallable&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DownloadAsync</span><span class="params">(OnDoneCallable callback)</span> </span>&#123;</span><br><span class="line">  Result result = <span class="keyword">co_await</span> <span class="built_in">DownloadAsyncImpl</span>();</span><br><span class="line">  <span class="built_in">callback</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// client code</span></span><br><span class="line"><span class="built_in">DownloadAsync</span>(std::<span class="built_in">bind</span>(&amp;Print));</span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>å…¶å®å„ç§ç¼–ç¨‹èŒƒå¼çš„äº‰è®ºï¼Œåœ¨è®¡ç®—æœºç§‘å­¦é¢†åŸŸä¸€ç›´å–‹å–‹ä¸ä¼‘</p>
<p>æ¯”å¦‚åœ¨C++æ ‡å‡†åº“ä¸­ï¼Œå„ç§å®¹å™¨å°±æ˜¯æ³›å‹ç¼–ç¨‹çš„æ€æƒ³</p>
<p>è€Œåœ¨Javaæ ‡å‡†åº“ä¸­ï¼Œå„ç§å®¹å™¨çš„è¿­ä»£å™¨åŸºäº<code>Iterable</code>æ¥å£ã€å¯¹è±¡çš„æ¯”è¾ƒåŸºäº<code>Comparable</code>æ¥å£</p>
<p>åœ¨æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰è°æ›´å¥½è°æ›´å</p>
<p>èƒ½å¤Ÿéšç€é¡¹ç›®å…¥ä¹¡éšä¿—ï¼Œä¸å•å•æ˜¯å†™å‡ºå‘½åé£æ ¼ã€ç¼©è¿›é£æ ¼ä¸€è‡´çš„ä»£ç ï¼Œæ›´è¦å†™å‡ºè®¾è®¡ä¸€è‡´ã€é»˜è®¤æ­£ç¡®çš„ä»£ç </p>
<p>è¿™æ˜¯ä¸€ä¸ªä¼˜ç§€ç¨‹åºå‘˜çš„åŸºæœ¬åŠŸ</p>
<p>å‡½æ•°æ¨¡æ¿<code>DownloadAsync&lt;&gt;</code>åªå…³å¿ƒ callback èƒ½å¤„ç† resultï¼Œè€Œä¸éœ€è¦å…³å¿ƒå®ƒçš„å®é™…ç±»å‹æ˜¯ä»€ä¹ˆ</p>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<ul>
<li><a href="https://zeek.org/">Zeek</a></li>
<li><a href="https://github.com/zeek/zeek/wiki/IntrusivePtr-Overview">IntrusivePtr Overview</a></li>
<li><a href="https://bot-man-jl.github.io/articles/?post=2019/Callback-vs-Interface-Explained">å†è°ˆâ€œå›è°ƒ vs æ¥å£â€è®¾è®¡</a></li>
</ul>
]]></content>
      <categories>
        <category>Zeek</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>æºç åˆ†æ</tag>
        <tag>Zeek</tag>
        <tag>IDS</tag>
        <tag>ç½‘ç»œå®‰å…¨</tag>
        <tag>é¢å‘å¯¹è±¡è®¾è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>ZeekCtlæºç åˆ†æ</title>
    <url>/2022/11/21/zeekctl-soucre-code-analysis/</url>
    <content><![CDATA[<h1 id="deployæµç¨‹">deployæµç¨‹</h1>
<h2 id="ä¸€.-check">ä¸€. check</h2>
<ol type="1">
<li>åˆ›å»º<code>&#123;prefix&#125;/spool/tmp/check-config-XXXXX</code>ç›®å½•</li>
<li>å°†installå‘½ä»¤åº”ç”Ÿæˆçš„zeekè„šæœ¬æ”¾å…¥ä¸´æ—¶ç›®å½•</li>
<li>è¿è¡Œ<code>check-config</code>è„šæœ¬,å¯åŠ¨æ‰€æœ‰nodeï¼ˆä¸æ”¶åŒ…ï¼Œè·‘å®Œzeekè„šæœ¬åæ­£å¸¸é€€å‡ºï¼‰</li>
<li>æ£€æŸ¥nodeçš„exitcodeæ˜¯å¦ä¸º0</li>
</ol>
<h2 id="äºŒ.-install">äºŒ. install</h2>
<ol type="1">
<li>åˆ é™¤ä»¥å‰å®‰è£…çš„ç­–ç•¥æ–‡ä»¶ä»¥é¿å…æ··æ·†</li>
<li>åœ¨<code>&#123;prefix&#125;/spool/installed-scripts-do-not-touch</code>ä¸‹åˆ›å»º<code>size</code>å’Œ<code>auto</code>ç›®å½•,åˆ†åˆ«å­˜æ”¾ç«™ç‚¹ç­–ç•¥å’Œé…ç½®ä¿¡æ¯</li>
<li>å®‰è£…æœ¬åœ°ç«™ç‚¹ç­–ç•¥ï¼ˆå°†<code>&#123;prefix&#125;/share/zeek/site/local.zeek</code>æ‹·è´åˆ°ç­–ç•¥æ–‡ä»¶ç›®å½•ï¼‰</li>
<li>åˆ›å»ºåŒ…å«é›†ç¾¤å¸ƒå±€çš„Zeekè„šæœ¬<code>cluster-layout.zeek</code></li>
<li>åˆ›å»ºåŒ…å«æœ¬åœ°ç½‘ç»œåˆ—è¡¨çš„Zeekè„šæœ¬<code>local-networks.zeek</code></li>
<li>åˆ›å»ºåŒ…å«zeekctlé…ç½®çš„Zeekè„šæœ¬<code>zeekctl-config.zeek</code></li>
<li>å°†loggerèŠ‚ç‚¹çš„å·¥ä½œç›®å½•è½¯è¿æ¥åˆ°<code>&#123;prefix&#125;/logs/current</code></li>
</ol>
<a id="more"></a>
<h2 id="ä¸‰.-stop">ä¸‰. stop</h2>
<ol type="1">
<li>æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ„å¤–å´©æºƒï¼Œå¦‚æœæ˜¯åˆ™ç”Ÿæˆå´©æºƒæŠ¥å‘Š</li>
<li>è°ƒç”¨<code>stop</code>è„šæœ¬å¯¹èŠ‚ç‚¹å‘é€SIGTERMä¿¡å·</li>
<li>å†æ¬¡æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸ç»ˆæ­¢ï¼ˆé»˜è®¤timeout 60ç§’ï¼‰</li>
<li>å¦‚æœè¿˜åœ¨è¿è¡Œï¼Œå°±ä½¿ç”¨SIGKILLä¿¡å·ï¼Œå¼ºè¡Œç»ˆæ­¢</li>
<li>è¿è¡Œ<code>post-terminate</code>è„šæœ¬ä¸ºèŠ‚ç‚¹è¿›è¡Œæ¸…ç†ä»»åŠ¡</li>
</ol>
<p>Zeekç»ˆæ­¢åçš„æ¸…ç†ä»»åŠ¡ï¼š 1. å°†èŠ‚ç‚¹çš„å·¥ä½œç›®å½•ç§»åŠ¨åˆ°tmpç›®å½•å¹¶åˆ›å»ºæ–°çš„å·¥ä½œç›®å½•ã€‚å¦‚æœèŠ‚ç‚¹å´©æºƒï¼Œåˆ™åˆ›å»ºå´©æºƒæŠ¥å‘Š 2. å°è¯•å½’æ¡£æ‰€æœ‰æ—¥å¿—ï¼ˆå¦‚æœå¤±è´¥ï¼Œåˆ™å‘é€ç”µå­é‚®ä»¶ï¼‰ï¼Œæœ€åï¼ˆå¦‚æœèŠ‚ç‚¹æ²¡æœ‰å´©æºƒï¼‰ï¼Œå¦‚æœæ‰€æœ‰æ—¥å¿—éƒ½æˆåŠŸå½’æ¡£ï¼Œåˆ™åˆ é™¤tmpç›®å½•</p>
<h2 id="å››.-start">å››. start</h2>
<ol type="1">
<li>å¿½ç•¥ä»åœ¨è¿è¡Œçš„èŠ‚ç‚¹</li>
<li>æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ„å¤–å´©æºƒï¼Œå¦‚æœæ˜¯åˆ™ç”Ÿæˆå´©æºƒæŠ¥å‘Š</li>
<li>åˆ›å»ºèŠ‚ç‚¹å·¥ä½œç›®å½•<code>&#123;prefix&#125;/spool/XXXX</code></li>
<li>è¿è¡Œ<code>start</code>è„šæœ¬å¯åŠ¨èŠ‚ç‚¹</li>
<li>æ£€æŸ¥è¿›ç¨‹æ˜¯å¦ç¡®å®å¯åŠ¨äº†</li>
</ol>
<p><code>start</code>è„šæœ¬ï¼š 1. æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰å·¥ä½œè¿›ç¨‹è¯»å†™æƒé™ 2. ä¸æŒ‚èµ·å¹¶åœ¨åå°è¿è¡Œ<code>run-zeek</code>è„šæœ¬å¯åŠ¨zeekï¼Œå¹¶å°†æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯åˆ†åˆ«é‡å®šå‘åˆ°<code>stdout.log</code>å’Œ<code>stderr.log</code> 3. å¾ªç¯ç­‰å¾…<code>.pid</code>æ–‡ä»¶ï¼Œè·å–Zeekçš„PIDå¹¶å›å†™ç»™zeekctl</p>
<p><code>run-zeek</code>è„šæœ¬ï¼š 1. ä½¿ç”¨<code>ulimit</code>å‘½ä»¤è§£é”å„ç§èµ„æºé™åˆ¶ï¼Œå¹¶å†™å…¥<code>stdout.log</code> 2. å°†ç¯å¢ƒå˜é‡å†™å…¥<code>.env_vars</code> 3. å°†Zeekå‘½ä»¤è¡Œå†™å…¥<code>.cmdline</code> 4. å°†å½“å‰æ—¶é—´å†™å…¥<code>.startup</code> 5. ä¸æŒ‚èµ·å¹¶åœ¨åå°å¯åŠ¨zeekï¼Œå¦‚æœæœ‰pin_cpuå°±ä½¿ç”¨<code>taskset</code>å‘½ä»¤è®¾ç½®äº²å’Œæ€§ 6. å°†Zeekçš„PIDå†™å…¥<code>.pid</code> 7. ç­‰å¾…zeekè¿›ç¨‹</p>
<h2 id="q-a">Q &amp; A</h2>
<blockquote>
<p>Q: ä¸ºå•¥checkæ£€æŸ¥ä¸åˆ°zeekç›‘å¬ç«¯å£å†²çªç­‰é—®é¢˜ï¼Ÿ</p>
<p>A: å› ä¸º<code>check-config</code>å¯åŠ¨æ—¶ä¼šè®¾ç½®ç¯å¢ƒå˜é‡<code>ZEEKCTL_CHECK_CONFIG=1</code>,zeekä¸ä¼šåœ¨ç¾¤é›†ä¸­å»ºç«‹èŠ‚ç‚¹ä¹‹é—´é€šä¿¡ï¼Œè‡ªç„¶ä¸ä¼šç›‘å¬ç«¯å£ï¼Œä¹Ÿå°±ä¸ä¼šå¼•å‘å¼‚å¸¸</p>
</blockquote>
<h1 id="netstatsæµç¨‹">netstatsæµç¨‹</h1>
<ol type="1">
<li>zeekctlè°ƒç”¨<code>_send_event_init</code>å‘é€<code>Control::net_stats_request</code>äº‹ä»¶</li>
<li>workerèŠ‚ç‚¹è§¦å‘<code>Control::net_stats_request</code>äº‹ä»¶ï¼Œè®¡ç®—å‡ºç½‘ç»œçŠ¶æ€</li>
<li>workerèŠ‚ç‚¹è§¦å‘<code>Control::net_stats_response</code>äº‹ä»¶ï¼Œå°†æ¶ˆæ¯ä¼ å›zeekctl</li>
<li>zeekctlè°ƒç”¨<code>_send_event_wait</code>å–åˆ°æ¶ˆæ¯</li>
</ol>
<p><code>_send_event_init</code>å®ç°ç»†èŠ‚ï¼š 1. åˆ›å»ºç«¯ç‚¹ 2. åˆ›å»ºæ•°æ®è®¢é˜…è€…å’ŒçŠ¶æ€è®¢é˜…è€… 3. å»ºç«‹è¿æ¥ 4. ç­‰å¾…è¿æ¥å»ºç«‹ï¼ˆé€šè¿‡çŠ¶æ€è®¢é˜…è€…æŸ¥çœ‹è¿æ¥çŠ¶æ€ï¼‰ 5. æ„å»ºEventå¹¶é€šè¿‡æ•°æ®è®¢é˜…è€…publishç»™Zeek</p>
<h1 id="å¤šä¸ªzeekctlä¹‹é—´å¦‚ä½•ç«äº‰èµ„æº">å¤šä¸ªzeekctlä¹‹é—´å¦‚ä½•ç«äº‰èµ„æºï¼Ÿ</h1>
<h2 id="æ–‡ä»¶å®ç°çš„å¤šè¿›ç¨‹é”">æ–‡ä»¶å®ç°çš„å¤šè¿›ç¨‹é”</h2>
<p>zeekctlä½¿ç”¨å‡½æ•°è£…é¥°å™¨è®©å‘½ä»¤åœ¨æ‰§è¡Œå‰ä¸Šé”ï¼Œæ‰§è¡Œåè§£é”</p>
<h2 id="ä¸Šé”æµç¨‹">ä¸Šé”æµç¨‹</h2>
<ol type="1">
<li>è·å–å½“å‰zeekctlçš„PID</li>
<li>åˆ›å»º<code>&#123;prefix&#125;/spool/lock.XXXX</code>æ–‡ä»¶ï¼Œå¹¶å†™å…¥PID</li>
<li>å°è¯•å°†<code>lock.XXXX</code>ç¡¬é“¾æ¥åˆ°<code>lock</code></li>
<li>å¯¹æ¯”é“¾æ¥å‰åinodeé“¾æ¥æ•°ï¼Œåˆ¤æ–­æ˜¯å¦é“¾æ¥æˆåŠŸ</li>
<li>å¦‚æœé“¾æ¥æˆåŠŸï¼Œè¯´æ˜å½“å‰æ²¡æœ‰å…¶ä»–zeekctlè¿›ç¨‹ä¸Šé”ï¼ŒæˆåŠŸä¸Šé”</li>
<li>å¦‚æœé“¾æ¥å¤±è´¥ï¼Œè¯´æ˜å½“å‰å·²æœ‰å…¶ä»–zeekctlè¿›ç¨‹ä¸Šé”ï¼Œä¸Šé”å¤±è´¥</li>
</ol>
<h2 id="ä¸Šé”å¤±è´¥åçš„æµç¨‹">ä¸Šé”å¤±è´¥åçš„æµç¨‹</h2>
<ul>
<li>å¦‚æœå·²ä¸Šé”çš„è¿›ç¨‹å­˜æ´»ï¼Œåˆ™ç­‰å¾…30ç§’ï¼Œæ¯éš”1ç§’å°è¯•è·å–é”</li>
<li>å¦‚æœå·²ä¸Šé”çš„è¿›ç¨‹å·²æ­»äº¡ï¼Œåˆ™ç›´æ¥åˆ é™¤é”æ–‡ä»¶</li>
</ul>
<h2 id="è§£é”æµç¨‹">è§£é”æµç¨‹</h2>
<ul>
<li>åˆ é™¤<code>lock</code>æ–‡ä»¶</li>
</ul>
<blockquote>
<p>é™¤äº†<code>config</code>ã€<code>nodes</code>ã€<code>exec</code>å‘½ä»¤å¤–ï¼Œå…¶ä»–æ‰€æœ‰å‘½ä»¤éƒ½ä¼šä¸Šé”</p>
</blockquote>
<h1 id="deployåzeeké›†ç¾¤å¦‚ä½•å»ºç«‹">deployåï¼ŒZeeké›†ç¾¤å¦‚ä½•å»ºç«‹ï¼Ÿ</h1>
<blockquote>
<p>ä»¥ä¸‹è„šæœ¬å‡ä½äº<code>base/frameworks/cluster/</code>ç›®å½•ä¸‹</p>
</blockquote>
<ol type="1">
<li>åŠ è½½<code>main.zeek</code>ï¼šå®šä¹‰å„ç§é›†ç¾¤äº‹ä»¶ï¼ˆå¦‚åœ¨å…¶ä»–èŠ‚ç‚¹æˆåŠŸè¿æ¥ä¸Šè‡ªå·±æ—¶ï¼Œä¼šå‘é€helloäº‹ä»¶ç»™å¯¹æ–¹ï¼‰ã€èŠ‚ç‚¹topicåã€recordç±»å‹å®šä¹‰</li>
<li>åŠ è½½<code>pools.zeek</code>ï¼šå®šä¹‰ç”¨äºç®¡ç†ç¾¤é›†èŠ‚ç‚¹æ± çš„æ¥å£ã€‚ä½¿ç”¨poolså¯ä»¥æ–¹ä¾¿çš„åœ¨é›†ç¾¤å†…çš„èŠ‚ç‚¹ä¹‹é—´åˆ†å‘å·¥ä½œæˆ–æ•°æ®</li>
<li>åŠ è½½zeekctlåœ¨installé˜¶æ®µåˆ›å»ºçš„åŒ…å«é›†ç¾¤å¸ƒå±€çš„Zeekè„šæœ¬<code>cluster-layout.zeek</code></li>
<li>åˆ¤æ–­è‡ªå·±æ˜¯å¦åœ¨é›†ç¾¤é‡Œï¼Œå¦‚æœåœ¨ï¼Œå°±åŠ è½½<code>setup-connections.zeek</code>è„šæœ¬ï¼Œå°†è‡ªå·±è¿æ¥åˆ°é›†ç¾¤</li>
<li>æ ¹æ®è‡ªå·±çš„èŠ‚ç‚¹ç±»å‹ï¼ŒåŠ è½½ä¸åŒçš„<code>./nodes/xxxx.zeek</code>è„šæœ¬ï¼ˆå¦‚æœé›†ç¾¤ä¸­æ²¡æœ‰loggerï¼Œé‚£ä¹ˆmanagerä¹Ÿä¼šåŠ è½½loggerçš„è„šæœ¬ï¼Œå…¼èŒloggerï¼‰</li>
<li>åŠ è½½<code>broker-stores.zeek</code>ï¼šåˆå§‹åŒ–åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨æ¥å£ï¼ˆå¯ä»¥æ•°æ®æŒä¹…åŒ–ï¼‰</li>
</ol>
<h1 id="zeeké›†ç¾¤çš„å¸ƒå±€">Zeeké›†ç¾¤çš„å¸ƒå±€</h1>
<ul>
<li><p>æ¯ä¸ªworkeréƒ½è¿æ¥åˆ°æ‰€æœ‰proxyã€‚</p></li>
<li><p>æ‰€æœ‰èŠ‚ç‚¹è¿æ¥åˆ°æ‰€æœ‰loggerå’Œmanagerã€‚</p></li>
</ul>
<img data-src="/2022/11/21/zeekctl-soucre-code-analysis/cluster-layout.png" class="">
]]></content>
      <categories>
        <category>Zeek</category>
      </categories>
      <tags>
        <tag>æºç åˆ†æ</tag>
        <tag>Zeek</tag>
        <tag>IDS</tag>
        <tag>ç½‘ç»œå®‰å…¨</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>å‘é‡åŒ–å¼‚å¸¸å¤„ç†ï¼ˆVEHï¼‰ Hook</title>
    <url>/2021/05/28/veh-hook/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>åœ¨ä¸Šä¸¤ä¸ªHookæ–‡ç« ä¸­ï¼Œæˆ‘å®ç°äº†<a href="/2020/12/07/vmt-hook/">è™šå‡½æ•°è¡¨é’©å­ï¼ˆVMT Hookï¼‰</a>å’Œ<a href="/2021/03/05/iat-hook/">å¯¼å…¥åœ°å€è¡¨ï¼ˆIATï¼‰Hook</a>ã€‚</p>
<p>VMT Hookå’ŒIAT Hookçš„æœ¬è´¨ä¸Šéƒ½ä¿®æ”¹äº†å†…å­˜ï¼ˆé‡å®šå‘äº†å‡½æ•°æŒ‡é’ˆï¼‰ï¼Œæ‰€ä»¥ä¹Ÿæ¯”è¾ƒå®¹æ˜“è¢«æ£€æµ‹</p>
<p>ä»Šå¤©ä»‹ç»ä¸€ä¸ªä¸éœ€è¦ä¿®æ”¹å†…å­˜ä¸”å‡ ä¹ä¸ä¼šè¢«æ£€æµ‹çš„Hookï¼Œä¹Ÿå°±æ˜¯å‘é‡åŒ–å¼‚å¸¸å¤„ç†ï¼ˆVEHï¼‰ Hook</p>
<h1 id="ä»€ä¹ˆæ˜¯veh">ä»€ä¹ˆæ˜¯VEH?</h1>
<p>åœ¨Windowsä¸Šæœ‰ç€è®¸å¤šçš„å¼‚å¸¸å¤„ç†æ–¹æ³•ï¼Œå¸®è¿›ç¨‹åœ¨é‡åˆ°å¼‚å¸¸æ—¶å…äºå´©æºƒã€‚æ¯”å¦‚C++åŸç”Ÿå¼‚å¸¸ã€ç»“æ„åŒ–å¼‚å¸¸å¤„ç†SEHï¼ˆ<code>__try</code>ï¼Œ<code>__finally</code>ï¼Œ<code>__except</code>å°±æ˜¯VC++å¯¹SEHçš„å°è£…ï¼‰ä»¥åŠæœ¬æ–‡ä¸­è¦ä½¿ç”¨çš„å‘é‡åŒ–å¼‚å¸¸å¤„ç†ï¼ˆVEHï¼‰</p>
<a id="more"></a>
<p>Windwosä¸­çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå½“ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œring0ä¼šä½¿ç”¨<code>KiDispatchException</code>åˆ¤æ–­æ˜¯å¦æœ‰å†…æ ¸è°ƒè¯•å™¨ã€‚å¦‚æœæ²¡æœ‰è°ƒè¯•å™¨ï¼Œring0è½¬äº¤ç»™ring3çš„<code>KiDispatchException</code>ï¼Œå¼€å§‹æ‰¾æ˜¯å¦æœ‰å¼‚å¸¸å¤„ç†ç¨‹åºï¼ˆSEHã€VEHï¼‰ã€‚å¦‚æœå·²å®‰è£…ï¼Œä¼šè°ƒç”¨å¼‚å¸¸å¤„ç†ç¨‹åºè¿›è¡Œå¤„ç†</p>
<blockquote>
<p>å¼‚å¸¸å¤„ç†æµç¨‹ï¼šå¼‚å¸¸äº§ç”Ÿ-&gt;è°ƒè¯•å™¨-&gt;VEH-&gt;SEH-&gt;TopLevelEH-&gt;è°ƒè¯•å™¨</p>
</blockquote>
<p>ç”±äºSEHæœ‰å¾ˆå¤šç¼ºç‚¹ï¼ˆåŸºäºçº¿ç¨‹ã€åŸºäºæ ˆã€å¤„ç†ä¼˜å…ˆçº§ä½ï¼‰ï¼Œè€ŒVEHå¼¥è¡¥äº†è¿™äº›ç¼ºç‚¹ï¼ˆåŸºäºè¿›ç¨‹ã€ä¸”ä¼˜å…ˆçº§é«˜äºSEHï¼‰</p>
<p>è€Œæˆ‘ä»¬å¯ä»¥ç”¨<code>AddVectoredExceptionHandler</code>å‡½æ•°æ³¨å†Œè‡ªå®šä¹‰çš„VEHã€‚å½“æ•è·åˆ°å¼‚å¸¸æ—¶ï¼Œæˆ‘ä»¬ä¼šæ‹¿åˆ°ä¸€ä¸ª<a href="https://docs.microsoft.com/zh-cn/windows/win32/api/winnt/ns-winnt-exception_pointers">_EXCEPTION_POINTERS</a>ç±»å‹çš„å‚æ•°ã€‚è€Œè¿™ä¸ªå‚æ•°çš„æˆå‘˜<code>ContextRecord</code>ä¿å­˜ç€å¼‚å¸¸è§¦å‘æ—¶CPUå„ç§å¯„å­˜å™¨çš„å€¼ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹EIP/RIPå¯„å­˜å™¨ï¼Œä»è€Œè¾¾åˆ°æŒ‡ä»¤è·³è½¬çš„ç›®çš„</p>
<h1 id="å¦‚ä½•å¼•å‘å¼‚å¸¸">å¦‚ä½•å¼•å‘å¼‚å¸¸ï¼Ÿ</h1>
<ol type="1">
<li><p><a href="https://docs.microsoft.com/zh-cn/windows/win32/memory/creating-guard-pages">PAGE_GUARD</a>ï¼šæœ‰<code>PAGE_GUARD</code>æ ‡å¿—çš„å†…å­˜é¡µé¢ï¼Œå¦‚æœç¨‹åºå°è¯•è®¿é—®ä¿æŠ¤é¡µå†…çš„åœ°å€ï¼Œåˆ™å¼•å‘STATUS_GUARD_PAGE_VIOLATIONå¼‚å¸¸ã€‚ä¸”ç³»ç»Ÿè¿˜æ¸…é™¤PAGE_GUARDæ ‡å¿—ï¼Œä»è€Œåˆ é™¤å†…å­˜é¡µçš„ä¿æŠ¤é¡µçŠ¶æ€ã€‚</p></li>
<li><p>NO_ACCESS: æœ‰<code>NO_ACCESS</code>æ ‡å¿—çš„å†…å­˜é¡µé¢ï¼Œå¦‚æœç¨‹åºå°è¯•è®¿é—®ä¿æŠ¤é¡µå†…çš„åœ°å€ï¼Œåˆ™å¼•å‘STATUS_ACCESS_VIOLATIONçš„å¼‚å¸¸ã€‚</p></li>
<li><p>INT3æ–­ç‚¹ï¼šä¹Ÿå¯ä»¥ä½¿ç”¨INT3æ–­ç‚¹å¹¶æ•è·BREAKPOINTå¼‚å¸¸ã€‚ä½†INT3æ–­ç‚¹éœ€è¦ä¿®æ”¹æŒ‡ä»¤ï¼Œä¸å¤Ÿéšè”½</p></li>
<li><p>ç¡¬ä»¶æ–­ç‚¹ï¼šæœ€éšè”½ã€‚ä½†åªä½œç”¨äºå•ä¸ªçº¿ç¨‹ï¼Œä¸”éœ€è¦çº¿ç¨‹çš„å¥æŸ„</p></li>
</ol>
<p>è¿™å››ç§éƒ½èƒ½å¯é çš„å¼•å‘å¼‚å¸¸å¹¶è¢«VEHæ•è·ï¼Œä½†ä½¿ç”¨å‰ä¸¤ç§å¼‚å¸¸çš„åŒæ—¶ä¹Ÿå¿…é¡»ä½¿ç”¨STATUS_SINGLE_STEP(å•æ­¥å¼‚å¸¸)</p>
<p>å¦‚æœä½ ç†Ÿæ‚‰æ–­ç‚¹çš„åŸç†ï¼Œé‚£ä¹ˆä¼šå¾ˆå®¹æ˜“ç†è§£ã€‚STATUS_SINGLE_STEPå®é™…ä¸Šå¹¶ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„å¼‚å¸¸ï¼Œè€Œæ˜¯ä¸€ç§æ£€æµ‹CPUçš„EFlagså¯„å­˜å™¨ä¸­çš„TFï¼ˆè·Ÿè¸ªæ ‡å¿—ä½ï¼‰çš„æœºåˆ¶ã€‚å½“TFä¸º1æ—¶ï¼ŒCPUæ¯æ¬¡ä»…æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ï¼Œç„¶åå°±å¼•å‘ä¸€ä¸ªSTATUS_SINGLE_STEPå¼‚å¸¸</p>
<img data-src="/2021/05/28/veh-hook/flags.png" class="">
<p>ä¸Šå›¾æ‰€ç¤º<code>TF</code>åœ¨Flagså¯„å­˜å™¨16ä½ä¸­çš„ç¬¬9ä¸ªbitï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†<code>ContextRecord</code>çš„<code>EFlag</code>æŒ‰ä½æˆ–ä¸ŠäºŒè¿›åˆ¶000100000000ä¹Ÿå°±æ˜¯0x100å®ç°</p>
<h1 id="ä¸ºä»€ä¹ˆéœ€è¦å•æ­¥å¼‚å¸¸">ä¸ºä»€ä¹ˆéœ€è¦å•æ­¥å¼‚å¸¸ï¼Ÿ</h1>
<p>Windowsç³»ç»Ÿåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä½¿ç”¨å†…å­˜åˆ†é¡µæœºåˆ¶ã€‚è€Œä¸€é¡µå†…å­˜æ˜¯å¯ä»¥ç‰©ç†åˆ†é…çš„æœ€å°å†…å­˜é‡ï¼Œé€šå¸¸æ˜¯4Kå¤§å°ã€‚</p>
<p>å½“æˆ‘ä»¬ç”¨<code>VirtualProtect</code>åœ¨é¡µé¢ä¸Šè®¾ç½®ä¿æŠ¤æ ‡å¿—æ—¶ï¼Œä¸èƒ½ä½œç”¨äºé¡µé¢ä¸­æŸ1ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯åªèƒ½ä½œç”¨äºæ•´ä¸ªé¡µé¢ã€‚</p>
<p>è€Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç›®æ ‡å‡½æ•°èµ·å§‹åœ°å€ä½äºé¡µé¢çš„ä¸­é—´ã€‚æ‰€ä»¥æˆ‘ä»¬è¦æƒ³åœ¨è¿™ä¸ªå‡½æ•°èµ·å§‹åœ°å€è§¦å‘å¼‚å¸¸ï¼Œå°±å¿…é¡»ä½¿ç”¨å•æ­¥å¼‚å¸¸</p>
<p>è¿™æ ·å°±å¯ä»¥ä¸€æ¬¡åœ¨é¡µä¸­ä¸€æ¡ä¸€æ¡çš„æ‰§è¡ŒæŒ‡ä»¤ï¼Œç›´åˆ°å¼‚å¸¸è§¦å‘åˆ°ç›®æ ‡å‡½æ•°èµ·å§‹åœ°å€çš„åœ°å€ä¸ºæ­¢ï¼Œç„¶åä¿®æ”¹EIP/RIPæ¥è·³è½¬åˆ°æˆ‘ä»¬çš„Hookå‡½æ•°</p>
<img data-src="/2021/05/28/veh-hook/mem-page.png" class="">
<p>å‡è®¾çº¢è‰²åœ°å€æ˜¯ç›®æ ‡å‡½æ•°çš„èµ·å§‹åœ°å€ã€‚STATUS_SINGLE_STEPå…è®¸æˆ‘ä»¬ä¸€æ­¥æ­¥çš„åˆ°è¾¾é‚£é‡Œã€‚è€Œå¦‚æœæ‰§è¡Œäº†å¦ä¸€ä¸ªå‡½æ•°ï¼Œä½†å’Œç›®æ ‡å‡½æ•°åœ¨åŒä¸€ä¸ªé¡µä¸­ï¼Œé‚£ä¹ˆSTATUS_SINGLE_STEPä¼šæ…¢æ…¢å•æ­¥ç›´åˆ°å¦ä¸€ä¸ªå‡½æ•°ç»“æŸï¼Œè·³å‡ºè¯¥é¡µï¼Œä¸”ä¸ä¼šåˆ°è¾¾çº¢è‰²åœ°å€ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…é’©é”™å‡½æ•°</p>
<h1 id="å®ç°æ­¥éª¤">å®ç°æ­¥éª¤</h1>
<ol type="1">
<li>æ³¨å†ŒVEH</li>
<li>ä½¿ç”¨<code>VirtualProtect</code>å°†PAGE_GUARDæ ‡å¿—æ·»åŠ åˆ°ç›®æ ‡å‡½æ•°çš„åœ°å€é¡µ</li>
<li>ç­‰å¾…ç›®æ ‡å‡½æ•°è¢«è°ƒç”¨ï¼Œä»è€Œå¼•å‘PAGE_GUARD_VIOLATIONå¼‚å¸¸</li>
<li>VEHæ•è·å¼‚å¸¸ï¼Œå¹¶è·³è½¬åˆ°Hookå‡½æ•°</li>
</ol>
<h1 id="å°è£…">å°è£…</h1>
<figure class="highlight cpp"><figcaption><span>å£°æ˜</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP Rip</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP Eip</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">veh_hook</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(std::is_function&lt;F&gt;::value, <span class="string">&quot;veh hook require the function&quot;</span>);</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">veh_hook</span>(F* original_func, F* hook_func);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">enable</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">disable</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">are_in_same_page</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> LONG WINAPI <span class="title">handler</span><span class="params">(EXCEPTION_POINTERS* exception_info)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> F* m_original_func;</span><br><span class="line">    <span class="type">static</span> F* m_hook_func;</span><br><span class="line">    <span class="type">static</span> <span class="type">void</span>* m_veh_handle;</span><br><span class="line">    <span class="type">static</span> DWORD m_old_protection;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line">F* veh_hook&lt;F&gt;::m_original_func = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line">F* veh_hook&lt;F&gt;::m_hook_func = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="type">void</span>* veh_hook&lt;F&gt;::m_veh_handle = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line">DWORD veh_hook&lt;F&gt;::m_old_protection = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="function">veh_hook&lt;F&gt; <span class="title">make_veh_hook</span><span class="params">(F* original_func, F* hook_func)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">veh_hook</span>&lt;F&gt;(original_func, hook_func);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><figcaption><span>å®ç°</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line">veh_hook&lt;F&gt;::<span class="built_in">veh_hook</span>(F* original_func, F* hook_func) &#123;</span><br><span class="line">    m_original_func = original_func;</span><br><span class="line">    m_hook_func = hook_func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="type">void</span> veh_hook&lt;F&gt;::<span class="built_in">enable</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!m_veh_handle) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!m_original_func || !m_hook_func)</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Failed to enable veh hook : original/hook function can&#x27;t be nullptr!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸èƒ½Hookåœ¨åŒä¸€é¡µé¢çš„ä¸¤ä¸ªå‡½æ•°ï¼Œä¼šæ— é™å›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">are_in_same_page</span>())</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Failed to enable veh hook : two functions in the same page!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ·»åŠ VEH</span></span><br><span class="line">        m_veh_handle = <span class="built_in">AddVectoredExceptionHandler</span>(<span class="literal">true</span>, handler);</span><br><span class="line">        <span class="keyword">if</span> (!m_veh_handle)</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Failed to enable veh hook : add veh failed!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»™ç›®æ ‡å‡½æ•°çš„é¡µé¢åŠ ä¸ŠPAGE_GUARDæ ‡å¿—</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">VirtualProtect</span>(m_original_func, <span class="number">1</span>, PAGE_EXECUTE_READ | PAGE_GUARD, &amp;m_old_protection))</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Failed to enable veh hook : modify memory protection failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="type">void</span> veh_hook&lt;F&gt;::<span class="built_in">disable</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (m_veh_handle) &#123;</span><br><span class="line">        DWORD _;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">VirtualProtect</span>(m_original_func, <span class="number">1</span>, m_old_protection, &amp;_)) <span class="comment">// æ¢å¤å†…å­˜ä¿æŠ¤</span></span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Failed to disable veh hook : modify memory protection failed!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">RemoveVectoredExceptionHandler</span>(m_veh_handle)) <span class="comment">// ç§»é™¤VEH</span></span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Failed to disable veh hook : remove veh failed!&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        m_veh_handle = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="type">bool</span> veh_hook&lt;F&gt;::<span class="built_in">are_in_same_page</span>() &#123;</span><br><span class="line">    MEMORY_BASIC_INFORMATION mbi1;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">VirtualQuery</span>(m_original_func, &amp;mbi1, <span class="built_in">sizeof</span>(mbi1)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    MEMORY_BASIC_INFORMATION mbi2;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">VirtualQuery</span>(m_hook_func, &amp;mbi2, <span class="built_in">sizeof</span>(mbi2)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mbi1.BaseAddress == mbi2.BaseAddress) <span class="comment">// çœ‹çœ‹é¡µèµ·å§‹åœ°å€æ˜¯å¦ç›¸åŒ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// åœ¨åŒä¸€é¡µï¼Œè¿”å›trueä½¿enableå‡½æ•°æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line">LONG WINAPI veh_hook&lt;F&gt;::<span class="built_in">handler</span>(EXCEPTION_POINTERS* exception_info) &#123;</span><br><span class="line">    <span class="comment">// æ•è·PAGE_GUARD_VIOLATIONå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (exception_info-&gt;ExceptionRecord-&gt;ExceptionCode == STATUS_GUARD_PAGE_VIOLATION) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœEIP/RIPæ˜¯ç›®æ ‡å‡½æ•°ï¼Œå°±ä¿®æ”¹EIP/RIPæ¥è·³è½¬åˆ°Hookå‡½æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (exception_info-&gt;ContextRecord-&gt;IP == <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(m_original_func)) &#123;</span><br><span class="line">            exception_info-&gt;ContextRecord-&gt;IP = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(m_hook_func);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        exception_info-&gt;ContextRecord-&gt;EFlags |= <span class="number">0x100</span>; <span class="comment">// å°†TFç½®1ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œå®Œåä¼šè§¦å‘SINGLE_STEPå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION; <span class="comment">// ç»§ç»­ä¸‹ä¸€æ¡æŒ‡ä»¤</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (exception_info-&gt;ExceptionRecord-&gt;ExceptionCode == STATUS_SINGLE_STEP) &#123;<span class="comment">// æ•è·SINGLE_STEPå¼‚å¸¸</span></span><br><span class="line">        DWORD _;</span><br><span class="line">        <span class="built_in">VirtualProtect</span>(m_original_func, <span class="number">1</span>, PAGE_EXECUTE_READ | PAGE_GUARD, &amp;_); <span class="comment">// é‡æ–°åŠ ä¸ŠPAGE_GUARDæ ‡å¿—ï¼Œå› ä¸ºæ¯æ¬¡è§¦å‘è¿‡å¼‚å¸¸åç³»ç»Ÿéƒ½ä¼šæ¸…é™¤å®ƒ</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION; <span class="comment">// ç»§ç»­ä¸‹ä¸€æ¡æŒ‡ä»¤</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH; <span class="comment">// å¦‚æœä¸æ˜¯PAGE_GUARDä¹Ÿä¸æ˜¯SINGLE_STEPï¼Œå°±æ‹’ç»å¤„ç†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é’©å­å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">void</span> WINAPI <span class="title">my_sleep</span><span class="params">(DWORD ms)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[?] Hooked Sleep Function Called!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Sleeping for: &quot;</span> &lt;&lt; ms &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;VEH Hook Example by AmazingPP\n&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> hooking = <span class="built_in">make_veh_hook</span>(Sleep, my_sleep);</span><br><span class="line">    hooking.<span class="built_in">enable</span>();</span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    hooking.<span class="built_in">disable</span>();</span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºï¼š <img data-src="/2021/05/28/veh-hook/output.png" class=""></p>
<p><strong>æ³¨æ„ï¼šç”±äºVEH Hookå¹¶æ²¡æœ‰ä¿®æ”¹ç›®æ ‡å‡½æ•°ï¼Œæ‰€ä»¥å¦‚æœæƒ³åœ¨Hookå‡½æ•°é‡Œè°ƒç”¨åŸå‡½æ•°éœ€è¦å…ˆdisable()ï¼Œå¦åˆ™ä¼šæ— é™å¾ªç¯è°ƒç”¨</strong></p>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<ul>
<li><strong>æ‰§è¡Œé€Ÿåº¦:1</strong></li>
<li><strong>ç¼–å†™éš¾åº¦:8</strong></li>
<li><strong>æ£€æµ‹ç‡:1</strong></li>
</ul>
<p>VEH Hook ä¸éœ€è¦ä¿®æ”¹å†…å­˜ï¼Œæ‰€ä»¥éå¸¸éšè”½ï¼Œè€Œä¸”å‡ ä¹æ²¡æœ‰åä½œå¼Šå¼•æ“å¯ä»¥æ£€æµ‹åˆ°å®ƒ</p>
<p>å½“ç„¶æœ‰å°éƒ¨åˆ†åä½œå¼Šå¼•æ“ç”¨<code>VirtualQuery</code>æ£€æŸ¥PAGE_GUARDæ ‡å¿—æ¥æ£€æµ‹VEH Hookï¼Œè§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå…ˆç”¨VEH HookæŠŠ<code>VirtualQuery</code>é’©ä¸Šï¼Œç­›æ‰PAGE_GUARDæ ‡å¿—å³å¯</p>
<p>ä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”æ‰§è¡Œé€Ÿåº¦éå¸¸éå¸¸æ…¢</p>
<p>å¦‚æœå¯¹Windowsçš„å¼‚å¸¸å¤„ç†æœºåˆ¶æœ‰æ›´æ·±å…¥çš„äº†è§£ï¼Œç”šè‡³å¯ä»¥é’©ä¸Šå¼‚å¸¸å¤„ç†ring0è¿”å›ring3åè°ƒç”¨çš„ç¬¬ä¸€ä¸ªç”¨æˆ·æ€å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ntdllé‡Œçš„<code>KiUserExceptionDispatcher</code>ï¼Œè¿™æ ·å°±å¯ä»¥æ¯”VEHæ›´æ—©çš„æ•è·åˆ°å¼‚å¸¸</p>
<h1 id="å¼•ç”¨">å¼•ç”¨</h1>
<p><a href="https://medium.com/@fsx30/vectored-exception-handling-hooking-via-forced-exception-f888754549c6">Vectored Exception Handling, Hooking Via Forced Exception</a></p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>é€†å‘</tag>
        <tag>Hook</tag>
        <tag>VEH</tag>
      </tags>
  </entry>
  <entry>
    <title>æ·±å…¥æµ…å‡ºC/C++å‡½æ•°è¿”å›å€¼ä¼ é€’åŸç†</title>
    <url>/2021/06/30/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAC-C-%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E4%BC%A0%E9%80%92%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒC/C++å‡½æ•°è¿”å›å€¼ä¼šä½¿ç”¨eaxå¯„å­˜å™¨æ¥ä¼ é€’ï¼Œæˆ‘ä»¬ç”¨ä»¥ä¸‹ä»£ç éªŒè¯ä¸€ä¸‹</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> n = <span class="built_in">foo</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">    auto n = foo()<span class="comment">;</span></span><br><span class="line">00F22A93  <span class="keyword">call</span>        foo (<span class="number">0F213E8h</span>)  </span><br><span class="line">00F22A98  <span class="keyword">mov</span>         <span class="built_in">dword</span> <span class="built_in">ptr</span> [n],<span class="built_in">eax</span>  // <span class="built_in">ebp</span>-<span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œmainå‡½æ•°è°ƒç”¨å®Œfooåï¼Œå°†eaxçš„å€¼ä¼ é€åˆ°nä¸­ã€‚è¯æ˜äº†eaxç¡®å®ç”¨äºè¿”å›å€¼ä¼ é€’</p>
<p>ä½†eaxæœ¬èº«åªæœ‰4å­—èŠ‚ï¼Œé‚£ä¹ˆå½“è¿”å›å€¼å¤§äº4å­—èŠ‚æ—¶æ˜¯å¦‚ä½•ä¼ é€’çš„å‘¢ï¼Ÿ</p>
<a id="more"></a>
<h1 id="å­—èŠ‚æ—¶">5~8å­—èŠ‚æ—¶</h1>
<p>ä¿®æ”¹ä¸€ä¸‹fooå‡½æ•°ï¼Œè¿”å›ä¸€ä¸ª8å­—èŠ‚çš„å€¼ï¼Œè§‚å¯Ÿä¸€ä¸‹åæ±‡ç¼–</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">    auto n = foo()<span class="comment">;</span></span><br><span class="line">00D32A93  <span class="keyword">call</span>        fo (<span class="number">0D313EDh</span>)  </span><br><span class="line">00D32A98  <span class="keyword">mov</span>         <span class="built_in">dword</span> <span class="built_in">ptr</span> [n],<span class="built_in">eax</span>  // <span class="built_in">ebp</span>-<span class="number">8</span></span><br><span class="line">00D32A9B  <span class="keyword">mov</span>         <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>],<span class="built_in">edx</span>  </span><br></pre></td></tr></table></figure>
<p>ä»æ±‡ç¼–çœ‹å‡ºï¼Œå½“è¿”å›ä¸€ä¸ª8å­—èŠ‚çš„å€¼æ—¶ï¼Œä¼šåŒæ—¶ä½¿ç”¨eaxå’Œedxä¸€èµ·è¿”å›ï¼Œå…¶ä¸­eaxç»™åˆ°ebp-8ï¼Œedxç»™åˆ°ebp-4</p>
<p>æ ¹æ®å°ç«¯æ¨¡å¼çš„ç‰¹ç‚¹ï¼ˆé«˜å­˜é«˜ï¼Œä½å­˜ä½ï¼‰ï¼Œå¯ä»¥çœ‹å‡ºï¼Œeaxå­˜å‚¨è¿”å›å€¼çš„ä½4å­—èŠ‚ï¼Œè€Œedxå­˜å‚¨è¿”å›å€¼çš„é«˜1~4å­—èŠ‚</p>
<h1 id="å¤§äº8å­—èŠ‚æ—¶">å¤§äº8å­—èŠ‚æ—¶</h1>
<p>å†ä¿®æ”¹ä¸€ä¸‹fooå‡½æ•°ï¼Œè®©å…¶è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º256å­—èŠ‚çš„ç»“æ„ä½“ <figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">bar</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">256</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">bar <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    bar tmp;</span><br><span class="line">    tmp.buf[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="mainå‡½æ•°åˆ†æ">mainå‡½æ•°åˆ†æ</h2>
<p>å¾ˆæ˜æ˜¾ï¼Œ256å­—èŠ‚çš„ç»“æ„ä½“ï¼Œå°±ç®—ç”¨ä¸Šæ‰€æœ‰é€šç”¨å¯„å­˜å™¨ä¹Ÿæ— æ³•ç›´æ¥ä¼ é€’è¿”å›å€¼</p>
<p>æˆ‘ä»¬è§‚å¯Ÿä¸€ä¸‹mainå‡½æ•°çš„åæ±‡ç¼–</p>
<figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">00771BC0  <span class="keyword">push</span>        <span class="built_in">ebp</span>  </span><br><span class="line">00771BC1  <span class="keyword">mov</span>         <span class="built_in">ebp</span>,<span class="built_in">esp</span>  </span><br><span class="line">00771BC3  <span class="keyword">sub</span>         <span class="built_in">esp</span>,<span class="number">280h</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>æœ€ä¸€å¼€å§‹ï¼Œä¿å­˜äº†ebpåï¼Œå°†espæ‹‰ä½ï¼Œåœ¨æ ˆä¸Šåˆ†é…äº†280hä¸ªå­—èŠ‚çš„ç©ºé—´</p>
<p>ç»§ç»­å¾€ä¸‹çœ‹</p>
<figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">    auto n = foo()<span class="comment">;</span></span><br><span class="line">00771BC6  <span class="keyword">lea</span>         <span class="built_in">eax</span>,[<span class="built_in">ebp</span>-<span class="number">280h</span>]  </span><br><span class="line">00771BCC  <span class="keyword">push</span>        <span class="built_in">eax</span>  </span><br><span class="line">00771BCD  <span class="keyword">call</span>        foo (<span class="number">07713C5h</span>)  </span><br><span class="line">00771BD2  <span class="keyword">add</span>         <span class="built_in">esp</span>,<span class="number">4</span>  </span><br><span class="line">00771BD5  <span class="keyword">mov</span>         <span class="built_in">ecx</span>,<span class="number">40h</span>  </span><br><span class="line">00771BDA  <span class="keyword">mov</span>         <span class="built_in">esi</span>,<span class="built_in">eax</span>  </span><br><span class="line">00771BDC  <span class="keyword">lea</span>         <span class="built_in">edi</span>,[n]  // <span class="built_in">ebp</span>-<span class="number">100h</span></span><br><span class="line">00771BE2  <span class="keyword">rep</span> movs    <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>],<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>]  </span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨callçš„å‰é¢å‡ºç°äº†ä¸¤è¡Œå¥‡æ€ªçš„ä¸œè¥¿</p>
<p>ç¬¬1è¡Œ<code>lea eax,[ebp-280h]</code>å°†ebp-280hçš„åœ°å€å­˜å‚¨åˆ°eaxä¸­ï¼Œè€Œebp-280hæ­£å¥½æŒ‡å‘åˆšæ‰åˆ†é…ç©ºé—´çš„æœ«å°¾</p>
<p>æ¥ç€<code>push eax</code>ï¼Œå°†åœ°å€å‹å…¥æ ˆï¼Œç„¶åç´§æ¥ç€è°ƒç”¨fooå‡½æ•°ã€‚ä½†fooå‡½æ•°æ²¡æœ‰ä»»ä½•å‚æ•°å‘€ï¼Œå…¶å®è¿™é‡Œç¼–è¯‘å™¨å¸®æˆ‘ä»¬éšå¼ä¼ é€’äº†ä¸€ä¸ªå‚æ•°ï¼Œå°†åˆšæ‰åˆ†é…çš„æ ˆä¸Šç©ºé—´æœ«å°¾æŒ‡é’ˆä¼ äº†è¿›å»</p>
<p>æˆªè‡³è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> buf[<span class="number">0x280</span>];</span><br><span class="line">foo(buf); <span class="comment">// ç›¸å½“äºfoo(ebp-280h);</span></span><br></pre></td></tr></table></figure>
<p>ç»§ç»­å‘ä¸‹çœ‹ï¼Œ<code>add esp,4</code>ï¼Œå°†espæŠ¬é«˜4ï¼Œä¹Ÿè¯æ˜äº†fooå‡½æ•°ç¡®å®æœ‰ä¸€ä¸ªå‚æ•°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯cedclè°ƒç”¨çº¦å®š</p>
<p>å‰©ä¸‹çš„4è¡Œè¦æ•´ä½“æ¥çœ‹ï¼Œå…ˆçœ‹æœ€åä¸€è¡Œï¼Œ<code>rep movs dword ptr es:[edi],dword ptr [esi]</code>æŒ‡çš„æ˜¯å°†esiæŒ‡å‘ä½ç½®ä¸Šçš„æ•°æ®ï¼Œä»¥DWORDçš„å¤§å°ï¼ˆ4å­—èŠ‚ï¼‰æ‹·è´åˆ°ediæŒ‡å‘çš„ä½ç½®ä¸Šï¼Œæ‹·è´ecxæ¬¡</p>
<p>ç®€å•æ¥è¯´ï¼Œæœ€åä¸€è¡Œå°±ç›¸å½“äº<code>memcpy(edi, esi, ecx * sizeof(DWORD))</code></p>
<p>è€Œrep movsä¸Šé¢çš„ä¸‰è¡Œï¼Œåˆ†åˆ«æ˜¯ç»™ecxã€esiã€edièµ‹å€¼çš„è¯­å¥ï¼Œå«ä¹‰å¦‚ä¸‹</p>
<ol type="1">
<li>ecxæ˜¯0x40ï¼Œä¹Ÿå°±æ˜¯æ‹·è´0x40 * 4 = 256ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå’Œbarçš„å¤§å°ä¸€è‡´</li>
<li>esiæ˜¯eaxï¼Œä¹Ÿå°±æ˜¯fooå‡½æ•°çš„è¿”å›å€¼</li>
<li>ediæ˜¯nçš„åœ°å€ï¼ˆebp-100hï¼‰</li>
</ol>
<p>çœ‹å®Œè¿™æ®µæ±‡ç¼–ï¼ŒåŸºæœ¬ä¸Šä¹Ÿèƒ½è¿˜åŸå‡ºmainå‡½æ•°å‰©ä¸‹çš„ä¼ªä»£ç äº†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">foo(ebp<span class="number">-280</span>h);</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;n, (<span class="type">void</span>*)eax, <span class="keyword">sizeof</span>(n));</span><br></pre></td></tr></table></figure>
<h3 id="fooå‡½æ•°åˆ†æ">fooå‡½æ•°åˆ†æ</h3>
<p>å¯è§ï¼Œfooä¾ç„¶é eaxä¼ é€’è¿”å›å€¼ï¼Œåªä¸è¿‡ä¸æ˜¯ç›´æ¥ä¼ é€’å‡½æ•°ä½“ï¼Œè€Œæ˜¯å‡½æ•°ä½“æŒ‡é’ˆã€‚fooå†…éƒ¨åˆ°åº•å¦‚ä½•å®ç°å‘¢ï¼Ÿç»§ç»­çœ‹ä¸€ä¸‹fooçš„åæ±‡ç¼–</p>
<figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">bar foo() &#123;</span><br><span class="line">...</span><br><span class="line">    bar tmp<span class="comment">;</span></span><br><span class="line">    tmp<span class="number">.</span>buf[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span><span class="comment">;</span></span><br><span class="line">00771C36  <span class="keyword">mov</span>         <span class="built_in">eax</span>,<span class="number">1</span>  </span><br><span class="line">00771C3B  <span class="keyword">imul</span>        <span class="built_in">ecx</span>,<span class="built_in">eax</span>,<span class="number">0</span>  </span><br><span class="line">00771C3E  <span class="keyword">mov</span>         <span class="built_in">byte</span> <span class="built_in">ptr</span> tmp[<span class="built_in">ecx</span>],<span class="number">0</span>  </span><br></pre></td></tr></table></figure>
<p>å‰3è¡Œï¼Œæ˜¯æ±‡ç¼–è®¿é—®æ•°ç»„çš„å…¸å‹å½¢å¼ï¼Œç›¸å½“äºå¦‚ä¸‹ä»£ç ï¼Œè¿™é‡Œä¸è¿‡å¤šèµ˜è¿° <figure class="highlight c"><table><tr><td class="code"><pre><span class="line">eax = <span class="keyword">sizeof</span>(*tmp.buf); <span class="comment">// æ¯”ä¾‹å› å­</span></span><br><span class="line">ecx = eax * <span class="number">0</span>; <span class="comment">// è®¡ç®—ä¸æ•°ç»„é¦–åœ°å€çš„åç§»é‡</span></span><br><span class="line">*((<span class="type">char</span>*)tmp + ecx) = <span class="number">0</span>; <span class="comment">// å†™å…¥0</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">    return tmp<span class="comment">;</span></span><br><span class="line">00771C46  <span class="keyword">mov</span>         <span class="built_in">ecx</span>,<span class="number">40h</span>  </span><br><span class="line">00771C4B  <span class="keyword">lea</span>         <span class="built_in">esi</span>,[tmp]  // <span class="built_in">ebp</span>-<span class="number">100h</span></span><br><span class="line">00771C51  <span class="keyword">mov</span>         <span class="built_in">edi</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]  </span><br><span class="line">00771C54  <span class="keyword">rep</span> movs    <span class="built_in">dword</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">edi</span>],<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">esi</span>]  </span><br><span class="line">00771C56  <span class="keyword">mov</span>         <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>]  </span><br></pre></td></tr></table></figure>
<p>ç»§ç»­çœ‹ï¼Œå‰4è¡Œä¾ç„¶æ˜¯éœ€è¦æ•´ä½“çœ‹ï¼Œä¾æ—§æ˜¯rep movsæŒ‡ä»¤ï¼Œæ ¹æ®åˆšæ‰çš„è§£é‡Šï¼Œè¿™å››è¡Œå¯ä»¥ç¿»è¯‘æˆ<code>memcpy([ebp+8], &amp;tmp, 256)</code></p>
<p>æ¥ç€æ˜¯ï¼Œ<code>mov eax,dword ptr [ebp+8]</code>ï¼Œå°†ebp+8ç»™åˆ°eaxï¼Œè¿”å›ç»™mainå‡½æ•°</p>
<img data-src="/2021/06/30/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAC-C-%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E4%BC%A0%E9%80%92%E5%8E%9F%E7%90%86/%E6%A0%88%E5%B8%A7.png" class="">
<p>æ ¹æ®å‡½æ•°æ ˆå¸§çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬çŸ¥é“ebpæŒ‡å‘ä¿å­˜çš„æ—§ebpï¼Œebp+4æŒ‡å‘callæŒ‡ä»¤å‹å…¥æ ˆçš„è¿”å›åœ°å€ï¼Œebp+8åˆ™æŒ‡å‘å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°</p>
<p>è€Œå‰é¢æ ¹æ®æˆ‘ä»¬åˆ†æfooå‡½æ•°ä¼šéšå¼ä¼ é€’ä¸€ä¸ªå‚æ•°æ¥ï¼Œå°±æ˜¯mainå‡½æ•°é‡Œçš„epb-280hï¼Œè¿™æ ·ä¸€æ¥ï¼Œæ€è·¯å°±æ¸…æ™°äº†</p>
<h3 id="æµç¨‹">æµç¨‹</h3>
<ol type="1">
<li>mainå‡½æ•°å…ˆåœ¨æ ˆä¸Šé¢å¤–å¼€è¾Ÿäº†ä¸€ç‰‡ç©ºé—´ï¼Œå¹¶å°†è¿™å—ç©ºé—´çš„ä¸€éƒ¨åˆ†ç”¨äºä¼ é€’è¿”å›å€¼çš„ä¸´æ—¶å¯¹è±¡</li>
<li>å°†ä¸´æ—¶å¯¹è±¡åœ°å€ä½œä¸ºå‚æ•°ä¼ é€’ç»™fooå‡½æ•°</li>
<li>fooå‡½æ•°å†…å°†æ•°æ®æ‹·è´ç»™ä¸´æ—¶å¯¹è±¡ï¼Œå¹¶å°†ä¸´æ—¶å¯¹è±¡çš„åœ°å€ç”¨eaxä¼ å‡º</li>
<li>fooå‡½æ•°è¿”å›åï¼Œmainå‡½æ•°å°†eaxæŒ‡å‘çš„ä¸´æ—¶å¯¹è±¡çš„å†…å®¹æ‹·è´ç»™n</li>
</ol>
<p>ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">void</span>* ptr)</span> </span>&#123;</span><br><span class="line">    bar tmp;</span><br><span class="line">    tmp.buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(ptr, &amp;tmp, <span class="built_in">sizeof</span>(bar));</span><br><span class="line">    eax = ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    bar tmp;</span><br><span class="line">    bar n;</span><br><span class="line">    <span class="built_in">foo</span>(&amp;tmp);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;n, eax, <span class="built_in">sizeof</span>(bar));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>åœ¨x86æ¶æ„ä¸‹ä½¿ç”¨Debugæ¨¡å¼MSVCç¼–è¯‘å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š</p>
<table>
<thead>
<tr class="header">
<th>è¿”å›å€¼ç±»å‹å¤§å°</th>
<th>ä¼ é€’æ–¹å¼</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1~4å­—èŠ‚</td>
<td>eaxï¼ˆax/alï¼‰å¯„å­˜å™¨</td>
</tr>
<tr class="even">
<td>4~8å­—èŠ‚</td>
<td>eaxå’Œedxå¯„å­˜å™¨ï¼Œ eaxå­˜å‚¨è¿”å›å€¼çš„ä½4å­—èŠ‚ï¼Œè€Œedxå­˜å‚¨è¿”å›å€¼çš„é«˜1~4å­—èŠ‚</td>
</tr>
<tr class="odd">
<td>8+å­—èŠ‚</td>
<td>ä½¿ç”¨æ ˆç©ºé—´ä¸­è½¬ï¼Œè¿›è¡Œä¸¤æ¬¡æ‹·è´</td>
</tr>
</tbody>
</table>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨æ²¡æœ‰å¼€å¯ä»»ä½•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œå¦‚æœè¿”å›å€¼ç±»å‹è¿‡å¤§ï¼ŒC/C++ä¼šä½¿ç”¨ä¸€ä¸ªä¸´æ—¶çš„æ ˆä¸Šç©ºé—´åšä¸­è½¬ï¼Œè¿›è¡Œä¸¤æ¬¡æ‹·è´ã€‚ä½†å®é™…ä¸Šç°ä»£ç¼–è¯‘å™¨åœ¨å¼€å¯ä¼˜åŒ–çš„æƒ…å†µä¸‹ä¼šä½¿ç”¨ROVå’ŒNROVæŠ€æœ¯ï¼Œä»¥å‡å°‘æ‹·è´</p>
<h1 id="å…³äºrovå’Œnrov">å…³äºROVå’ŒNROV</h1>
<p>å¾…å®Œæˆ...</p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>æ±‡ç¼–</tag>
      </tags>
  </entry>
  <entry>
    <title>ç®€å•çš„32ä½Inline HookåŠè¹¦åºŠå®ç°</title>
    <url>/2021/08/22/%E7%AE%80%E5%8D%95%E7%9A%8432%E4%BD%8DInline-Hook%E5%8F%8A%E8%B9%A6%E5%BA%8A/</url>
    <content><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>ä¹‹å‰ä»‹ç»äº†å¾ˆå¤šç±»å‹çš„Hookï¼Œä½†ä¸€ç›´éƒ½æ²¡æœ‰å†™æœ€ç®€å•ã€æœ€å¸¸ç”¨çš„Hookï¼Œä¹Ÿå°±æ˜¯Inline Hook</p>
<p>å…¶å®Inline Hookæ˜¯æœ€å®¹æ˜“è¢«æ£€æµ‹çš„Hookï¼Œä¸”åœ¨æ²¡æœ‰åšç‰¹æ®Šå¤„ç†æ—¶ä¹Ÿæ˜¯éçº¿ç¨‹å®‰å…¨çš„Hookï¼Œæœ‰æå°æ¦‚ç‡åœ¨Hookæ—¶ç ´åè¿è¡Œæ ˆï¼Œä»è€Œå¯¼è‡´ç¨‹åºå´©æºƒ</p>
<p>ä½†Inline Hookä¾ç„¶æ˜¯æœ€å¸¸ç”¨çš„Hookï¼Œå› ä¸ºå®ƒå‡ ä¹é€‚ç”¨ä»»ä½•éœ€è¦Hookçš„åœºæ™¯ï¼Œä¸å­˜åœ¨VMTã€IAT Hookéœ€è¦ç‰¹å®šåœºæ™¯çš„çª˜å¢ƒ</p>
<p>è¿™æ¬¡æœ¬æ–‡å°±32ä½ä¸‹çš„Inline Hookå’Œè¹¦åºŠåšç®€å•çš„åŸç†ä»‹ç»å’Œå®ç°</p>
<a id="more"></a>
<h1 id="é¢„å¤‡çŸ¥è¯†">é¢„å¤‡çŸ¥è¯†</h1>
<p>åœ¨å­¦ä¹ Inline Hookä¹‹å‰ï¼Œæˆ‘ä»¬å¾—å…ˆäº†è§£å‡ ä¸ªç‚¹</p>
<ol type="1">
<li>ç¨‹åºè¢«ç¼–è¯‘åä¼šå˜æˆæœºå™¨ç ã€‚è€Œåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œè¿™äº›æœºå™¨ç æ˜¯è¢«è½½å…¥å†…å­˜ä¸­çš„(åœ¨.textæ®µ)</li>
</ol>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥<strong>ä¿®æ”¹è¿è¡Œæ—¶çš„æœºå™¨ç </strong>ï¼Œè¾¾åˆ°ä¿®æ”¹ç¨‹åºæ‰§è¡Œé¡ºåºçš„ç›®çš„ï¼Œä»è€Œå®ç°Hook</p>
<ol start="2" type="1">
<li>æ— æ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼ˆJMPï¼‰</li>
</ol>
<p>é‚£æˆ‘ä»¬åªéœ€è¦å°†è¢«Hookçš„å‡½æ•°å…¥å£çš„æŒ‡ä»¤æ”¹ä¸ºæ— æ¡ä»¶è·³è½¬åˆ°æˆ‘ä»¬å‡½æ•°ä¸­å³å¯</p>
<ol start="3" type="1">
<li>çŸ­è·³è½¬å’Œé•¿è·³è½¬</li>
</ol>
<p>å…¶å®JMPæŒ‡ä»¤åˆ†ä¸ºçŸ­è·³è½¬å’Œé•¿è·³è½¬</p>
<ul>
<li><p>çŸ­è·³è½¬ï¼šæœºå™¨ç ä¸º2ä¸ªå­—èŠ‚<code>EB XX</code>ï¼ŒE8æ˜¯çŸ­JMPçš„æœºå™¨ç ï¼ŒXXæ˜¯è·³è½¬èŒƒå›´-128~127</p></li>
<li><p>é•¿è·³è½¬ï¼šæœºå™¨ç ä¸º5ä¸ªå­—èŠ‚<code>E9 XX XX XX XX</code>ï¼ŒE9æ˜¯é•¿JMPçš„æœºå™¨ç ï¼Œå‰©ä¸‹4ä¸ªå­—èŠ‚è¡¨ç¤ºè½¬ç§»åç§»é‡</p></li>
</ul>
<p>ç”±äºæˆ‘ä»¬è‡ªå·±ç¼–å†™çš„å‡½æ•°åœ¨å†…å­˜ä¸­çš„ä½ç½®å¾ˆæ˜æ˜¾ä¸å¯èƒ½è·ç¦»æºå‡½æ•°åªæœ‰255</p>
<p>æ‰€ä»¥Inline Hookè‚¯å®šæ˜¯è¦é‡‡ç”¨<strong>é•¿è·³è½¬</strong>æ¥å®ç°ï¼Œå› ä¸ºé•¿è·³è½¬çš„å¯»å€èŒƒå›´è¦†ç›–äº†æ•´ä¸ª32ä½è¿›ç¨‹çš„åœ°å€ç©ºé—´</p>
<h2 id="é•¿jmpè®¡ç®—å®ä¾‹">é•¿JMPè®¡ç®—å®ä¾‹</h2>
<figure class="highlight x86asm"><table><tr><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="number">00401000</span>  <span class="keyword">call</span>        <span class="keyword">jmp</span> <span class="number">402398</span></span><br><span class="line">......</span><br><span class="line"><span class="number">00402398</span>  <span class="keyword">mov</span>         <span class="built_in">eax</span>,<span class="built_in">eax</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>è½¬ç§»åç§»é‡çš„å…¬å¼æ˜¯ï¼šç›®çš„åœ°å€ - èµ·å§‹åœ°å€ - è·³è½¬æŒ‡ä»¤è‡ªèº«é•¿åº¦</p>
<p>ç”±äºé•¿JMPæŒ‡ä»¤è‡ªèº«é•¿åº¦ä¸º5ï¼Œæ‰€ä»¥è½¬ç§»åç§»é‡å°±æ˜¯ï¼š<code>00402398h - 00401000h - 5h = 00001393h</code></p>
<p>è€Œæ ¹æ®å°ç«¯å­˜å‚¨çš„åŸåˆ™ï¼ˆé«˜å­˜é«˜ï¼Œä½å­˜ä½ï¼‰ï¼Œæ‰€ä»¥ä¸Šè¿°ä»£ç ä¸­JMPæŒ‡ä»¤çš„æœºå™¨ç å°±æ˜¯<code>E9 93 13 00 00</code></p>
<h1 id="å®ç°">å®ç°</h1>
<p>çŸ¥é“äº†é¢„å¤‡çŸ¥è¯†ï¼Œé‚£ä¹ˆå®ç°Inline Hookå°±å¾ˆè½»æ¾äº†ï¼Œåªéœ€è¦ä»¥ä¸‹å‡ æ­¥</p>
<ol type="1">
<li>ä¿®æ”¹å†…å­˜ä¿æŠ¤</li>
<li>Nopæ‰åŸå‡½æ•°å¼€å¤´å‰5æˆ–6ä¸ªæŒ‡ä»¤ï¼ˆä¸æ˜¯å¿…è¦çš„ï¼Œä½†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¿éšœæªæ–½ï¼Œè€Œä¸”ä¹Ÿæ–¹ä¾¿è°ƒè¯•ï¼‰</li>
<li>å…ˆè®¡ç®—å‡ºJMPæŒ‡ä»¤çš„è½¬ç§»åç§»é‡ <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">uintptr_t</span> relative_offset = function_B - function_A - <span class="number">5</span>;</span><br></pre></td></tr></table></figure></li>
<li>å°†è·³è½¬æŒ‡ä»¤çš„æœºå™¨ç è¦†ç›–åˆ°æºå‡½æ•°çš„å¼€å¤´ <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–JMPæŒ‡ä»¤æ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xE9ï¼ˆé•¿JMPçš„æœºå™¨ç ï¼‰</span></span><br><span class="line"><span class="type">uint8_t</span> jmp_codes[<span class="number">5</span>] = &#123; <span class="number">0xE9</span> &#125;;</span><br><span class="line"><span class="comment">// æ‹·è´è½¬ç§»åç§»é‡åˆ°JMPæŒ‡ä»¤æ•°ç»„çš„å4ä¸ªå­—èŠ‚</span></span><br><span class="line">std::<span class="built_in">memcpy</span>(jmp_codes + <span class="number">1</span>, &amp;relative_offset, <span class="built_in">sizeof</span>(relative_offset));</span><br><span class="line"><span class="comment">// å†™å…¥è·³è½¬æŒ‡ä»¤çš„æœºå™¨ç åˆ°åŸå‡½æ•°å¼€å¤´</span></span><br><span class="line">std::<span class="built_in">memcpy</span>(src, jmp_codes, <span class="built_in">sizeof</span>(jmp_codes));</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>æ¢å¤å†…å­˜ä¿æŠ¤</li>
</ol>
<h2 id="å®Œæ•´å®ç°">å®Œæ•´å®ç°ï¼š</h2>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="type">uint8_t</span> kNopCode = <span class="number">0x90</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">uint8_t</span> kLongJmpCode = <span class="number">0xE9</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span> kStolenSize = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span> kJmpCodeSize = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">simple_x86_inline_hook</span><span class="params">(F* src, <span class="type">const</span> F* dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(std::is_function&lt;F&gt;::value, <span class="string">&quot;inline hook require a function pointer&quot;</span>);</span><br><span class="line">    <span class="comment">// ä¿®æ”¹å†…å­˜ä¿æŠ¤</span></span><br><span class="line">    DWORD cur_prot;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">VirtualProtect</span>(src, kStolenSize, PAGE_EXECUTE_READWRITE, &amp;cur_prot))</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;VirtualProtect Error&quot;</span>);</span><br><span class="line">    <span class="comment">// Nopæ‰åŸå‡½æ•°å¼€å¤´å‰6ä¸ªæŒ‡ä»¤</span></span><br><span class="line">    std::<span class="built_in">memset</span>(src, kNopCode, kStolenSize);</span><br><span class="line">    <span class="comment">// è®¡ç®—å‡ºJMPæŒ‡ä»¤çš„è½¬ç§»åç§»é‡</span></span><br><span class="line">    <span class="type">uintptr_t</span> relative_offset = </span><br><span class="line">        <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(dst) - <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(src) - kJmpCodeSize;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–JMPæŒ‡ä»¤æ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xE9ï¼ˆé•¿JMPçš„æœºå™¨ç ï¼‰</span></span><br><span class="line">    <span class="type">uint8_t</span> jmp_codes[kJmpCodeSize] = &#123; kLongJmpCode &#125;;</span><br><span class="line">    <span class="comment">// æ‹·è´è½¬ç§»åç§»é‡åˆ°JMPæŒ‡ä»¤æ•°ç»„çš„å4ä¸ªå­—èŠ‚</span></span><br><span class="line">    std::<span class="built_in">memcpy</span>(jmp_codes + <span class="number">1</span>, &amp;relative_offset, <span class="built_in">sizeof</span>(relative_offset));</span><br><span class="line">    <span class="comment">// å†™å…¥è·³è½¬æŒ‡ä»¤çš„æœºå™¨ç åˆ°åŸå‡½æ•°å¼€å¤´</span></span><br><span class="line">    std::<span class="built_in">memcpy</span>(src, jmp_codes, <span class="built_in">sizeof</span>(jmp_codes));</span><br><span class="line">    <span class="comment">// æ¢å¤å†…å­˜ä¿æŠ¤</span></span><br><span class="line">    DWORD _;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">VirtualProtect</span>(src, kJmpCodeSize, cur_prot, &amp;_))</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;VirtualProtect Error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hookå‡½æ•°Aåˆ°å‡½æ•°Bï¼Œåæ±‡ç¼–åå¦‚ä¸‹æ‰€ç¤º</p>
<img data-src="/2021/08/22/%E7%AE%80%E5%8D%95%E7%9A%8432%E4%BD%8DInline-Hook%E5%8F%8A%E8%B9%A6%E5%BA%8A/ah-basic-api-hook.png" class="">
<p>åœ¨Hookä¹‹å‰å¯ä»¥çœ‹åˆ°å‡½æ•°å¼€å¤´çš„ä¸€äº›åŸå§‹æŒ‡ä»¤(ä¿å­˜æ ˆåŸºå€ã€å¼€è¾Ÿæ ˆç©ºé—´ç­‰æ“ä½œ)ã€‚ä½†Hookä¹‹åï¼Œè¿™äº›æŒ‡ä»¤å°±è¢«æˆ‘ä»¬çš„JMPæŒ‡ä»¤è¦†ç›–äº†</p>
<p>è¿™äº›è¢«è¦†ç›–çš„æŒ‡ä»¤å°±å«<strong>è¢«ç›—å­—èŠ‚</strong></p>
<p>ä¸ºå•¥JMPæŒ‡ä»¤åªæœ‰5ä¸ªå­—èŠ‚ï¼Œä½†æˆ‘Nopäº†6ä¸ªå­—èŠ‚å‘¢ï¼Ÿ</p>
<ol type="1">
<li>æ–¹ä¾¿è°ƒè¯•ï¼Œæœ‰Nopçš„åœ°æ–¹æ„å‘³ç€åšäº†ä¿®æ”¹</li>
<li>åŸå§‹çš„å‰3ä¸ªæŒ‡ä»¤å ç”¨äº†6ä¸ªå­—èŠ‚ï¼Œå¤šå‡ºæ¥çš„1ä¸ªå­—èŠ‚å¦‚æœä¸Nopæ‰ï¼Œåæ±‡ç¼–å‡ºçš„ä»£ç ä¼šå¾ˆå¥‡æ€ª</li>
</ol>
<h1 id="è¹¦åºŠ">è¹¦åºŠ</h1>
<p>åˆšæ‰æˆ‘ä»¬å·²ç»å®ç°äº†æœ€ç®€å•çš„Inline Hookï¼Œä½†æˆ‘ä»¬Hookä¸€ä¸ªå‡½æ•°åï¼Œå¾€å¾€åªæ˜¯ä¿®æ”¹å‚æ•°æˆ–åšä¸€äº›è®°å½•ï¼Œæœ€ç»ˆè¿˜æ˜¯éœ€è¦è°ƒç”¨æºå‡½æ•°çš„</p>
<p>ä½†ä¸Šé¢çš„å®ç°å¦‚æœå°è¯•è°ƒç”¨æºå‡½æ•°ä¼šå¼•èµ·æ— é™å¾ªç¯è°ƒç”¨ï¼Œæœ€ç»ˆå¯¼è‡´æ ˆæº¢å‡º...</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªè¹¦åºŠï¼Œå¸®æˆ‘ä»¬å®ç°å¯ä»¥åœ¨é’©å­å‡½æ•°ä¸­è°ƒç”¨æºå‡½æ•°çš„åŠŸèƒ½</p>
<h2 id="å®ç°-1">å®ç°</h2>
<p>å…¶å®è¹¦åºŠçš„åŸç†å¾ˆç®€å•ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯<strong>ä¿å­˜è¢«ç›—å­—èŠ‚</strong></p>
<p>å…·ä½“å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li>å¼€è¾Ÿä¸€å—ç©ºé—´ï¼ˆå¤§å°æ˜¯6å­—èŠ‚ + 5å­—èŠ‚ï¼‰ä½œä¸ºè¹¦åºŠ</li>
<li>è®¡ç®—ä¸åŸå‡½æ•°çš„JMPæŒ‡ä»¤çš„è½¬ç§»åç§»é‡</li>
<li>å°†è¢«ç›—å­—èŠ‚å†™å…¥å‰6ä¸ªå­—èŠ‚</li>
<li>å°†JMPæœºå™¨ç å†™å…¥å5ä¸ªå­—èŠ‚ä¸­</li>
<li>æ‰§è¡ŒInline Hook</li>
<li>å°†è¹¦åºŠè¿”å›</li>
</ol>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="function">F* <span class="title">x86_inline_hook_tramp</span><span class="params">(F* src, <span class="type">const</span> F* dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(std::is_function&lt;F&gt;::value, <span class="string">&quot;inline hook require a function pointer&quot;</span>);</span><br><span class="line">    <span class="comment">// å¼€è¾Ÿä¸€å—ç©ºé—´ï¼ˆå¤§å°æ˜¯6å­—èŠ‚ + 5å­—èŠ‚ï¼‰ä½œä¸ºè¹¦åºŠ</span></span><br><span class="line">    <span class="type">uint8_t</span>* gateway = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(<span class="built_in">VirtualAlloc</span>(<span class="literal">nullptr</span>, kStolenSize + kJmpCodeSize,</span><br><span class="line">        MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE));</span><br><span class="line">    <span class="keyword">if</span> (!gateway)</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;VirtualAlloc Error&quot;</span>);</span><br><span class="line">    <span class="comment">// è®¡ç®—ä¸åŸå‡½æ•°çš„JMPæŒ‡ä»¤çš„è½¬ç§»åç§»é‡</span></span><br><span class="line">    <span class="type">uintptr_t</span> relative_offset =</span><br><span class="line">        <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(src) - <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(gateway) - kJmpCodeSize;</span><br><span class="line">    <span class="type">uint8_t</span> jmp_codes[kJmpCodeSize] = &#123; kLongJmpCode &#125;;</span><br><span class="line">    std::<span class="built_in">memcpy</span>(jmp_codes + <span class="number">1</span>, &amp;relative_offset, <span class="built_in">sizeof</span>(relative_offset));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†è¢«ç›—å­—èŠ‚å†™å…¥å‰6ä¸ªå­—èŠ‚</span></span><br><span class="line">    std::<span class="built_in">memcpy</span>(gateway, src, kStolenSize);</span><br><span class="line">    <span class="comment">// å°†JMPæœºå™¨ç å†™å…¥å5ä¸ªå­—èŠ‚ä¸­</span></span><br><span class="line">    std::<span class="built_in">memcpy</span>(gateway + kStolenSize, jmp_codes, <span class="built_in">sizeof</span>(jmp_codes));</span><br><span class="line">    <span class="comment">// æ‰§è¡ŒInline Hook</span></span><br><span class="line">    <span class="built_in">simple_x86_inline_hook</span>(src, dst);</span><br><span class="line">    <span class="comment">// å°†è¹¦åºŠè¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;F*&gt;(gateway);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hookå‡½æ•°Aåˆ°å‡½æ•°Bï¼Œå¹¶åœ¨å‡½æ•°Bä¸­è°ƒç”¨åŸå‡½æ•°ï¼Œåæ±‡ç¼–åå¦‚ä¸‹æ‰€ç¤º</p>
<img data-src="/2021/08/22/%E7%AE%80%E5%8D%95%E7%9A%8432%E4%BD%8DInline-Hook%E5%8F%8A%E8%B9%A6%E5%BA%8A/ah-trampoline.png" class="">
<blockquote>
<p>ä¸ºå•¥ç”¨<code>VirtualAlloc</code>è€Œä¸ç”¨<code>malloc</code>ï¼Ÿ å› ä¸º<code>VirtualAlloc</code>å¯ä»¥æŒ‡å®šå†…å­˜çš„ä¿æŠ¤æ ‡å¿—ï¼Œè€Œæˆ‘ä»¬éœ€è¦è¿™å—å†…å­˜æœ‰å¯æ‰§è¡Œæƒé™ã€‚<code>malloc</code>çš„è¯è¿˜éœ€è¦è°ƒç”¨ä¸€æ¬¡<code>VirtualProtect</code></p>
</blockquote>
<p>ç®€å•çš„æµ‹è¯•å®ä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºä¿å­˜åŸå‡½æ•°çš„è¹¦åºŠ</span></span><br><span class="line"><span class="keyword">decltype</span>(Sleep)* src_sleep;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é’©å­å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">void</span> WINAPI <span class="title">my_sleep</span><span class="params">(DWORD ms)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[?] Hooked Sleep Function Called!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Sleeping for: &quot;</span> &lt;&lt; ms &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// è°ƒç”¨æºå‡½æ•°</span></span><br><span class="line">    <span class="built_in">src_sleep</span>(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    src_sleep = <span class="built_in">x86_inline_hook_tramp</span>(Sleep, my_sleep);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">VirtualFree</span>(src_sleep, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<ul>
<li><strong>æ‰§è¡Œé€Ÿåº¦:10</strong></li>
<li><strong>ç¼–å†™éš¾åº¦:2</strong></li>
<li><strong>æ£€æµ‹ç‡:7</strong></li>
</ul>
<p>åƒInline Hookè¿™ç§ç›´æ¥åœ¨.textæ®µä¸­ä¿®æ”¹æŒ‡ä»¤çš„æ–¹å¼ï¼Œéå¸¸ç®€å•å’Œå¸¸ç”¨ï¼Œä¹Ÿé€‚ç”¨äºç»å¤§å¤šæ•°åœºæ™¯</p>
<p>ä½†å¾ˆå®¹æ˜“è¢«å„ç§åä½œå¼Šå¼•æ“æ£€æµ‹åˆ°ï¼Œä¸è¿‡Inline Hookçš„å˜ç§å¾ˆå¤šï¼Œä¹Ÿæœ‰å¾ˆå¤šåŠæ³•å¯ä»¥è¿›è¡Œéšè”½</p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>é€†å‘</tag>
        <tag>Hook</tag>
        <tag>æ±‡ç¼–</tag>
        <tag>è¹¦åºŠ</tag>
      </tags>
  </entry>
</search>
